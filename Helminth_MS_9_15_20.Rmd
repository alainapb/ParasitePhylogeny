---
title: "Helminth_MS_9_15_20"
author: "APB"
date: "9/15/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      dev=c('png','tiff'),
                      fig.path='figures/')

library(ape)
library(tidyverse)
library(ouch)
library(phytools)
library(geiger)
library(caper)
library(picante)
library(pmc)
library(corHMM)
library(OUwie)
library(rentrez)
```

#Load data
```{r load_in_data, include=FALSE}

nearctic_mammal_tree <- readRDS("Nearctic_mammal_tree.RDS")
nearctic_parasite_tree <- readRDS("Nearctic_parasite_tree.RDS")
nearctic_data <- readRDS("Nearctic_data.RDS")

gmpd_mammal_tree <- readRDS("GMPD_mammal_tree.RDS")
gmpd_parasite_tree <- readRDS("GMPD_parasite_tree.RDS")
gmpd_data <- readRDS("GMPD_data.RDS")
gmpd_parasite_data <- read.csv("GMPD_parasite_traits.csv")

```

```{r load_nearctic_data, include = FALSE}

#parasite abundance/occurence data
nearctic_abund_data<-read.csv("Host_Range_Nearctic_Mammals.csv")

#change to characters instead of factors
nearctic_abund_data$Parasite<-as.character(nearctic_abund_data$Var1)


```

#Accounting for research effort using the rentrez package searching Pubmed
```{r rentrez_package, include=TRUE, eval=FALSE}
#### GMPD ####
#parasite search
gmpd_para_pubs <- data.frame(term = gmpd_parasite_tree$tip.label,
                        pubs = NA,
                        cites = NA)

for (i in 1:nrow(gmpd_para_pubs)){
  print(gmpd_para_pubs$term[i])
  ## Check GMPD to see if there are alternative names for this parasite in the GMPD
  c(gmpd_data$ParasiteReportedName[gmpd_data$ParasiteCorrectedName==gmpd_para_pubs$term[i]], ## all reported names for this parasite
    gmpd_para_pubs$term[i]) %>% unique -> names
  if (length(names)==1) ## if only one name
    entrez_search(db="pubmed", term=paste0("(\"",gmpd_para_pubs$term[i],"\"[All Fields])"))$count -> gmpd_para_pubs$pubs[i]

  else ## if multiple names
    sapply(names, function(n) entrez_search(db="pubmed", term=paste0("(\"",n,"\"[All Fields])"))$count) %>% sum -> gmpd_para_pubs$pubs[i]
  ## number of unique citations for this parasites in the GMPD
  gmpd_para_pubs$cites[i] <- length(unique(gmpd_data$Citation[which(gmpd_data$ParasiteCorrectedName==gmpd_para_pubs$term[i])]))
}
## No. of pubs cannot be less than the number of citations in the GMPD
gmpd_para_pubs$pubs <- apply(gmpd_para_pubs[,2:3], 1, function(n) max(n[1], n[2]))

#host search
gmpd_host_pubs<-data.frame(term= gmpd_mammal_tree$tip.label, 
                           pubs = NA, 
                           cites = NA)

for (i in 1:nrow(gmpd_host_pubs)){
  print(gmpd_host_pubs$term[i])
  ## Check GMPD to see if there are alternative names for this host in the GMPD
  c(gmpd_data$HostReportedName[gmpd_data$HostCorrectedName==gmpd_host_pubs$term[i]], ## all reported names for this host
    gmpd_host_pubs$term[i]) %>% unique -> names
  if (length(names)==1) ## if only one name
    entrez_search(db="pubmed", term=paste0("(\"",gmpd_host_pubs$term[i],"\"[All Fields]) AND ((\"parasites\"[MeSH Terms] OR \"parasites\"[All Fields] OR \"parasite\"[All Fields]) OR (\"helminths\"[MeSH Terms] OR \"helminths\"[All Fields] OR \"helminth\"[All Fields]))"))$count -> gmpd_host_pubs$pubs[i]
  else ## if multiple names
    sapply(names, function(n) entrez_search(db="pubmed", term=paste0("(\"",n,"\"[All Fields]) AND ((\"parasites\"[MeSH Terms] OR \"parasites\"[All Fields] OR \"parasite\"[All Fields]) OR (\"helminths\"[MeSH Terms] OR \"helminths\"[All Fields] OR \"helminth\"[All Fields]))"))$count) %>% sum -> gmpd_host_pubs$pubs[i]
  
  ## number of unique citations for this parasites in the GMPD
  gmpd_host_pubs$cites[i] <- length(unique(gmpd_data$Citation[which(gmpd_data$HostCorrectedName==gmpd_host_pubs$term[i])]))
}
## No. of pubs cannot be less than the number of citations in the GMPD
gmpd_host_pubs$pubs <- apply(gmpd_host_pubs[,2:3], 1, function(n) max(n[1], n[2]))

#### Nearctic ####
## subset the gmpd_para_pubs to the parasites found in the Nearctic dataset
nearctic_para_pubs <- gmpd_para_pubs[gmpd_parasite_tree$tip.label%in%nearctic_parasite_tree$tip.label,c(1,2)]

## 
nearctic_host_pubs <- data.frame(term=nearctic_mammal_tree$tip.label,
                                 pubs=NA)
for (i in 1:nrow(nearctic_host_pubs)) {
  print(nearctic_host_pubs$term[i])
  ## if this host is in the gmpd_host_pubs dataframe, just pull in its data
  if(nearctic_host_pubs$term[i]%in%gmpd_host_pubs$term)
    nearctic_host_pubs$pubs[i] <- gmpd_host_pubs$pubs[which(gmpd_host_pubs$term==nearctic_host_pubs$term[i])]
  else { ## search for it in pubmed
    try1<-entrez_search(db="pubmed", term=paste0("(\"",nearctic_host_pubs$term[i],"\"[All Fields]) AND ((\"parasites\"[MeSH Terms] OR \"parasites\"[All Fields] OR \"parasite\"[All Fields]) OR (\"helminths\"[MeSH Terms] OR \"helminths\"[All Fields] OR \"helminth\"[All Fields]))"))
    nearctic_host_pubs$pubs[i] <- try1$count
  }
}

saveRDS(gmpd_host_pubs, "GMPD_host_pubs.RDS")
saveRDS(gmpd_para_pubs, "GMPD_para_pubs.RDS")
saveRDS(nearctic_host_pubs, "Nearctic_host_pubs.RDS")
saveRDS(nearctic_para_pubs, "Nearctic_para_pubs.RDS")


```

```{r}
gmpd_host_pubs <- readRDS("GMPD_host_pubs.RDS")
gmpd_para_pubs <- readRDS("GMPD_para_pubs.RDS")
nearctic_host_pubs <- readRDS("Nearctic_host_pubs.RDS")
nearctic_para_pubs <- readRDS("Nearctic_para_pubs.RDS")

```

#Calculate MPD for Nearctic data
```{r calculate_mpd_for_nearctic_data, include= TRUE}

#interspecific distance matrix of parasites
nearctic_dis_para<-cophenetic.phylo(nearctic_parasite_tree) 

#interspecific distance matrix of mammals 
nearctic_dis_mam<-cophenetic.phylo(nearctic_mammal_tree) 

## Create an association matrix with host across the columns and parasites across the rows
nearctic_mamlist<-as.vector(nearctic_mammal_tree$tip.label) #list of mammals in tip label order
nearctic_para_list<-as.vector(nearctic_parasite_tree$tip.label) #list of parasites

#make a dataframe with host names as columns and parasite names as rows
nearctic_df <- data.frame(matrix(ncol=length(nearctic_mamlist),nrow=length(nearctic_para_list)), row.names = nearctic_para_list)
colnames(nearctic_df)<-nearctic_mamlist

# complete dataframe with association data, 
# where 0 = not found in host and 1 = found in host
for (i in 1:nrow(nearctic_df))
  nearctic_df[i,] <- (colnames(nearctic_df) %in% unique(subset(nearctic_data, Parasite==rownames(nearctic_df)[i])$Host)) %>% as.numeric

#save matrix
write.csv(nearctic_df,file = "association_matrix_nearctic.csv", row.names = TRUE, col.names = TRUE)

## Create MPD scores for every parasite where single host parasites have a mpd = 0 (90taxa)
nearctic_para_mpd <- mpd(nearctic_df, nearctic_dis_mam)
nearctic_para_mpd[is.na(nearctic_para_mpd)] <- 0 ## one host species have an MPD of 0
names(nearctic_para_mpd)<-nearctic_para_list


## Create MPD scores for every parasite that excludes single host parasites (73 taxa)
nearctic_para_mpd_no_specialists <- mpd(nearctic_df, nearctic_dis_mam)
names(nearctic_para_mpd_no_specialists)<-nearctic_para_list
nearctic_para_mpd_no_specialists<-nearctic_para_mpd_no_specialists[!is.na(nearctic_para_mpd_no_specialists)] ## one host species MPD removed

## plot
hist(nearctic_para_mpd, nclass=100)
hist(nearctic_para_mpd_no_specialists, nclass=100)

## Create MPD scores for every host where hosts infected by only one parasite have a mpd = 0 (69 taxa)
nearctic_mam_mpd <- mpd(t(nearctic_df), nearctic_dis_para)
nearctic_mam_mpd[is.na(nearctic_mam_mpd)] <- 0 ## hosts infected by only one parasite have MPD of 0
names(nearctic_mam_mpd)<-nearctic_mamlist

## Create MPD scores for every host where hosts infected by only one parasite are removed (50 taxa)
nearctic_mam_mpd_no_specialists <- mpd(t(nearctic_df), nearctic_dis_para)
names(nearctic_mam_mpd_no_specialists)<-nearctic_mamlist
nearctic_mam_mpd_no_specialists<-nearctic_mam_mpd_no_specialists[!is.na(nearctic_mam_mpd_no_specialists)] ## hosts infected by only one parasite have MPD of 0

```

#Calculate MPD for GMPD
```{r calculate_mpd_for_GMPD_data, include =TRUE}
##calculate the mpd of parasites and hosts!
gmpd_dis_para<-cophenetic.phylo(gmpd_parasite_tree) #interspecific distance matrix of parasites
gmpd_dis_mam<-cophenetic.phylo(gmpd_mammal_tree) #intespecific distance matrix of mammals from small tree

##make the pipeline to get the absense presence of each parasite (rows) that infect a given host (column)
gmpd_mamlist<-as.vector(gmpd_mammal_tree$tip.label) #list of mammals in tip label order
gmpd_para_list<-as.vector(gmpd_parasite_tree$tip.label)
gmpd_df <- data.frame(matrix(ncol=length(gmpd_mamlist),nrow=length(gmpd_para_list)), row.names = gmpd_para_list)
colnames(gmpd_df)<-gmpd_mamlist

for (i in 1:nrow(gmpd_df))
  gmpd_df[i,] <- (colnames(gmpd_df) %in% unique(subset(gmpd_data, ParasiteCorrectedName==rownames(gmpd_df)[i])$HostCorrectedName)) %>% as.numeric

write.csv(gmpd_df,file = "gmpd_df.csv", row.names = TRUE, col.names = TRUE)

## Create MPD scores for every parasite where single host parasites have a mpd = 0 (250 taxa)
gmpd_para_mpd <- mpd(gmpd_df, gmpd_dis_mam)
gmpd_para_mpd[is.na(gmpd_para_mpd)] <- 0 ## one host parasites have an mpd of 0
names(gmpd_para_mpd)<-gmpd_para_list

## Create MPD scores for every parasite that excludes single host parasites (159 taxa)
gmpd_para_mpd_no_specialists <- mpd(gmpd_df, gmpd_dis_mam)
names(gmpd_para_mpd_no_specialists)<-gmpd_para_list
gmpd_para_mpd_no_specialists<-gmpd_para_mpd_no_specialists[!is.na(gmpd_para_mpd_no_specialists)] ## one host parasites are removed

## Create MPD scores for every host where hosts infected by only one parasite have a mpd = 0 (199 taxa)
gmpd_mam_mpd <- mpd(t(gmpd_df), gmpd_dis_para)
gmpd_mam_mpd[is.na(gmpd_mam_mpd)] <- 0 ## hosts infected by only one parasite have MPD of 0
names(gmpd_mam_mpd)<-gmpd_mamlist

## Create MPD scores for every host where hosts infected by only one parasite are removed (123 taxa)
gmpd_mam_mpd_no_specialists<- mpd(t(gmpd_df), gmpd_dis_para)
names(gmpd_mam_mpd_no_specialists)<-gmpd_mamlist
gmpd_mam_mpd_no_specialists<-gmpd_mam_mpd_no_specialists[!is.na(gmpd_mam_mpd_no_specialists)] ## hosts infected by only one parasite are removed

```


#Visualizing MPD and Number of Hosts on Phylogenies
```{r visualizing_range_on_phylogenies, include =TRUE}

#### NEARCTIC DATASET ####

#view mpd with single host species = 0 on the tree
contMap(nearctic_parasite_tree, nearctic_para_mpd, fsize= .3, lwd=1, leg.text="x", type="fan") 

#view mpd with single host species removed (no specialists) on the tree
setdiff(nearctic_parasite_tree$tip.label, names(nearctic_para_mpd_no_specialists))->bye4
no_specialists_nearctic_parasite_tree<-drop.tip(nearctic_parasite_tree, nearctic_parasite_tree$tip.label[which(nearctic_parasite_tree$tip.label%in%bye4)])
#plot(remove_nearctic_tree, cex=0.3)

contMap(no_specialists_nearctic_parasite_tree, nearctic_para_mpd_no_specialists, fsize=.3, lwd=1) 
#### GLOBAL DATASET ####

#view mpd with single host species = 0 on the tree
contMap(gmpd_parasite_tree, gmpd_para_mpd, fsize= .3,lwd=2, type="fan") 

#view mpd with single host species removed on the tree
setdiff(gmpd_parasite_tree$tip.label, names(gmpd_para_mpd_no_specialists))->bye5
no_specialists_gmpd_parasite_tree<-drop.tip(gmpd_parasite_tree, gmpd_parasite_tree$tip.label[which(gmpd_parasite_tree$tip.label%in%bye5)])
#plot(remove_global_tree, cex=0.3)

contMap(no_specialists_gmpd_parasite_tree, gmpd_para_mpd_no_specialists, fsize=.3, lwd=2, type="fan") 

#### NEARCTIC DATASET ####

## Count how many unique hosts each parasite has and put the data frame in the same order as tree tip labels
nearctic_para_nhosts <- nearctic_abund_data[match(nearctic_parasite_tree$tip.label, nearctic_abund_data$Parasite),"Freq"]
names(nearctic_para_nhosts) <- nearctic_abund_data[match(nearctic_parasite_tree$tip.label, nearctic_abund_data$Parasite),"Parasite"]
## Remove all the parasites with a single host
nearctic_para_nhosts_no_specialists <- nearctic_para_nhosts[!nearctic_para_nhosts==1]

#### GMPD DATASET ####
gmpd_para_nhosts <- sapply(names(gmpd_para_mpd), function(n) length(unique(gmpd_data$HostCorrectedName[gmpd_data$ParasiteCorrectedName==n])))
names(gmpd_para_nhosts) <- names(gmpd_para_mpd)
#remove single host species
gmpd_para_nhosts_no_specialists <- gmpd_para_nhosts[!gmpd_para_nhosts==1]

#check
contMap(gmpd_parasite_tree, gmpd_para_nhosts, fsize=.3, type = "fan")


#check
contMap(no_specialists_gmpd_parasite_tree, gmpd_para_nhosts_no_specialists, fsize=.3, type ="fan")

```


```{r sampling_bias_correction}
## Run four models:
## 1. gls using citations to predict range (either MPD or number of hosts);
## 2. gls using the tree to predict range;
## 3. gls using citations and the tree to predict range
## 4. gls using no predictors (a null model that is equivalent to white noise)
## From these four models, we do three comparisons:
## 1. Compare the null model to the tree-only model
## 2. Compare the tree+pubs model to the tree-only model
## 3. Compare the tree+pubs model to the pubs-only model
## The first comparison tell us whether there is any phylogenetic signal. The second comparison tells us whether there is any sampling bias. The third comparison tells us whether there is any phylogenetic signal after accounting for the sampling bias. 

## GMPD ##
gmpd_para_pubs$mpd <- unname(gmpd_para_mpd)
gmpd_para_pubs$nhosts <- unname(gmpd_para_nhosts)

## Analysis of range as mean pairwise distance
## All parasites
gls_null_mpd_gmpd <- gls(mpd~1, data=gmpd_para_pubs)
gls_pubs_mpd_gmpd <- gls(mpd~pubs, data=gmpd_para_pubs)
gls_tree_mpd_gmpd <- gls(mpd~1, data=gmpd_para_pubs, correlation=corPagel(0.5, gmpd_parasite_tree))
gls_pubs_tree_mpd_gmpd <- gls(mpd~pubs, data=gmpd_para_pubs, correlation=corPagel(0.5, gmpd_parasite_tree))
## Strong evidence there is phylogenetic signal, as the tree-only model drastically outperforms the null model
anova(gls_tree_mpd_gmpd, gls_null_mpd_gmpd)
## But also evidence for sampling bias
anova(gls_tree_mpd_gmpd, gls_pubs_tree_mpd_gmpd)
## Strong evidence phylogenetic signal persists after accounting for the sampling bias
anova(gls_pubs_mpd_gmpd, gls_pubs_tree_mpd_gmpd)


## Repeat analysis, but without specialists
gls_null_mpd_gmpd_no_spec <- gls(mpd~1, data=subset(gmpd_para_pubs, mpd>0))
gls_pubs_mpd_gmpd_no_spec <- gls(mpd~pubs, data=subset(gmpd_para_pubs, mpd>0))
gls_tree_mpd_gmpd_no_spec <- gls(mpd~1, data=subset(gmpd_para_pubs, mpd>0), correlation=corPagel(0.5, no_specialists_gmpd_parasite_tree))
gls_pubs_tree_mpd_gmpd_no_spec <- gls(mpd~pubs, data=subset(gmpd_para_pubs, mpd>0), correlation=corPagel(0.5, no_specialists_gmpd_parasite_tree))
## Strong evidence there is phylogenetic signal, as the tree-only model drastically outperforms the null model
anova(gls_tree_mpd_gmpd_no_spec, gls_null_mpd_gmpd_no_spec)
## No real evidence for sampling bias
anova(gls_tree_mpd_gmpd_no_spec, gls_pubs_tree_mpd_gmpd_no_spec)
## Strong evidence phylogenetic signal persists after accounting for the sampling bias
anova(gls_pubs_mpd_gmpd_no_spec, gls_pubs_tree_mpd_gmpd_no_spec)

## Analysis of range as number of hosts
## All parasites
gls_null_nhosts_gmpd <- gls(nhosts~1, data=gmpd_para_pubs)
gls_pubs_nhosts_gmpd <- gls(nhosts~pubs, data=gmpd_para_pubs)
gls_tree_nhosts_gmpd <- gls(nhosts~1, data=gmpd_para_pubs, correlation=corPagel(0.5, gmpd_parasite_tree))
gls_pubs_tree_nhosts_gmpd <- gls(nhosts~pubs, data=gmpd_para_pubs, correlation=corPagel(0.5, gmpd_parasite_tree))
## Evidence for phylogenetic signal, as the tree-only model outperforms the null model (p = 0.0136)
anova(gls_null_nhosts_gmpd, gls_tree_nhosts_gmpd)
## But also evidence for sampling bias
anova(gls_tree_nhosts_gmpd, gls_pubs_tree_nhosts_gmpd)
## Evidence that tree + pubs is much better than tree only (p = 0.0342)
anova(gls_pubs_nhosts_gmpd, gls_pubs_tree_nhosts_gmpd)

## Repeat analysis, but without specialists
gls_null_nhosts_gmpd_no_spec <- gls(nhosts~1, data=subset(gmpd_para_pubs, mpd>0))
gls_pubs_nhosts_gmpd_no_spec <- gls(nhosts~pubs, data=subset(gmpd_para_pubs, mpd>0))
gls_tree_nhosts_gmpd_no_spec <- gls(nhosts~1, data=subset(gmpd_para_pubs, mpd>0), correlation=corPagel(0.5, no_specialists_gmpd_parasite_tree))
gls_pubs_tree_nhosts_gmpd_no_spec <- gls(nhosts~pubs, data=subset(gmpd_para_pubs, mpd>0), correlation=corPagel(0.5, no_specialists_gmpd_parasite_tree)) 
## Evidence for phylogenetic signal, as the tree-only model outperforms the null model (p = 0.0231)
anova(gls_null_nhosts_gmpd_no_spec, gls_tree_nhosts_gmpd_no_spec)
## But also evidence for sampling bias
anova(gls_tree_nhosts_gmpd_no_spec, gls_pubs_tree_nhosts_gmpd_no_spec)
## Weak evidence for phylogenetic signal after accounting for sampling bias (p = 0.0495)
anova(gls_pubs_nhosts_gmpd_no_spec, gls_pubs_tree_nhosts_gmpd_no_spec)


## Nearctic database ##
nearctic_para_pubs$mpd <- unname(nearctic_para_mpd)
nearctic_para_pubs$nhosts <- unname(nearctic_para_nhosts)

## Analysis of range as mean pairwise distance
## All parasites
gls_null_mpd_nearctic <- gls(mpd~1, data=nearctic_para_pubs)
gls_pubs_mpd_nearctic <- gls(mpd~pubs, data=nearctic_para_pubs)
gls_tree_mpd_nearctic <- gls(mpd~1, data=nearctic_para_pubs, correlation=corPagel(0.5, nearctic_parasite_tree))
gls_pubs_tree_mpd_nearctic <- gls(mpd~pubs, data=nearctic_para_pubs, correlation=corPagel(0.5, nearctic_parasite_tree))
## Strong evidence for phylogenetic signal in MPD, as the tree-only model drastically outperforms the null model
anova(gls_null_mpd_nearctic, gls_tree_mpd_nearctic)
## No evidence for sampling bias
anova(gls_tree_mpd_nearctic, gls_pubs_tree_mpd_nearctic)
## Strong evidence for phylogenetic signal in MPD, as the tree+pubs model drastically outperforms the pubs-only model
anova(gls_pubs_mpd_nearctic, gls_pubs_tree_mpd_nearctic)

## Repeat analysis, but without specialists
gls_null_mpd_nearctic_no_spec <- gls(mpd~1, data=subset(nearctic_para_pubs, mpd>0))
gls_pubs_mpd_nearctic_no_spec <- gls(mpd~pubs, data=subset(nearctic_para_pubs, mpd>0))
gls_tree_mpd_nearctic_no_spec <- gls(mpd~1, data=subset(nearctic_para_pubs, mpd>0), correlation=corPagel(0.5, no_specialists_nearctic_parasite_tree))
gls_pubs_tree_mpd_nearctic_no_spec <- gls(mpd~pubs, data=subset(nearctic_para_pubs, mpd>0), correlation=corPagel(0.5, no_specialists_nearctic_parasite_tree))
## Strong evidence for phylogenetic signal in MPD, as the tree-only model drastically outperforms the null model
anova(gls_null_mpd_nearctic_no_spec, gls_tree_mpd_nearctic_no_spec)
## No evidence for sampling bias
anova(gls_tree_mpd_nearctic_no_spec, gls_pubs_tree_mpd_nearctic_no_spec)
## Strong evidence for phylogenetic signal in MPD, as the tree+pubs model drastically outperforms the pubs-only model
anova(gls_pubs_mpd_nearctic_no_spec, gls_pubs_tree_mpd_nearctic_no_spec)

## Analysis of range as number of hosts
## All parasites
gls_null_nhosts_nearctic <- gls(nhosts~1, data=nearctic_para_pubs)
gls_pubs_nhosts_nearctic <- gls(nhosts~pubs, data=nearctic_para_pubs)
gls_tree_nhosts_nearctic <- gls(nhosts~1, data=nearctic_para_pubs, correlation=corPagel(0.5, nearctic_parasite_tree))
gls_pubs_tree_nhosts_nearctic <- gls(nhosts~pubs, data=nearctic_para_pubs, correlation=corPagel(0.5, nearctic_parasite_tree))
## No evidence for phylogenetic signal in number of hosts, as tree-only does not outperform the null model
anova(gls_tree_nhosts_nearctic, gls_null_nhosts_nearctic)
## No evidence for sampling bias
anova(gls_tree_nhosts_nearctic, gls_pubs_tree_nhosts_nearctic)
## No evidence for phylogenetic signal here either, as tree+pubs does not outperform a pubs-only model
anova(gls_pubs_nhosts_nearctic, gls_pubs_tree_nhosts_nearctic)

## Repeat analysis, but without specialists
gls_null_nhosts_nearctic_no_spec <- gls(nhosts~1, data=subset(nearctic_para_pubs, mpd>0))
gls_pubs_nhosts_nearctic_no_spec <- gls(nhosts~pubs, data=subset(nearctic_para_pubs, mpd>0))
gls_tree_nhosts_nearctic_no_spec <- gls(nhosts~1, data=subset(nearctic_para_pubs, mpd>0), correlation=corPagel(0.5, no_specialists_nearctic_parasite_tree))
gls_pubs_tree_nhosts_nearctic_no_spec <- gls(nhosts~pubs, data=subset(nearctic_para_pubs, mpd>0), correlation=corPagel(0.5, no_specialists_nearctic_parasite_tree)) 
## No evidence for phylogenetic signal in number of hosts, as tree-only does not outperform the null model
anova(gls_tree_nhosts_nearctic_no_spec, gls_null_nhosts_nearctic_no_spec)
## No evidence for sampling bias
anova(gls_tree_nhosts_nearctic_no_spec, gls_pubs_tree_nhosts_nearctic_no_spec)
## No evidence for phylogenetic signal here either, as tree+pubs does not outperform a pubs-only model
anova(gls_pubs_nhosts_nearctic_no_spec, gls_pubs_tree_nhosts_nearctic_no_spec)

```



#Neartic OU Models of MPD by Phyla
```{r Phylum_OU_models_for_MPD, include = TRUE}
###NEARCTIC DATASET####

#match GMPD data to the nearctic tree (to get Phyla classifications)
g<-gmpd_data[match(nearctic_parasite_tree$tip.label, gmpd_data$ParasiteCorrectedName),]

#make Phyla dataframe (names, regimes, trait)
nearctic_parasite_phyla_data<-data.frame(nearctic_parasite_tree$tip.label)
nearctic_parasite_phyla_data$regime<-g$ParPhylum
nearctic_parasite_phyla_data$trait<-nearctic_para_mpd

## Phylogenetic comparative analysis analysis
## Convert phyla names to numbers for corHMM
nearctic_parasite_phyla_data$regAsNum <- as.numeric(as.factor(nearctic_parasite_phyla_data$regime))
## Get regimes for internal nodes using corHMM
regimes <- corHMM(nearctic_parasite_tree, nearctic_parasite_phyla_data[,c(1,4)], model="ER", rate.cat=1, node.states = "marginal")
## Convert internal node regimes back to phylum names and assign to the tree
nearctic_parasite_tree$node.label <- unname(sapply(as.character(regimes$phy$node.label), function(n) switch(n, "1"="Acanthocephala", "2"="Nematoda", "3"="Platyhelminthes")))

## Run 3 models: BM, BMS, OUM
nearctic_mpd_BM_fit <- OUwie(nearctic_parasite_tree, nearctic_parasite_phyla_data[,1:3], model="BM1", root.station=FALSE, scale=TRUE, quiet=TRUE, ub=Inf)
nearctic_mpd_BMS_fit <- OUwie(nearctic_parasite_tree, nearctic_parasite_phyla_data[,1:3], model="BMS", root.station=FALSE, scale=TRUE, quiet=TRUE, starting.vals=16500, ub=Inf) ## BMS fails, likely because of fully nested trees
nearctic_mpd_OUM_fit <- OUwie(nearctic_parasite_tree, nearctic_parasite_phyla_data, model="OUM", root.station=FALSE, scale=TRUE, quiet=TRUE, ub=Inf)


#######################################

## Nearctic dataset with single host species MPD removed

#match GMPD data to the remove_nearctic tree (to get Phyla classifications)
h<-gmpd_data[match(no_specialists_nearctic_parasite_tree$tip.label, gmpd_data$ParasiteCorrectedName),]

#make Phyla dataframe (names, regimes, trait)
remove_nearctic_phyla_data<-data.frame(no_specialists_nearctic_parasite_tree$tip.label)
remove_nearctic_phyla_data$regime<-h$ParPhylum
remove_nearctic_phyla_data$trait<-nearctic_para_mpd_no_specialists


```


#GMPD OU Models of MPD by Phyla
```{r OUmodels_Phyla_mpd_gmpd, include = TRUE}

#match GMPD data to the global tree
k<-gmpd_data[match(gmpd_parasite_tree$tip.label, gmpd_data$ParasiteCorrectedName),]

#make Phyla dataframe (names, regimes, trait)
gmpd_phyla_data<-data.frame(gmpd_parasite_tree$tip.label)
gmpd_phyla_data$regime<-k$ParPhylum
gmpd_phyla_data$trait<-gmpd_para_mpd

## Painting taxonomy-based regimes onto this tree
gmpd_ouchtree <- ape2ouch(gmpd_parasite_tree) ## convert to ouchtree object
## get the mpd data organized properly for ouch
gmpd_ouchdata <- rep(NA, length=gmpd_ouchtree@nnodes)
for (i in 1:length(gmpd_phyla_data$gmpd_parasite_tree.tip.label))
  gmpd_ouchdata[which(gmpd_ouchtree@nodelabels==gmpd_phyla_data$gmpd_parasite_tree.tip.label[i])] <- gmpd_phyla_data$trait[i]
gmpd_ouchdata <- as.data.frame(gmpd_ouchdata)

## You can use the code above, replacing nearctic with global, to find the last common ancestor for Platyhelminthes, Acanthocephalans, and Nematodes. I drop those blocks of code here to reduce the amount of code.

## Find the node that corresponds to the most recent common ancestor of all Platyhelminthes
## which nodes in the ouchtree correspond to the Plats
gmpd_ouchtree@nodelabels%in%gmpd_phyla_data$gmpd_parasite_tree.tip.label[which(gmpd_phyla_data$regime=="Platyhelminthes")] %>% which -> platys
## get their lineages and find the nodes that are in common across all lineages
gmpd_ouchtree@lineages[platys] -> platy_lineages
platy_lineages[[1]][sapply(platy_lineages[[1]], function(n) lapply(platy_lineages, function(l) n%in%l) %>% unlist %>% all) %>% which %>% min] ## 1

## Find the node that corresponds to the most recent common ancestor of all Acanthocephalans
## which nodes in the ouchtree correspond to the Acanths
gmpd_ouchtree@nodelabels%in%gmpd_phyla_data$gmpd_parasite_tree.tip.label[which(gmpd_phyla_data$regime=="Acanthocephala")] %>% which -> acanths
## get their lineages and find the nodes that are in common across all lineages
gmpd_ouchtree@lineages[acanths] -> acanth_lineages
acanth_lineages[[1]][sapply(acanth_lineages[[1]], function(n) lapply(acanth_lineages, function(l) n%in%l) %>% unlist %>% all) %>% which %>% min] ## 244

## Find the node that corresponds to the most recent common ancestor of all Nematodes
## which nodes in the ouchtree correspond to the Nematodes
gmpd_ouchtree@nodelabels%in%gmpd_phyla_data$gmpd_parasite_tree.tip.label[which(gmpd_phyla_data$regime=="Nematoda")] %>% which -> nematodes
## get their lineages and find the nodes that are in common across all lineages
gmpd_ouchtree@lineages[nematodes] -> nematode_lineages
nematode_lineages[[1]][sapply(nematode_lineages[[1]], function(n) lapply(nematode_lineages, function(l) n%in%l) %>% unlist %>% all) %>% which %>% min] #228


## paint the regimes onto the tree
paint(gmpd_ouchtree, subtree=c("1"="Platys","228"="Nematodes","244"="Acanths"), branch=c("1"="Platys")) -> gmpd_oum_regimes
## global regime
paint(gmpd_ouchtree, subtree=c("1"="global"), branch=c("1"="global")) -> gmpd_ou1_regimes
## Plot it to make sure it looks good
plot(gmpd_ouchtree, regimes=gmpd_oum_regimes)

## Now do the fitting using ouch
## OUM: AICc = 2490.73, alpha = 15.51, sigma.sq = 39836.98, Acanths = 24.97, Nematodes = 21.9, Platys = 46.97
gmpd_oum_ouch <- hansen(data=gmpd_ouchdata, tree=gmpd_ouchtree, regimes=gmpd_oum_regimes, sqrt.alpha=100, sigma=100)

## OU1: AICc = 2499.87, alpha = 9.00, sigma.sq = 26587.7, global = 33.2 
gmpd_ou1_ouch <- hansen(data=gmpd_ouchdata, tree=gmpd_ouchtree, regimes=gmpd_ou1_regimes, sqrt.alpha=100, sigma=100)

## BM: AICc = 2580.92, sigma.sq = 12287.94
gmpd_bm_ouch <- brown(data=gmpd_ouchdata, tree=gmpd_ouchtree)

#######################################

##with single host species MPD removed

#match GMPD data to the remove_global tree
l<-gmpd_data[match(no_specialists_gmpd_parasite_tree$tip.label, gmpd_data$ParasiteCorrectedName),]

#make Phyla dataframe for OUwie (names, regimes, trait)
remove_gmpd_phyla_data<-data.frame(no_specialists_gmpd_parasite_tree$tip.label)
remove_gmpd_phyla_data$regime<-l$ParPhylum
remove_gmpd_phyla_data$trait<-gmpd_para_mpd_no_specialists

## Prepare for ouch
remove_gmpd_ouchtree <- ape2ouch(no_specialists_gmpd_parasite_tree) ## convert to ouchtree object
## get the mpd data organized properly for ouch
remove_gmpd_ouchdata <- rep(NA, length=remove_gmpd_ouchtree@nnodes)
for (i in 1:length(remove_gmpd_phyla_data$
no_specialists_gmpd_parasite_tree.tip.label))
  remove_gmpd_ouchdata[which(remove_gmpd_ouchtree@nodelabels==remove_gmpd_phyla_data$
no_specialists_gmpd_parasite_tree.tip.label[i])] <- remove_gmpd_phyla_data$trait[i]
remove_gmpd_ouchdata <- as.data.frame(remove_gmpd_ouchdata)

## You can use the code above, replacing nearctic with remove_global, to find the last common ancestor for Platyhelminthes, Acanthocephalans, and Nematodes. I drop those blocks of code here to reduce the amount of code.
## Find the node that corresponds to the most recent common ancestor of all Platyhelminthes
## which nodes in the ouchtree correspond to the Plats
remove_gmpd_ouchtree@nodelabels%in%remove_gmpd_phyla_data$no_specialists_gmpd_parasite_tree.tip.label[which(remove_gmpd_phyla_data$regime=="Platyhelminthes")] %>% which -> platys
## get their lineages and find the nodes that are in common across all lineages
remove_gmpd_ouchtree@lineages[platys] -> platy_lineages
platy_lineages[[1]][sapply(platy_lineages[[1]], function(n) lapply(platy_lineages, function(l) n%in%l) %>% unlist %>% all) %>% which %>% min] ## 1

## Find the node that corresponds to the most recent common ancestor of all Acanthocephalans
## which nodes in the ouchtree correspond to the Acanths
remove_gmpd_ouchtree@nodelabels%in%remove_gmpd_phyla_data$no_specialists_gmpd_parasite_tree.tip.label[which(remove_gmpd_phyla_data$regime=="Acanthocephala")] %>% which -> acanths
## get their lineages and find the nodes that are in common across all lineages
remove_gmpd_ouchtree@lineages[acanths] -> acanth_lineages
acanth_lineages[[1]][sapply(acanth_lineages[[1]], function(n) lapply(acanth_lineages, function(l) n%in%l) %>% unlist %>% all) %>% which %>% min] ## 155

## Find the node that corresponds to the most recent common ancestor of all Nematodes
## which nodes in the ouchtree correspond to the Nematodes
remove_gmpd_ouchtree@nodelabels%in%remove_gmpd_phyla_data$no_specialists_gmpd_parasite_tree.tip.label[which(remove_gmpd_phyla_data$regime=="Nematoda")] %>% which -> nematodes
## get their lineages and find the nodes that are in common across all lineages
remove_gmpd_ouchtree@lineages[nematodes] -> nematode_lineages
nematode_lineages[[1]][sapply(nematode_lineages[[1]], function(n) lapply(nematode_lineages, function(l) n%in%l) %>% unlist %>% all) %>% which %>% min] #150


## paint the regimes onto the tree
paint(remove_gmpd_ouchtree, subtree=c("1"="Platys","150"="Nematodes","155"="Acanths"), branch=c("1"="Platys")) -> remove_gmpd_oum_regimes
## global regime
paint(remove_gmpd_ouchtree, subtree=c("1"="global"), branch=c("1"="global")) -> remove_gmpd_ou1_regimes

## Plot it to make sure it looks good
plot(remove_gmpd_ouchtree, regimes=remove_gmpd_oum_regimes)

## Now do the fitting using ouch
## OUM: AICc = 1539.4, alpha = 6.49, sigma.sq = 13662.77, Acanths = 67.7, Nematodes = 37.4, Platys = 68.2
remove_gmpd_oum_ouch <- hansen(data=remove_gmpd_ouchdata, tree=remove_gmpd_ouchtree, regimes=remove_gmpd_oum_regimes, sqrt.alpha=100, sigma=100)

## OU1: AICc = 1543.3, alpha = 4.28, sigma.sq = 10971.67, global = 55.2 
remove_gmpd_ou1_ouch <- hansen(data=remove_gmpd_ouchdata, tree=remove_gmpd_ouchtree, regimes=remove_gmpd_ou1_regimes, sqrt.alpha=100, sigma=100)

## BM: AICc = 1563.1, sigma.sq = 6256.3
remove_gmpd_bm_ouch <- brown(data=remove_gmpd_ouchdata, tree=remove_gmpd_ouchtree)
```

#Bootstrapping Evolutionary models for both datasets
```{r bootstrap_ouch_results, eval=FALSE, echo=FALSE}

## BOOTSTRAP ANALYSIS OF NEARCTIC DATA
## Simulate 1000 datasets using either the OUM, OU1 or the BM model, and then re-fit either the true data-generating model or the other model
nearctic_oum_datasets <- simulate(nearctic_oum_ouch, nsim=1000, seed=12983)
nearctic_ou1_datasets <- simulate(nearctic_ou1_ouch, nsim=1000, seed=12983)
nearctic_bm_datasets <- simulate(nearctic_bm_ouch, nsim=1000, seed=12983)
## Fit the OUM model to the OUM data
lapply(nearctic_oum_datasets, 
       function(data) hansen(data=data, 
                             tree=nearctic_parasite_ouchtree,
                             regimes=nearctic_oum_regimes,
                             sqrt.alpha=100, sigma=100)
) -> fit_oum_model_to_oum_data_nearctic
data.frame(logLik=lapply(fit_oum_model_to_oum_data_nearctic, function(fit) fit@loglik) %>% unlist,
           sigma.sq=lapply(fit_oum_model_to_oum_data_nearctic, function(fit) fit@sigma^2) %>% unlist,
           alpha=lapply(fit_oum_model_to_oum_data_nearctic, function(fit) fit@sqrt.alpha^2) %>% unlist,
           Acanths=lapply(fit_oum_model_to_oum_data_nearctic, function(fit) fit@theta[[1]][1]) %>% unlist,
           Nematodes=lapply(fit_oum_model_to_oum_data_nearctic, function(fit) fit@theta[[1]][2]) %>% unlist,
           Platys=lapply(fit_oum_model_to_oum_data_nearctic, function(fit) fit@theta[[1]][3]) %>% unlist
           ) -> fit_oum_model_to_oum_data_nearctic
saveRDS(fit_oum_model_to_oum_data_nearctic, file="bootstrap_results/fit_oum_model_to_oum_data_nearctic.RDS")
## Fit the OU1 model to the OUM data
lapply(nearctic_oum_datasets, 
       function(data) hansen(data=data, 
                             tree=nearctic_parasite_ouchtree,
                             regimes=nearctic_ou1_regimes,
                             sqrt.alpha=100, sigma=100)
) -> fit_ou1_model_to_oum_data_nearctic
data.frame(logLik=lapply(fit_ou1_model_to_oum_data_nearctic, function(fit) fit@loglik) %>% unlist,
           sigma.sq=lapply(fit_ou1_model_to_oum_data_nearctic, function(fit) fit@sigma^2) %>% unlist,
           alpha=lapply(fit_ou1_model_to_oum_data_nearctic, function(fit) fit@sqrt.alpha^2) %>% unlist,
           global=lapply(fit_ou1_model_to_oum_data_nearctic, function(fit) fit@theta %>% unlist) %>% unlist
           ) -> fit_ou1_model_to_oum_data_nearctic
saveRDS(fit_ou1_model_to_oum_data_nearctic, file="bootstrap_results/fit_ou1_model_to_oum_data_nearctic.RDS")
## Fit the BM model to the OUM data
lapply(nearctic_oum_datasets, 
       function(data) brown(data=data, 
                            tree=nearctic_parasite_ouchtree)
) -> fit_bm_model_to_oum_data_nearctic
data.frame(logLik=lapply(fit_bm_model_to_oum_data_nearctic, function(fit) fit@loglik) %>% unlist,
           sigma.sq=lapply(fit_bm_model_to_oum_data_nearctic, function(fit) fit@sigma^2) %>% unlist) -> fit_bm_model_to_oum_data_nearctic
saveRDS(fit_bm_model_to_oum_data_nearctic, file="bootstrap_results/fit_bm_model_to_oum_data_nearctic.RDS")

## Fit the OUM model to the OU1 data
lapply(nearctic_ou1_datasets, 
       function(data) hansen(data=data, 
                             tree=nearctic_parasite_ouchtree,
                             regimes=nearctic_oum_regimes,
                             sqrt.alpha=100, sigma=100)
) -> fit_oum_model_to_ou1_data_nearctic
data.frame(logLik=lapply(fit_oum_model_to_ou1_data_nearctic, function(fit) fit@loglik) %>% unlist,
           sigma.sq=lapply(fit_oum_model_to_ou1_data_nearctic, function(fit) fit@sigma^2) %>% unlist,
           alpha=lapply(fit_oum_model_to_ou1_data_nearctic, function(fit) fit@sqrt.alpha^2) %>% unlist,
           Acanths=lapply(fit_oum_model_to_ou1_data_nearctic, function(fit) fit@theta[[1]][1]) %>% unlist,
           Nematodes=lapply(fit_oum_model_to_ou1_data_nearctic, function(fit) fit@theta[[1]][2]) %>% unlist,
           Platys=lapply(fit_oum_model_to_ou1_data_nearctic, function(fit) fit@theta[[1]][3]) %>% unlist
           ) -> fit_oum_model_to_ou1_data_nearctic
saveRDS(fit_oum_model_to_ou1_data_nearctic, file="bootstrap_results/fit_oum_model_to_ou1_data_nearctic.RDS")
## Fit the OU1 model to the OU1 data
lapply(nearctic_ou1_datasets, 
       function(data) hansen(data=data, 
                             tree=nearctic_parasite_ouchtree,
                             regimes=nearctic_ou1_regimes,
                             sqrt.alpha=100, sigma=100)
) -> fit_ou1_model_to_ou1_data_nearctic
data.frame(logLik=lapply(fit_ou1_model_to_ou1_data_nearctic, function(fit) fit@loglik) %>% unlist,
           sigma.sq=lapply(fit_ou1_model_to_ou1_data_nearctic, function(fit) fit@sigma^2) %>% unlist,
           alpha=lapply(fit_ou1_model_to_ou1_data_nearctic, function(fit) fit@sqrt.alpha^2) %>% unlist,
           global=lapply(fit_ou1_model_to_ou1_data_nearctic, function(fit) fit@theta %>% unlist) %>% unlist
           ) -> fit_ou1_model_to_ou1_data_nearctic
saveRDS(fit_ou1_model_to_ou1_data_nearctic, file="bootstrap_results/fit_ou1_model_to_ou1_data_nearctic.RDS")

## Fit the OUM model to the BM data
lapply(nearctic_bm_datasets, 
       function(data) hansen(data=data, 
                             tree=nearctic_parasite_ouchtree,
                             regimes=nearctic_oum_regimes,
                             sqrt.alpha=100, sigma=100)
) -> fit_oum_model_to_bm_data_nearctic
data.frame(logLik=lapply(fit_oum_model_to_bm_data_nearctic, function(fit) fit@loglik) %>% unlist,
           sigma.sq=lapply(fit_oum_model_to_bm_data_nearctic, function(fit) fit@sigma^2) %>% unlist,
           alpha=lapply(fit_oum_model_to_bm_data_nearctic, function(fit) fit@sqrt.alpha^2) %>% unlist,
           Acanths=lapply(fit_oum_model_to_bm_data_nearctic, function(fit) fit@theta[[1]][1]) %>% unlist,
           Nematodes=lapply(fit_oum_model_to_bm_data_nearctic, function(fit) fit@theta[[1]][2]) %>% unlist,
           Platys=lapply(fit_oum_model_to_bm_data_nearctic, function(fit) fit@theta[[1]][3]) %>% unlist
           ) -> fit_oum_model_to_bm_data_nearctic
saveRDS(fit_oum_model_to_bm_data_nearctic, file="bootstrap_results/fit_oum_model_to_bm_data_nearctic.RDS")

## Fit the BM model to the BM data
lapply(nearctic_bm_datasets, 
       function(data) brown(data=data, 
                            tree=nearctic_parasite_ouchtree)
) -> fit_bm_model_to_bm_data_nearctic
data.frame(logLik=lapply(fit_bm_model_to_bm_data_nearctic, function(fit) fit@loglik) %>% unlist,
           sigma.sq=lapply(fit_bm_model_to_bm_data_nearctic, function(fit) fit@sigma^2) %>% unlist) -> fit_bm_model_to_bm_data_nearctic
saveRDS(fit_bm_model_to_bm_data_nearctic, file="bootstrap_results/fit_bm_model_to_bm_data_nearctic.RDS")



## BOOTSTRAP ANALYSIS OF NEARCTIC DATA WITH SPECIALISTS REMOVED
## Simulate 1000 datasets using either the OUM, OU1 or the BM model, and then re-fit either the true data-generating model or the other model
remove_nearctic_oum_datasets <- simulate(remove_nearctic_oum_ouch, nsim=1000, seed=12983)
remove_nearctic_ou1_datasets <- simulate(remove_nearctic_ou1_ouch, nsim=1000, seed=12983)
remove_nearctic_bm_datasets <- simulate(remove_nearctic_bm_ouch, nsim=1000, seed=12983)
## Fit the OUM model to the OUM data
lapply(remove_nearctic_oum_datasets, 
       function(data) hansen(data=data, 
                             tree=remove_nearctic_ouchtree,
                             regimes=remove_nearctic_oum_regimes,
                             sqrt.alpha=100, sigma=100)
) -> fit_oum_model_to_oum_data_remove_nearctic
data.frame(logLik=lapply(fit_oum_model_to_oum_data_remove_nearctic, function(fit) fit@loglik) %>% unlist,
           sigma.sq=lapply(fit_oum_model_to_oum_data_remove_nearctic, function(fit) fit@sigma^2) %>% unlist,
           alpha=lapply(fit_oum_model_to_oum_data_remove_nearctic, function(fit) fit@sqrt.alpha^2) %>% unlist,
           Acanths=lapply(fit_oum_model_to_oum_data_remove_nearctic, function(fit) fit@theta[[1]][1]) %>% unlist,
           Nematodes=lapply(fit_oum_model_to_oum_data_remove_nearctic, function(fit) fit@theta[[1]][2]) %>% unlist,
           Platys=lapply(fit_oum_model_to_oum_data_remove_nearctic, function(fit) fit@theta[[1]][3]) %>% unlist
           ) -> fit_oum_model_to_oum_data_remove_nearctic
saveRDS(fit_oum_model_to_oum_data_remove_nearctic, file="bootstrap_results/fit_oum_model_to_oum_data_remove_nearctic.RDS")

## Fit the OU1 model to the OUM data
lapply(remove_nearctic_oum_datasets, 
       function(data) hansen(data=data, 
                             tree=remove_nearctic_ouchtree,
                             regimes=remove_nearctic_ou1_regimes,
                             sqrt.alpha=100, sigma=100)
) -> fit_ou1_model_to_oum_data_remove_nearctic
data.frame(logLik=lapply(fit_ou1_model_to_oum_data_remove_nearctic, function(fit) fit@loglik) %>% unlist,
           sigma.sq=lapply(fit_ou1_model_to_oum_data_remove_nearctic, function(fit) fit@sigma^2) %>% unlist,
           alpha=lapply(fit_ou1_model_to_oum_data_remove_nearctic, function(fit) fit@sqrt.alpha^2) %>% unlist,
           global=lapply(fit_ou1_model_to_oum_data_remove_nearctic, function(fit) fit@theta %>% unlist) %>% unlist
           ) -> fit_ou1_model_to_oum_data_remove_nearctic
saveRDS(fit_ou1_model_to_oum_data_remove_nearctic, file="bootstrap_results/fit_ou1_model_to_oum_data_remove_nearctic.RDS")

## Fit the BM model to the OUM data
lapply(remove_nearctic_oum_datasets, 
       function(data) brown(data=data, 
                            tree=remove_nearctic_ouchtree)
) -> fit_bm_model_to_oum_data_remove_nearctic
data.frame(logLik=lapply(fit_bm_model_to_oum_data_remove_nearctic, function(fit) fit@loglik) %>% unlist,
           sigma.sq=lapply(fit_bm_model_to_oum_data_remove_nearctic, function(fit) fit@sigma^2) %>% unlist) -> fit_bm_model_to_oum_data_remove_nearctic
saveRDS(fit_bm_model_to_oum_data_remove_nearctic, file="bootstrap_results/fit_bm_model_to_oum_data_remove_nearctic.RDS")

## Fit the OUM model to the OU1 data
lapply(remove_nearctic_ou1_datasets, 
       function(data) hansen(data=data, 
                             tree=remove_nearctic_ouchtree,
                             regimes=remove_nearctic_oum_regimes,
                             sqrt.alpha=100, sigma=100)
) -> fit_oum_model_to_ou1_data_remove_nearctic
data.frame(logLik=lapply(fit_oum_model_to_ou1_data_remove_nearctic, function(fit) fit@loglik) %>% unlist,
           sigma.sq=lapply(fit_oum_model_to_ou1_data_remove_nearctic, function(fit) fit@sigma^2) %>% unlist,
           alpha=lapply(fit_oum_model_to_ou1_data_remove_nearctic, function(fit) fit@sqrt.alpha^2) %>% unlist,
           Acanths=lapply(fit_oum_model_to_ou1_data_remove_nearctic, function(fit) fit@theta[[1]][1]) %>% unlist,
           Nematodes=lapply(fit_oum_model_to_ou1_data_remove_nearctic, function(fit) fit@theta[[1]][2]) %>% unlist,
           Platys=lapply(fit_oum_model_to_ou1_data_remove_nearctic, function(fit) fit@theta[[1]][3]) %>% unlist
           ) -> fit_oum_model_to_ou1_data_remove_nearctic
saveRDS(fit_oum_model_to_ou1_data_remove_nearctic, file="bootstrap_results/fit_oum_model_to_ou1_data_remove_nearctic.RDS")

## Fit the OU1 model to the OU1 data
lapply(remove_nearctic_ou1_datasets, 
       function(data) hansen(data=data, 
                             tree=remove_nearctic_ouchtree,
                             regimes=remove_nearctic_ou1_regimes,
                             sqrt.alpha=100, sigma=100)
) -> fit_ou1_model_to_ou1_data_remove_nearctic
data.frame(logLik=lapply(fit_ou1_model_to_ou1_data_remove_nearctic, function(fit) fit@loglik) %>% unlist,
           sigma.sq=lapply(fit_ou1_model_to_ou1_data_remove_nearctic, function(fit) fit@sigma^2) %>% unlist,
           alpha=lapply(fit_ou1_model_to_ou1_data_remove_nearctic, function(fit) fit@sqrt.alpha^2) %>% unlist,
           global=lapply(fit_ou1_model_to_ou1_data_remove_nearctic, function(fit) fit@theta %>% unlist) %>% unlist
           ) -> fit_ou1_model_to_ou1_data_remove_nearctic
saveRDS(fit_ou1_model_to_ou1_data_remove_nearctic, file="bootstrap_results/fit_ou1_model_to_ou1_data_remove_nearctic.RDS")

## Fit the OUM model to the BM data
lapply(remove_nearctic_bm_datasets, 
       function(data) hansen(data=data, 
                             tree=remove_nearctic_ouchtree,
                             regimes=remove_nearctic_oum_regimes,
                             sqrt.alpha=100, sigma=100)
) -> fit_oum_model_to_bm_data_remove_nearctic
data.frame(logLik=lapply(fit_oum_model_to_bm_data_remove_nearctic, function(fit) fit@loglik) %>% unlist,
           sigma.sq=lapply(fit_oum_model_to_bm_data_remove_nearctic, function(fit) fit@sigma^2) %>% unlist,
           alpha=lapply(fit_oum_model_to_bm_data_remove_nearctic, function(fit) fit@sqrt.alpha^2) %>% unlist,
           Acanths=lapply(fit_oum_model_to_bm_data_remove_nearctic, function(fit) fit@theta[[1]][1]) %>% unlist,
           Nematodes=lapply(fit_oum_model_to_bm_data_remove_nearctic, function(fit) fit@theta[[1]][2]) %>% unlist,
           Platys=lapply(fit_oum_model_to_bm_data_remove_nearctic, function(fit) fit@theta[[1]][3]) %>% unlist
           ) -> fit_oum_model_to_bm_data_remove_nearctic
saveRDS(fit_oum_model_to_bm_data_remove_nearctic, file="bootstrap_results/fit_oum_model_to_bm_data_remove_nearctic.RDS")

## Fit the BM model to the BM data
lapply(remove_nearctic_bm_datasets, 
       function(data) brown(data=data, 
                            tree=remove_nearctic_ouchtree)
) -> fit_bm_model_to_bm_data_remove_nearctic
data.frame(logLik=lapply(fit_bm_model_to_bm_data_remove_nearctic, function(fit) fit@loglik) %>% unlist,
           sigma.sq=lapply(fit_bm_model_to_bm_data_remove_nearctic, function(fit) fit@sigma^2) %>% unlist) -> fit_bm_model_to_bm_data_remove_nearctic
saveRDS(fit_bm_model_to_bm_data_remove_nearctic, file="bootstrap_results/fit_bm_model_to_bm_data_remove_nearctic.RDS")



## BOOTSTRAP ANALYSIS OF GMPD DATA
## Simulate 1000 datasets using either the OUM, OU1 or the BM model, and then re-fit either the true data-generating model or the other model
gmpd_oum_datasets <- simulate(gmpd_oum_ouch, nsim=1000, seed=12983)
gmpd_ou1_datasets <- simulate(gmpd_ou1_ouch, nsim=1000, seed=12983)
gmpd_bm_datasets <- simulate(gmpd_bm_ouch, nsim=1000, seed=12983)
lapply(gmpd_oum_datasets, 
       function(data) hansen(data=data, 
                             tree=gmpd_ouchtree,
                             regimes=gmpd_oum_regimes,
                             sqrt.alpha=100, sigma=100)
) -> fit_oum_model_to_oum_data_gmpd
data.frame(logLik=lapply(fit_oum_model_to_oum_data_gmpd, function(fit) fit@loglik) %>% unlist,
           sigma.sq=lapply(fit_oum_model_to_oum_data_gmpd, function(fit) fit@sigma^2) %>% unlist,
           alpha=lapply(fit_oum_model_to_oum_data_gmpd, function(fit) fit@sqrt.alpha^2) %>% unlist,
           Acanths=lapply(fit_oum_model_to_oum_data_gmpd, function(fit) fit@theta[[1]][1]) %>% unlist,
           Nematodes=lapply(fit_oum_model_to_oum_data_gmpd, function(fit) fit@theta[[1]][2]) %>% unlist,
           Platys=lapply(fit_oum_model_to_oum_data_gmpd, function(fit) fit@theta[[1]][3]) %>% unlist
           ) -> fit_oum_model_to_oum_data_gmpd
saveRDS(fit_oum_model_to_oum_data_gmpd, file="bootstrap_results/fit_oum_model_to_oum_data_gmpd.RDS")

## Fit the OU1 model to the OUM data
lapply(gmpd_oum_datasets, 
       function(data) hansen(data=data, 
                             tree=gmpd_ouchtree,
                             regimes=gmpd_ou1_regimes,
                             sqrt.alpha=100, sigma=100)
) -> fit_ou1_model_to_oum_data_gmpd
data.frame(logLik=lapply(fit_ou1_model_to_oum_data_gmpd, function(fit) fit@loglik) %>% unlist,
           sigma.sq=lapply(fit_ou1_model_to_oum_data_gmpd, function(fit) fit@sigma^2) %>% unlist,
           alpha=lapply(fit_ou1_model_to_oum_data_gmpd, function(fit) fit@sqrt.alpha^2) %>% unlist,
           global=lapply(fit_ou1_model_to_oum_data_gmpd, function(fit) fit@theta %>% unlist) %>% unlist
           ) -> fit_ou1_model_to_oum_data_gmpd
saveRDS(fit_ou1_model_to_oum_data_gmpd, file="bootstrap_results/fit_ou1_model_to_oum_data_gmpd.RDS")

## Fit the BM model to the OUM data
lapply(gmpd_oum_datasets, 
       function(data) brown(data=data, 
                            tree=gmpd_ouchtree)
) -> fit_bm_model_to_oum_data_gmpd
data.frame(logLik=lapply(fit_bm_model_to_oum_data_gmpd, function(fit) fit@loglik) %>% unlist,
           sigma.sq=lapply(fit_bm_model_to_oum_data_gmpd, function(fit) fit@sigma^2) %>% unlist) -> fit_bm_model_to_oum_data_gmpd
saveRDS(fit_bm_model_to_oum_data_gmpd, file="bootstrap_results/fit_bm_model_to_oum_data_gmpd.RDS")

## Fit the OUM model to the OU1 data
lapply(gmpd_ou1_datasets, 
       function(data) hansen(data=data, 
                             tree=gmpd_ouchtree,
                             regimes=gmpd_oum_regimes,
                             sqrt.alpha=100, sigma=100)
) -> fit_oum_model_to_ou1_data_gmpd
data.frame(logLik=lapply(fit_oum_model_to_ou1_data_gmpd, function(fit) fit@loglik) %>% unlist,
           sigma.sq=lapply(fit_oum_model_to_ou1_data_gmpd, function(fit) fit@sigma^2) %>% unlist,
           alpha=lapply(fit_oum_model_to_ou1_data_gmpd, function(fit) fit@sqrt.alpha^2) %>% unlist,
           Acanths=lapply(fit_oum_model_to_ou1_data_gmpd, function(fit) fit@theta[[1]][1]) %>% unlist,
           Nematodes=lapply(fit_oum_model_to_ou1_data_gmpd, function(fit) fit@theta[[1]][2]) %>% unlist,
           Platys=lapply(fit_oum_model_to_ou1_data_gmpd, function(fit) fit@theta[[1]][3]) %>% unlist
           ) -> fit_oum_model_to_ou1_data_gmpd
saveRDS(fit_oum_model_to_ou1_data_gmpd, file="bootstrap_results/fit_oum_model_to_ou1_data_gmpd.RDS")

## Fit the OU1 model to the OU1 data
lapply(gmpd_ou1_datasets, 
       function(data) hansen(data=data, 
                             tree=gmpd_ouchtree,
                             regimes=gmpd_ou1_regimes,
                             sqrt.alpha=100, sigma=100)
) -> fit_ou1_model_to_ou1_data_gmpd
data.frame(logLik=lapply(fit_ou1_model_to_ou1_data_gmpd, function(fit) fit@loglik) %>% unlist,
           sigma.sq=lapply(fit_ou1_model_to_ou1_data_gmpd, function(fit) fit@sigma^2) %>% unlist,
           alpha=lapply(fit_ou1_model_to_ou1_data_gmpd, function(fit) fit@sqrt.alpha^2) %>% unlist,
           global=lapply(fit_ou1_model_to_ou1_data_gmpd, function(fit) fit@theta %>% unlist) %>% unlist
           ) -> fit_ou1_model_to_ou1_data_gmpd
saveRDS(fit_ou1_model_to_ou1_data_gmpd, file="bootstrap_results/fit_ou1_model_to_ou1_data_gmpd.RDS")

## Fit the OUM model to the BM data
lapply(gmpd_bm_datasets, 
       function(data) hansen(data=data, 
                             tree=gmpd_ouchtree,
                             regimes=gmpd_oum_regimes,
                             sqrt.alpha=100, sigma=100)
) -> fit_oum_model_to_bm_data_gmpd
data.frame(logLik=lapply(fit_oum_model_to_bm_data_gmpd, function(fit) fit@loglik) %>% unlist,
           sigma.sq=lapply(fit_oum_model_to_bm_data_gmpd, function(fit) fit@sigma^2) %>% unlist,
           alpha=lapply(fit_oum_model_to_bm_data_gmpd, function(fit) fit@sqrt.alpha^2) %>% unlist,
           Acanths=lapply(fit_oum_model_to_bm_data_gmpd, function(fit) fit@theta[[1]][1]) %>% unlist,
           Nematodes=lapply(fit_oum_model_to_bm_data_gmpd, function(fit) fit@theta[[1]][2]) %>% unlist,
           Platys=lapply(fit_oum_model_to_bm_data_gmpd, function(fit) fit@theta[[1]][3]) %>% unlist
           ) -> fit_oum_model_to_bm_data_gmpd
saveRDS(fit_oum_model_to_bm_data_gmpd, file="bootstrap_results/fit_oum_model_to_bm_data_gmpd.RDS")

## Fit the BM model to the BM data
lapply(gmpd_bm_datasets, 
       function(data) brown(data=data, 
                            tree=gmpd_ouchtree)
) -> fit_bm_model_to_bm_data_gmpd
data.frame(logLik=lapply(fit_bm_model_to_bm_data_gmpd, function(fit) fit@loglik) %>% unlist,
           sigma.sq=lapply(fit_bm_model_to_bm_data_gmpd, function(fit) fit@sigma^2) %>% unlist) -> fit_bm_model_to_bm_data_gmpd
saveRDS(fit_bm_model_to_bm_data_gmpd, file="bootstrap_results/fit_bm_model_to_bm_data_gmpd.RDS")

## BOOTSTRAP ANALYSIS OF GMPD DATA WITH SPECIALISTS REMOVED
## Simulate 1000 datasets using either the OUM, OU1 or the BM model, and then re-fit either the true data-generating model or the other model
remove_gmpd_oum_datasets <- simulate(remove_gmpd_oum_ouch, nsim=1000, seed=12983)
remove_gmpd_ou1_datasets <- simulate(remove_gmpd_ou1_ouch, nsim=1000, seed=12983)
remove_gmpd_bm_datasets <- simulate(remove_gmpd_bm_ouch, nsim=1000, seed=12983)
## Fit the OUM model to the OUM data
lapply(remove_gmpd_oum_datasets, 
       function(data) hansen(data=data, 
                             tree=remove_gmpd_ouchtree,
                             regimes=remove_gmpd_oum_regimes,
                             sqrt.alpha=100, sigma=100)
) -> fit_oum_model_to_oum_data_remove_gmpd
data.frame(logLik=lapply(fit_oum_model_to_oum_data_remove_gmpd, function(fit) fit@loglik) %>% unlist,
           sigma.sq=lapply(fit_oum_model_to_oum_data_remove_gmpd, function(fit) fit@sigma^2) %>% unlist,
           alpha=lapply(fit_oum_model_to_oum_data_remove_gmpd, function(fit) fit@sqrt.alpha^2) %>% unlist,
           Acanths=lapply(fit_oum_model_to_oum_data_remove_gmpd, function(fit) fit@theta[[1]][1]) %>% unlist,
           Nematodes=lapply(fit_oum_model_to_oum_data_remove_gmpd, function(fit) fit@theta[[1]][2]) %>% unlist,
           Platys=lapply(fit_oum_model_to_oum_data_remove_gmpd, function(fit) fit@theta[[1]][3]) %>% unlist
           ) -> fit_oum_model_to_oum_data_remove_gmpd
saveRDS(fit_oum_model_to_oum_data_remove_gmpd, file="bootstrap_results/fit_oum_model_to_oum_data_remove_gmpd.RDS")

## Fit the OU1 model to the OUM data
lapply(remove_gmpd_oum_datasets, 
       function(data) hansen(data=data, 
                             tree=remove_gmpd_ouchtree,
                             regimes=remove_gmpd_ou1_regimes,
                             sqrt.alpha=100, sigma=100)
) -> fit_ou1_model_to_oum_data_remove_gmpd
data.frame(logLik=lapply(fit_ou1_model_to_oum_data_remove_gmpd, function(fit) fit@loglik) %>% unlist,
           sigma.sq=lapply(fit_ou1_model_to_oum_data_remove_gmpd, function(fit) fit@sigma^2) %>% unlist,
           alpha=lapply(fit_ou1_model_to_oum_data_remove_gmpd, function(fit) fit@sqrt.alpha^2) %>% unlist,
           global=lapply(fit_ou1_model_to_oum_data_remove_gmpd, function(fit) fit@theta %>% unlist) %>% unlist
           ) -> fit_ou1_model_to_oum_data_remove_gmpd
saveRDS(fit_ou1_model_to_oum_data_remove_gmpd, file="bootstrap_results/fit_ou1_model_to_oum_data_remove_gmpd.RDS")

## Fit the BM model to the OUM data
lapply(remove_gmpd_oum_datasets, 
       function(data) brown(data=data, 
                            tree=remove_gmpd_ouchtree)
) -> fit_bm_model_to_oum_data_remove_gmpd
data.frame(logLik=lapply(fit_bm_model_to_oum_data_remove_gmpd, function(fit) fit@loglik) %>% unlist,
           sigma.sq=lapply(fit_bm_model_to_oum_data_remove_gmpd, function(fit) fit@sigma^2) %>% unlist) -> fit_bm_model_to_oum_data_remove_gmpd
saveRDS(fit_bm_model_to_oum_data_remove_gmpd, file="bootstrap_results/fit_bm_model_to_oum_data_remove_gmpd.RDS")

## Fit the OUM model to the OU1 data
lapply(remove_gmpd_ou1_datasets, 
       function(data) hansen(data=data, 
                             tree=remove_gmpd_ouchtree,
                             regimes=remove_gmpd_oum_regimes,
                             sqrt.alpha=100, sigma=100)
) -> fit_oum_model_to_ou1_data_remove_gmpd
data.frame(logLik=lapply(fit_oum_model_to_ou1_data_remove_gmpd, function(fit) fit@loglik) %>% unlist,
           sigma.sq=lapply(fit_oum_model_to_ou1_data_remove_gmpd, function(fit) fit@sigma^2) %>% unlist,
           alpha=lapply(fit_oum_model_to_ou1_data_remove_gmpd, function(fit) fit@sqrt.alpha^2) %>% unlist,
           Acanths=lapply(fit_oum_model_to_ou1_data_remove_gmpd, function(fit) fit@theta[[1]][1]) %>% unlist,
           Nematodes=lapply(fit_oum_model_to_ou1_data_remove_gmpd, function(fit) fit@theta[[1]][2]) %>% unlist,
           Platys=lapply(fit_oum_model_to_ou1_data_remove_gmpd, function(fit) fit@theta[[1]][3]) %>% unlist
           ) -> fit_oum_model_to_ou1_data_remove_gmpd
saveRDS(fit_oum_model_to_ou1_data_remove_gmpd, file="bootstrap_results/fit_oum_model_to_ou1_data_remove_gmpd.RDS")

## Fit the OU1 model to the OU1 data
lapply(remove_gmpd_ou1_datasets, 
       function(data) hansen(data=data, 
                             tree=remove_gmpd_ouchtree,
                             regimes=remove_gmpd_ou1_regimes,
                             sqrt.alpha=100, sigma=100)
) -> fit_ou1_model_to_ou1_data_remove_gmpd
data.frame(logLik=lapply(fit_ou1_model_to_ou1_data_remove_gmpd, function(fit) fit@loglik) %>% unlist,
           sigma.sq=lapply(fit_ou1_model_to_ou1_data_remove_gmpd, function(fit) fit@sigma^2) %>% unlist,
           alpha=lapply(fit_ou1_model_to_ou1_data_remove_gmpd, function(fit) fit@sqrt.alpha^2) %>% unlist,
           global=lapply(fit_ou1_model_to_ou1_data_remove_gmpd, function(fit) fit@theta %>% unlist) %>% unlist
           ) -> fit_ou1_model_to_ou1_data_remove_gmpd
saveRDS(fit_ou1_model_to_ou1_data_remove_gmpd, file="bootstrap_results/fit_ou1_model_to_ou1_data_remove_gmpd.RDS")

## Fit the OUM model to the BM data
lapply(remove_gmpd_bm_datasets, 
       function(data) hansen(data=data, 
                             tree=remove_gmpd_ouchtree,
                             regimes=remove_gmpd_oum_regimes,
                             sqrt.alpha=100, sigma=100)
) -> fit_oum_model_to_bm_data_remove_gmpd
data.frame(logLik=lapply(fit_oum_model_to_bm_data_remove_gmpd, function(fit) fit@loglik) %>% unlist,
           sigma.sq=lapply(fit_oum_model_to_bm_data_remove_gmpd, function(fit) fit@sigma^2) %>% unlist,
           alpha=lapply(fit_oum_model_to_bm_data_remove_gmpd, function(fit) fit@sqrt.alpha^2) %>% unlist,
           Acanths=lapply(fit_oum_model_to_bm_data_remove_gmpd, function(fit) fit@theta[[1]][1]) %>% unlist,
           Nematodes=lapply(fit_oum_model_to_bm_data_remove_gmpd, function(fit) fit@theta[[1]][2]) %>% unlist,
           Platys=lapply(fit_oum_model_to_bm_data_remove_gmpd, function(fit) fit@theta[[1]][3]) %>% unlist
           ) -> fit_oum_model_to_bm_data_remove_gmpd
saveRDS(fit_oum_model_to_bm_data_remove_gmpd, file="bootstrap_results/fit_oum_model_to_bm_data_remove_gmpd.RDS")

## Fit the BM model to the BM data
lapply(remove_gmpd_bm_datasets, 
       function(data) brown(data=data, 
                            tree=remove_gmpd_ouchtree)
) -> fit_bm_model_to_bm_data_remove_gmpd
data.frame(logLik=lapply(fit_bm_model_to_bm_data_remove_gmpd, function(fit) fit@loglik) %>% unlist,
           sigma.sq=lapply(fit_bm_model_to_bm_data_remove_gmpd, function(fit) fit@sigma^2) %>% unlist) -> fit_bm_model_to_bm_data_remove_gmpd
saveRDS(fit_bm_model_to_bm_data_remove_gmpd, file="bootstrap_results/fit_bm_model_to_bm_data_remove_gmpd.RDS")


```

```{r bootstrap_analysis}
## Load all of the bootstrap data
fit_oum_model_to_oum_data_nearctic <- readRDS(file="bootstrap_results/fit_oum_model_to_oum_data_nearctic.RDS")
fit_oum_model_to_ou1_data_nearctic <- readRDS(file="bootstrap_results/fit_oum_model_to_ou1_data_nearctic.RDS")
fit_oum_model_to_bm_data_nearctic <- readRDS(file="bootstrap_results/fit_oum_model_to_bm_data_nearctic.RDS")
fit_ou1_model_to_oum_data_nearctic <- readRDS(file="bootstrap_results/fit_ou1_model_to_oum_data_nearctic.RDS")
fit_ou1_model_to_ou1_data_nearctic <- readRDS(file="bootstrap_results/fit_ou1_model_to_ou1_data_nearctic.RDS")
fit_bm_model_to_oum_data_nearctic <- readRDS(file="bootstrap_results/fit_bm_model_to_oum_data_nearctic.RDS")
fit_bm_model_to_bm_data_nearctic <- readRDS(file="bootstrap_results/fit_bm_model_to_bm_data_nearctic.RDS")

fit_oum_model_to_oum_data_remove_nearctic <- readRDS(file="bootstrap_results/fit_oum_model_to_oum_data_remove_nearctic.RDS")
fit_oum_model_to_ou1_data_remove_nearctic <- readRDS(file="bootstrap_results/fit_oum_model_to_ou1_data_remove_nearctic.RDS")
fit_oum_model_to_bm_data_remove_nearctic <- readRDS(file="bootstrap_results/fit_oum_model_to_bm_data_remove_nearctic.RDS")
fit_ou1_model_to_oum_data_remove_nearctic <- readRDS(file="bootstrap_results/fit_ou1_model_to_oum_data_remove_nearctic.RDS")
fit_ou1_model_to_ou1_data_remove_nearctic <- readRDS(file="bootstrap_results/fit_ou1_model_to_ou1_data_remove_nearctic.RDS")
fit_bm_model_to_oum_data_remove_nearctic <- readRDS(file="bootstrap_results/fit_bm_model_to_oum_data_remove_nearctic.RDS")
fit_bm_model_to_bm_data_remove_nearctic <- readRDS(file="bootstrap_results/fit_bm_model_to_bm_data_remove_nearctic.RDS")

fit_oum_model_to_oum_data_gmpd <- readRDS(file="bootstrap_results/fit_oum_model_to_oum_data_gmpd.RDS")
fit_oum_model_to_ou1_data_gmpd <- readRDS(file="bootstrap_results/fit_oum_model_to_ou1_data_gmpd.RDS")
fit_oum_model_to_bm_data_gmpd <- readRDS(file="bootstrap_results/fit_oum_model_to_bm_data_gmpd.RDS")
fit_ou1_model_to_oum_data_gmpd <- readRDS(file="bootstrap_results/fit_ou1_model_to_oum_data_gmpd.RDS")
fit_ou1_model_to_ou1_data_gmpd <- readRDS(file="bootstrap_results/fit_ou1_model_to_ou1_data_gmpd.RDS")
fit_bm_model_to_oum_data_gmpd <- readRDS(file="bootstrap_results/fit_bm_model_to_oum_data_gmpd.RDS")
fit_bm_model_to_bm_data_gmpd <- readRDS(file="bootstrap_results/fit_bm_model_to_bm_data_gmpd.RDS")

fit_oum_model_to_oum_data_remove_gmpd <- readRDS(file="bootstrap_results/fit_oum_model_to_oum_data_remove_gmpd.RDS")
fit_oum_model_to_ou1_data_remove_gmpd <- readRDS(file="bootstrap_results/fit_oum_model_to_ou1_data_remove_gmpd.RDS")
fit_oum_model_to_bm_data_remove_gmpd <- readRDS(file="bootstrap_results/fit_oum_model_to_bm_data_remove_gmpd.RDS")
fit_ou1_model_to_oum_data_remove_gmpd <- readRDS(file="bootstrap_results/fit_ou1_model_to_oum_data_remove_gmpd.RDS")
fit_ou1_model_to_ou1_data_remove_gmpd <- readRDS(file="bootstrap_results/fit_ou1_model_to_ou1_data_remove_gmpd.RDS")
fit_bm_model_to_oum_data_remove_gmpd <- readRDS(file="bootstrap_results/fit_bm_model_to_oum_data_remove_gmpd.RDS")
fit_bm_model_to_bm_data_remove_gmpd <- readRDS(file="bootstrap_results/fit_bm_model_to_bm_data_remove_gmpd.RDS")

## If we treat BM as the null model, then we can compute the likelihood differences observed when BM is true to the observed likelihood difference in the real data to determine a p-value
## 1. Compute the likelihood difference between the BM model fit to the BM data and the OU model fit to the BM data for all simulated datasets
## 2. Compute the likelihood difference between the BM model fit to the real data and the OU model fit to the real data
## 3. The number of likelihood differences computed in step #1 that are larger than the observed likelihood difference divided by the total number of simulated datasets gives an estimate of the p-value of the test (since the p-value is the probability of observing a dataset as extreme as the real one, assuming that the null model [BM] is true)
(((fit_bm_model_to_bm_data_gmpd$logLik-fit_oum_model_to_bm_data_gmpd$logLik) < (gmpd_bm_ouch@loglik - gmpd_oum_ouch@loglik)) %>% sum)/nrow(fit_bm_model_to_bm_data_gmpd) -> p_value_bm_vs_oum_gmpd #0 

(((fit_bm_model_to_bm_data_remove_gmpd$logLik-fit_oum_model_to_bm_data_remove_gmpd$logLik) < (remove_gmpd_bm_ouch@loglik - remove_gmpd_oum_ouch@loglik)) %>% sum)/nrow(fit_bm_model_to_bm_data_remove_gmpd) -> p_value_bm_vs_oum_remove_gmpd #0

(((fit_bm_model_to_bm_data_nearctic$logLik-fit_oum_model_to_bm_data_nearctic$logLik) < (nearctic_bm_ouch@loglik - nearctic_oum_ouch@loglik)) %>% sum)/nrow(fit_bm_model_to_bm_data_nearctic) -> p_value_bm_vs_oum_nearctic #0

(((fit_bm_model_to_bm_data_remove_nearctic$logLik-fit_oum_model_to_bm_data_remove_nearctic$logLik) < (remove_nearctic_bm_ouch@loglik - remove_nearctic_oum_ouch@loglik)) %>% sum)/nrow(fit_bm_model_to_bm_data_remove_nearctic) -> p_value_bm_vs_oum_remove_nearctic #0

## If we treat OU1 as the null model, then we can compute the likelihood differences observed when OU1 is true to the observed likelihood difference in the real data to determine a p-value
## 1. Compute the likelihood difference between the OU1 model fit to the OU1 data and the OUM model fit to the OU1 data for all simulated datasets
## 2. Compute the likelihood difference between the OU1 model fit to the real data and the OUM model fit to the real data
## 3. The number of likelihood differences computed in step #1 that are larger than the observed likelihood difference divided by the total number of simulated datasets gives an estimate of the p-value of the test (since the p-value is the probability of observing a dataset as extreme as the real one, assuming that the null model [BM] is true)
(((fit_ou1_model_to_ou1_data_gmpd$logLik-fit_oum_model_to_ou1_data_gmpd$logLik) < (gmpd_ou1_ouch@loglik - gmpd_oum_ouch@loglik)) %>% sum)/nrow(fit_ou1_model_to_ou1_data_gmpd) -> p_value_ou1_vs_oum_gmpd #0.002 

(((fit_ou1_model_to_ou1_data_remove_gmpd$logLik-fit_oum_model_to_ou1_data_remove_gmpd$logLik) < (remove_gmpd_ou1_ouch@loglik - remove_gmpd_oum_ouch@loglik)) %>% sum)/nrow(fit_ou1_model_to_ou1_data_remove_gmpd) -> p_value_ou1_vs_oum_remove_gmpd #0.063

(((fit_ou1_model_to_ou1_data_nearctic$logLik-fit_oum_model_to_ou1_data_nearctic$logLik) < (nearctic_ou1_ouch@loglik - nearctic_oum_ouch@loglik)) %>% sum)/nrow(fit_ou1_model_to_ou1_data_nearctic) -> p_value_ou1_vs_oum_nearctic #0.001 

(((fit_ou1_model_to_ou1_data_remove_nearctic$logLik-fit_oum_model_to_ou1_data_remove_nearctic$logLik) < (remove_nearctic_ou1_ouch@loglik - remove_nearctic_oum_ouch@loglik)) %>% sum)/nrow(fit_ou1_model_to_ou1_data_remove_nearctic) -> p_value_ou1_vs_oum_remove_nearctic #0

## Computing the power of a test that rejects the BM model with a false positive rate of 5%
## 1. Using the likelihood differences above for the BM and OU models fit to BM data, find the likelihood difference in the 5th percentile
## 2. Compute the likelihood difference between the BM model fit to the OU data and the OU model fit to the OU data for all simulated datasets
## 3. The number of likelihood differences computed in step #2 that are larger than the 5th percentile likelihood difference divided by the total number of simulated datasets gives an estimate of the power of the test
(((-2*(fit_bm_model_to_oum_data_gmpd$logLik - fit_oum_model_to_oum_data_gmpd$logLik)) > sort(-2*(fit_bm_model_to_bm_data_gmpd$logLik-fit_oum_model_to_bm_data_gmpd$logLik))[950]) %>% sum)/1000 -> power_to_reject_bm_gmpd #1

(((-2*(fit_bm_model_to_oum_data_remove_gmpd$logLik - fit_oum_model_to_oum_data_remove_gmpd$logLik)) > sort(-2*(fit_bm_model_to_bm_data_remove_gmpd$logLik-fit_oum_model_to_bm_data_remove_gmpd$logLik))[950]) %>% sum)/1000 -> power_to_reject_bm_remove_gmpd #0.995

(((-2*(fit_bm_model_to_oum_data_nearctic$logLik - fit_oum_model_to_oum_data_nearctic$logLik)) > sort(-2*(fit_bm_model_to_bm_data_nearctic$logLik-fit_oum_model_to_bm_data_nearctic$logLik))[950]) %>% sum)/1000 -> power_to_reject_bm_nearctic #1

(((-2*(fit_bm_model_to_oum_data_remove_nearctic$logLik - fit_oum_model_to_oum_data_remove_nearctic$logLik)) > sort(-2*(fit_bm_model_to_bm_data_remove_nearctic$logLik-fit_oum_model_to_bm_data_remove_nearctic$logLik))[950]) %>% sum)/1000 -> power_to_reject_bm_remove_nearctic #1


## Computing the power of a test that rejects the OU1 model with a false positive rate of 5%
## 1. Using the likelihood differences above for the OU1 and OUM models fit to OU1 data, find the likelihood difference in the 5th percentile
## 2. Compute the likelihood difference between the OU1 model fit to the OUM data and the OUM model fit to the OUM data for all simulated datasets
## 3. The number of likelihood differences computed in step #2 that are larger than the 5th percentile likelihood difference divided by the total number of simulated datasets gives an estimate of the power of the test
(((-2*(fit_ou1_model_to_oum_data_gmpd$logLik - fit_oum_model_to_oum_data_gmpd$logLik)) > sort(-2*(fit_ou1_model_to_ou1_data_gmpd$logLik-fit_oum_model_to_ou1_data_gmpd$logLik))[950]) %>% sum)/1000 -> power_to_reject_ou1_gmpd # 0.959

(((-2*(fit_ou1_model_to_oum_data_remove_gmpd$logLik - fit_oum_model_to_oum_data_remove_gmpd$logLik)) > sort(-2*(fit_ou1_model_to_ou1_data_remove_gmpd$logLik-fit_oum_model_to_ou1_data_remove_gmpd$logLik))[950]) %>% sum)/1000 -> power_to_reject_ou1_remove_gmpd #0.652

(((-2*(fit_ou1_model_to_oum_data_nearctic$logLik - fit_oum_model_to_oum_data_nearctic$logLik)) > sort(-2*(fit_ou1_model_to_ou1_data_nearctic$logLik-fit_oum_model_to_ou1_data_nearctic$logLik))[950]) %>% sum)/1000 -> power_to_reject_ou1_nearctic # 0.959

(((-2*(fit_ou1_model_to_oum_data_remove_nearctic$logLik - fit_oum_model_to_oum_data_remove_nearctic$logLik)) > sort(-2*(fit_ou1_model_to_ou1_data_remove_nearctic$logLik-fit_oum_model_to_ou1_data_remove_nearctic$logLik))[950]) %>% sum)/1000 -> power_to_reject_ou1_remove_nearctic #0.997
```

#Plotting the likelihood ratio distributions for BM versus OU(3). 
```{r plot_bm_vs_oum, fig.height=4, fig.width=5, units='in', res=300}

## Plot the distributions of likelihood differences between BM and OUM for the four different datasets
par(mar=c(3,3,2,1), oma=rep(0,4), mfrow=c(2,2))
## GMPD
delta <- -2*(gmpd_bm_ouch@loglik - gmpd_oum_ouch@loglik)
delta.dist <- -2*(fit_bm_model_to_bm_data_gmpd$logLik - fit_oum_model_to_bm_data_gmpd$logLik)
delta.dist.2 <- -2*(fit_bm_model_to_oum_data_gmpd$logLik - fit_oum_model_to_oum_data_gmpd$logLik)
d1 <- density(delta.dist)
d2 <- density(delta.dist.2)
plot.new()
plot.window(xlim=range(c(d1$x,d2$x)), ylim=range(c(d1$y,d2$y)))
axis(1);axis(2);box('plot')
mtext(side=1, line=2, expression(delta))
mtext(side=2, line=2, 'Density')
mtext(side=3, line=0.25, "GMPD")
lines(d1$x, d1$y, col=gray(0.7))
with(d1, polygon(x=c(min(x), x[x<max(x)], rev(x[x<max(x)]), min(x)), y=c(0, 0*x[x<max(x)], rev(y[x<max(x)]), 0), col=gray(0.7, alpha=0.5)))
lines(d2$x, d2$y, col=gray(0.2))
with(d2, polygon(x=c(min(x), x[x<max(x)], rev(x[x<max(x)]), min(x)), y=c(0, 0*x[x<max(x)], rev(y[x<max(x)]), 0), col=gray(0.2, alpha=0.5)))
abline(v=delta, lwd=2, lty=2)
legend(x='topright', c('BM','OU3'), fill=c(gray(0.7),gray(0.2)), bty='n', cex=0.75)

delta <- -2*(remove_gmpd_bm_ouch@loglik - remove_gmpd_oum_ouch@loglik)
delta.dist <- -2*(fit_bm_model_to_bm_data_remove_gmpd$logLik - fit_oum_model_to_bm_data_remove_gmpd$logLik)
delta.dist.2 <- -2*(fit_bm_model_to_oum_data_remove_gmpd$logLik - fit_oum_model_to_oum_data_remove_gmpd$logLik)
d1 <- density(delta.dist)
d2 <- density(delta.dist.2)
plot.new()
plot.window(xlim=range(c(d1$x,d2$x)), ylim=range(c(d1$y,d2$y)))
axis(1);axis(2);box('plot')
mtext(side=1, line=2, expression(delta))
mtext(side=2, line=2, 'Density')
mtext(side=3, line=0.25, "GMPD (no single host)")
lines(d1$x, d1$y, col=gray(0.7))
with(d1, polygon(x=c(min(x), x[x<max(x)], rev(x[x<max(x)]), min(x)), y=c(0, 0*x[x<max(x)], rev(y[x<max(x)]), 0), col=gray(0.7, alpha=0.5)))
lines(d2$x, d2$y, col=gray(0.2))
with(d2, polygon(x=c(min(x), x[x<max(x)], rev(x[x<max(x)]), min(x)), y=c(0, 0*x[x<max(x)], rev(y[x<max(x)]), 0), col=gray(0.2, alpha=0.5)))
abline(v=delta, lwd=2, lty=2)

delta <- -2*(nearctic_bm_ouch@loglik - nearctic_oum_ouch@loglik)
delta.dist <- -2*(fit_bm_model_to_bm_data_nearctic$logLik - fit_oum_model_to_bm_data_nearctic$logLik)
delta.dist.2 <- -2*(fit_bm_model_to_oum_data_nearctic$logLik - fit_oum_model_to_oum_data_nearctic$logLik)
d1 <- density(delta.dist)
d2 <- density(delta.dist.2)
plot.new()
plot.window(xlim=range(c(d1$x,d2$x)), ylim=range(c(d1$y,d2$y)))
axis(1);axis(2);box('plot')
mtext(side=1, line=2, expression(delta))
mtext(side=2, line=2, 'Density')
mtext(side=3, line=0.25, "Nearctic")
lines(d1$x, d1$y, col=gray(0.7))
with(d1, polygon(x=c(min(x), x[x<max(x)], rev(x[x<max(x)]), min(x)), y=c(0, 0*x[x<max(x)], rev(y[x<max(x)]), 0), col=gray(0.7, alpha=0.5)))
lines(d2$x, d2$y, col=gray(0.2))
with(d2, polygon(x=c(min(x), x[x<max(x)], rev(x[x<max(x)]), min(x)), y=c(0, 0*x[x<max(x)], rev(y[x<max(x)]), 0), col=gray(0.2, alpha=0.5)))
abline(v=delta, lwd=2, lty=2)

delta <- -2*(remove_nearctic_bm_ouch@loglik - remove_nearctic_oum_ouch@loglik)
delta.dist <- -2*(fit_bm_model_to_bm_data_remove_nearctic$logLik - fit_oum_model_to_bm_data_remove_nearctic$logLik)
delta.dist.2 <- -2*(fit_bm_model_to_oum_data_remove_nearctic$logLik - fit_oum_model_to_oum_data_remove_nearctic$logLik)
d1 <- density(delta.dist)
d2 <- density(delta.dist.2)
plot.new()
plot.window(xlim=range(c(d1$x,d2$x)), ylim=range(c(d1$y,d2$y)))
axis(1);axis(2);box('plot')
mtext(side=1, line=2, expression(delta))
mtext(side=2, line=2, 'Density')
mtext(side=3, line=0.25, "Nearctic (no single host)")
lines(d1$x, d1$y, col=gray(0.7))
with(d1, polygon(x=c(min(x), x[x<max(x)], rev(x[x<max(x)]), min(x)), y=c(0, 0*x[x<max(x)], rev(y[x<max(x)]), 0), col=gray(0.7, alpha=0.5)))
lines(d2$x, d2$y, col=gray(0.2))
with(d2, polygon(x=c(min(x), x[x<max(x)], rev(x[x<max(x)]), min(x)), y=c(0, 0*x[x<max(x)], rev(y[x<max(x)]), 0), col=gray(0.2, alpha=0.5)))
abline(v=delta, lwd=2, lty=2)

```


#Plotting the likelihood ratio distributions for OU(1) versus OU(3). 
```{r plot_ou1_vs_oum, fig.height=4, fig.width=5, units='in', res=300}

## Plot the distributions of likelihood differences between ou1 and OUM for the four different datasets
par(mar=c(3,3,2,1), oma=rep(0,4), mfrow=c(2,2))
## GMPD
delta <- -2*(gmpd_ou1_ouch@loglik - gmpd_oum_ouch@loglik)
delta.dist <- -2*(fit_ou1_model_to_ou1_data_gmpd$logLik - fit_oum_model_to_ou1_data_gmpd$logLik)
delta.dist.2 <- -2*(fit_ou1_model_to_oum_data_gmpd$logLik - fit_oum_model_to_oum_data_gmpd$logLik)
d1 <- density(delta.dist)
d2 <- density(delta.dist.2)
plot.new()
plot.window(xlim=range(c(d1$x,d2$x)), ylim=range(c(d1$y,d2$y)))
axis(1);axis(2);box('plot')
mtext(side=1, line=2, expression(delta))
mtext(side=2, line=2, 'Density')
mtext(side=3, line=0.25, "GMPD")
lines(d1$x, d1$y, col=gray(0.7))
with(d1, polygon(x=c(min(x), x[x<max(x)], rev(x[x<max(x)]), min(x)), y=c(0, 0*x[x<max(x)], rev(y[x<max(x)]), 0), col=gray(0.7, alpha=0.5)))
lines(d2$x, d2$y, col=gray(0.2))
with(d2, polygon(x=c(min(x), x[x<max(x)], rev(x[x<max(x)]), min(x)), y=c(0, 0*x[x<max(x)], rev(y[x<max(x)]), 0), col=gray(0.2, alpha=0.5)))
abline(v=delta, lwd=2, lty=2)
legend(x='topright', c('OU1','OU3'), fill=c(gray(0.7),gray(0.2)), bty='n', cex=0.75)

delta <- -2*(remove_gmpd_ou1_ouch@loglik - remove_gmpd_oum_ouch@loglik)
delta.dist <- -2*(fit_ou1_model_to_ou1_data_remove_gmpd$logLik - fit_oum_model_to_ou1_data_remove_gmpd$logLik)
delta.dist.2 <- -2*(fit_ou1_model_to_oum_data_remove_gmpd$logLik - fit_oum_model_to_oum_data_remove_gmpd$logLik)
d1 <- density(delta.dist)
d2 <- density(delta.dist.2)
plot.new()
plot.window(xlim=range(c(d1$x,d2$x)), ylim=range(c(d1$y,d2$y)))
axis(1);axis(2);box('plot')
mtext(side=1, line=2, expression(delta))
mtext(side=2, line=2, 'Density')
mtext(side=3, line=0.25, "GMPD (no single host)")
lines(d1$x, d1$y, col=gray(0.7))
with(d1, polygon(x=c(min(x), x[x<max(x)], rev(x[x<max(x)]), min(x)), y=c(0, 0*x[x<max(x)], rev(y[x<max(x)]), 0), col=gray(0.7, alpha=0.5)))
lines(d2$x, d2$y, col=gray(0.2))
with(d2, polygon(x=c(min(x), x[x<max(x)], rev(x[x<max(x)]), min(x)), y=c(0, 0*x[x<max(x)], rev(y[x<max(x)]), 0), col=gray(0.2, alpha=0.5)))
abline(v=delta, lwd=2, lty=2)

delta <- -2*(nearctic_ou1_ouch@loglik - nearctic_oum_ouch@loglik)
delta.dist <- -2*(fit_ou1_model_to_ou1_data_nearctic$logLik - fit_oum_model_to_ou1_data_nearctic$logLik)
delta.dist.2 <- -2*(fit_ou1_model_to_oum_data_nearctic$logLik - fit_oum_model_to_oum_data_nearctic$logLik)
d1 <- density(delta.dist)
d2 <- density(delta.dist.2)
plot.new()
plot.window(xlim=range(c(d1$x,d2$x)), ylim=range(c(d1$y,d2$y)))
axis(1);axis(2);box('plot')
mtext(side=1, line=2, expression(delta))
mtext(side=2, line=2, 'Density')
mtext(side=3, line=0.25, "Nearctic")
lines(d1$x, d1$y, col=gray(0.7))
with(d1, polygon(x=c(min(x), x[x<max(x)], rev(x[x<max(x)]), min(x)), y=c(0, 0*x[x<max(x)], rev(y[x<max(x)]), 0), col=gray(0.7, alpha=0.5)))
lines(d2$x, d2$y, col=gray(0.2))
with(d2, polygon(x=c(min(x), x[x<max(x)], rev(x[x<max(x)]), min(x)), y=c(0, 0*x[x<max(x)], rev(y[x<max(x)]), 0), col=gray(0.2, alpha=0.5)))
abline(v=delta, lwd=2, lty=2)

delta <- -2*(remove_nearctic_ou1_ouch@loglik - remove_nearctic_oum_ouch@loglik)
delta.dist <- -2*(fit_ou1_model_to_ou1_data_remove_nearctic$logLik - fit_oum_model_to_ou1_data_remove_nearctic$logLik)
delta.dist.2 <- -2*(fit_ou1_model_to_oum_data_remove_nearctic$logLik - fit_oum_model_to_oum_data_remove_nearctic$logLik)
d1 <- density(delta.dist)
d2 <- density(delta.dist.2)
plot.new()
plot.window(xlim=range(c(d1$x,d2$x)), ylim=range(c(d1$y,d2$y)))
axis(1);axis(2);box('plot')
mtext(side=1, line=2, expression(delta))
mtext(side=2, line=2, 'Density')
mtext(side=3, line=0.25, "Nearctic (no single host)")
lines(d1$x, d1$y, col=gray(0.7))
with(d1, polygon(x=c(min(x), x[x<max(x)], rev(x[x<max(x)]), min(x)), y=c(0, 0*x[x<max(x)], rev(y[x<max(x)]), 0), col=gray(0.7, alpha=0.5)))
lines(d2$x, d2$y, col=gray(0.2))
with(d2, polygon(x=c(min(x), x[x<max(x)], rev(x[x<max(x)]), min(x)), y=c(0, 0*x[x<max(x)], rev(y[x<max(x)]), 0), col=gray(0.2, alpha=0.5)))
abline(v=delta, lwd=2, lty=2)

```

#Summary Table for Evolution Models
```{r OU_summary_tables, echo=TRUE}

###NEARCTIC DATASET####

##with single host species MPD = 0
tibble(model=c("BM","OU1","OU3"),
       aicc=c(summary(nearctic_bm_ouch)$aic.c, 
              summary(nearctic_ou1_ouch)$aic.c,
              summary(nearctic_oum_ouch)$aic.c)
       ) %>% 
  mutate(deltaaicc=aicc-min(aicc), 
         pow=exp(-.5*deltaaicc),
         sumpow=sum(pow),
         waicc=pow/sumpow) %>%
  dplyr::select(c(1,2,3,6)) %>%
  arrange(desc(waicc)) -> nearctic_aic_OU
nearctic_aic_OU

##with single host species removed
tibble(model=c("BM","OU1","OU3"),
       aicc=c(summary(remove_nearctic_bm_ouch)$aic.c, 
              summary(remove_nearctic_ou1_ouch)$aic.c,
              summary(remove_nearctic_oum_ouch)$aic.c)
       ) %>% 
  mutate(deltaaicc=aicc-min(aicc), 
         pow=exp(-.5*deltaaicc),
         sumpow=sum(pow),
         waicc=pow/sumpow) %>%
  dplyr::select(c(1,2,3,6)) %>%
  arrange(desc(waicc)) -> remove_nearctic_aic_OU
remove_nearctic_aic_OU

###GMPD DATASET####

##with single host species MPD = 0
tibble(model=c("BM","OU1","OU3"),
       aicc=c(summary(gmpd_bm_ouch)$aic.c, 
              summary(gmpd_ou1_ouch)$aic.c,
              summary(gmpd_oum_ouch)$aic.c)
       ) %>% 
  mutate(deltaaicc=aicc-min(aicc), 
         pow=exp(-.5*deltaaicc),
         sumpow=sum(pow),
         waicc=pow/sumpow) %>%
  dplyr::select(c(1,2,3,6)) %>%
  arrange(desc(waicc)) -> gmpd_aic_OU
gmpd_aic_OU

##with single host species removed
tibble(model=c("BM","OU1","OU3"),
       aicc=c(summary(remove_gmpd_bm_ouch)$aic.c, 
              summary(remove_gmpd_ou1_ouch)$aic.c,
              summary(remove_gmpd_oum_ouch)$aic.c)
       ) %>% 
  mutate(deltaaicc=aicc-min(aicc), 
         pow=exp(-.5*deltaaicc),
         sumpow=sum(pow),
         waicc=pow/sumpow) %>%
  dplyr::select(c(1,2,3,6)) %>%
  arrange(desc(waicc)) -> remove_gmpd_aic_OU
remove_gmpd_aic_OU


## Here are the confidence intervals for the parameters of the best-fitting model, based on the parametric bootstrap
c("Dataset", "alpha", "sigma.sq", "Acanthocephalans", "Nematodes", "Platyhelminthes",
  "Nearctic",
  paste0(signif(nearctic_oum_ouch@sqrt.alpha^2,3), " (",
         signif(sort(fit_oum_model_to_oum_data_nearctic$alpha)[25],3), ", ",
         signif(sort(fit_oum_model_to_oum_data_nearctic$alpha)[975],3), ")"), 
  paste0(signif(nearctic_oum_ouch@sigma^2,3), " (",
         signif(sort(fit_oum_model_to_oum_data_nearctic$sigma.sq)[25],3), ", ",
         signif(sort(fit_oum_model_to_oum_data_nearctic$sigma.sq)[975],3), ")"), 
  paste0(signif(nearctic_oum_ouch@theta$nearctic_parasite_ouchdata[1],3) %>% unname, " (",
         signif(sort(fit_oum_model_to_oum_data_nearctic$Acanths)[25],3), ", ",
         signif(sort(fit_oum_model_to_oum_data_nearctic$Acanths)[975],3), ")"),
  paste0(signif(nearctic_oum_ouch@theta$nearctic_parasite_ouchdata[2],3) %>% unname, " (",
         signif(sort(fit_oum_model_to_oum_data_nearctic$Nematodes)[25],3), ", ",
         signif(sort(fit_oum_model_to_oum_data_nearctic$Nematodes)[975],3), ")"),
  paste0(signif(nearctic_oum_ouch@theta$nearctic_parasite_ouchdata[3],3) %>% unname, " (",
         signif(sort(fit_oum_model_to_oum_data_nearctic$Platys)[25],3), ", ",
         signif(sort(fit_oum_model_to_oum_data_nearctic$Platys)[975],3), ")"),
  "Nearctic (no specialists)",
  paste0(signif(remove_nearctic_oum_ouch@sqrt.alpha^2,3), " (",
         signif(sort(fit_oum_model_to_oum_data_remove_nearctic$alpha)[25],3), ", ",
         signif(sort(fit_oum_model_to_oum_data_remove_nearctic$alpha)[975],3), ")"), 
  paste0(signif(remove_nearctic_oum_ouch@sigma^2,3), " (",
         signif(sort(fit_oum_model_to_oum_data_remove_nearctic$sigma.sq)[25],3), ", ",
         signif(sort(fit_oum_model_to_oum_data_remove_nearctic$sigma.sq)[975],3), ")"), 
  paste0(signif(remove_nearctic_oum_ouch@theta$remove_nearctic_ouchdata[1],3) %>% unname, " (",
         signif(sort(fit_oum_model_to_oum_data_remove_nearctic$Acanths)[25],3), ", ",
         signif(sort(fit_oum_model_to_oum_data_remove_nearctic$Acanths)[975],3), ")"),
  paste0(signif(remove_nearctic_oum_ouch@theta$remove_nearctic_ouchdata[2],3) %>% unname, " (",
         signif(sort(fit_oum_model_to_oum_data_remove_nearctic$Nematodes)[25],3), ", ",
         signif(sort(fit_oum_model_to_oum_data_remove_nearctic$Nematodes)[975],3), ")"),
  paste0(signif(remove_nearctic_oum_ouch@theta$remove_nearctic_ouchdata[3],3) %>% unname, " (",
         signif(sort(fit_oum_model_to_oum_data_remove_nearctic$Platys)[25],3), ", ",
         signif(sort(fit_oum_model_to_oum_data_remove_nearctic$Platys)[975],3), ")"),
  "GMPD",
  paste0(signif(gmpd_oum_ouch@sqrt.alpha^2,3), " (",
         signif(sort(fit_oum_model_to_oum_data_gmpd$alpha)[25],3), ", ",
         signif(sort(fit_oum_model_to_oum_data_gmpd$alpha)[975],3), ")"), 
  paste0(signif(gmpd_oum_ouch@sigma^2,3), " (",
         signif(sort(fit_oum_model_to_oum_data_gmpd$sigma.sq)[25],3), ", ",
         signif(sort(fit_oum_model_to_oum_data_gmpd$sigma.sq)[975],3), ")"), 
  paste0(signif(gmpd_oum_ouch@theta$gmpd_ouchdata[1],3) %>% unname, " (",
         signif(sort(fit_oum_model_to_oum_data_gmpd$Acanths)[25],3), ", ",
         signif(sort(fit_oum_model_to_oum_data_gmpd$Acanths)[975],3), ")"),
  paste0(signif(gmpd_oum_ouch@theta$gmpd_ouchdata[2],3) %>% unname, " (",
         signif(sort(fit_oum_model_to_oum_data_gmpd$Nematodes)[25],3), ", ",
         signif(sort(fit_oum_model_to_oum_data_gmpd$Nematodes)[975],3), ")"),
  paste0(signif(gmpd_oum_ouch@theta$gmpd_ouchdata[3],3) %>% unname, " (",
         signif(sort(fit_oum_model_to_oum_data_gmpd$Platys)[25],3), ", ",
         signif(sort(fit_oum_model_to_oum_data_gmpd$Platys)[975],3), ")"),
  "GMPD (no specialists)",
  paste0(signif(remove_gmpd_oum_ouch@sqrt.alpha^2,3), " (",
         signif(sort(fit_oum_model_to_oum_data_remove_gmpd$alpha)[25],3), ", ",
         signif(sort(fit_oum_model_to_oum_data_remove_gmpd$alpha)[975],3), ")"), 
  paste0(signif(remove_gmpd_oum_ouch@sigma^2,3), " (",
         signif(sort(fit_oum_model_to_oum_data_remove_gmpd$sigma.sq)[25],3), ", ",
         signif(sort(fit_oum_model_to_oum_data_remove_gmpd$sigma.sq)[975],3), ")"), 
  paste0(signif(remove_gmpd_oum_ouch@theta$remove_gmpd_ouchdata[1],3) %>% unname, " (",
         signif(sort(fit_oum_model_to_oum_data_remove_gmpd$Acanths)[25],3), ", ",
         signif(sort(fit_oum_model_to_oum_data_remove_gmpd$Acanths)[975],3), ")"),
  paste0(signif(remove_gmpd_oum_ouch@theta$remove_gmpd_ouchdata[2],3) %>% unname, " (",
         signif(sort(fit_oum_model_to_oum_data_remove_gmpd$Nematodes)[25],3), ", ",
         signif(sort(fit_oum_model_to_oum_data_remove_gmpd$Nematodes)[975],3), ")"),
  paste0(signif(remove_gmpd_oum_ouch@theta$remove_gmpd_ouchdata[3],3) %>% unname, " (",
         signif(sort(fit_oum_model_to_oum_data_remove_gmpd$Platys)[25],3), ", ",
         signif(sort(fit_oum_model_to_oum_data_remove_gmpd$Platys)[975],3), ")")
) %>% matrix(., ncol=6, byrow=TRUE) -> parameter_estimates
parameter_estimates
  


###Table Order: Nearctic_0, Nearctic_Removed, Global_0, Global_Removed
```

#Adding Trait data
```{r adding_and_cleaning_host_and_parasite_trait_data, echo = TRUE}
#### Load parasite body size data from Benesh, Lafferty, and Kuris 2017 ####
## Length and width measurments are in mm 
benesh_data_para<- read_csv("Benesh_et_al_2017/ecy1680-sup-0001-datas1/CLC_database_lifehistory.csv")
benesh_data_para$Host.species <-gsub(" ", "_", benesh_data_para$Host.species)

## remove parasites from Benesh et al. dataset that don't exist in the phylogeny
setdiff(benesh_data_para$Parasite.species, gmpd_data$ParasiteCorrectedName)->nothanks
benesh_data_para[-which(benesh_data_para$Parasite.species %in% nothanks) ,] -> b_para_subset

## average the body size for rows that are the same species
subset(b_para_subset, Sex=="f") %>%
  group_by(Parasite.species) %>%
  summarise(mean_l=mean(Length, na.rm = TRUE)) ->data_fem_len

subset(b_para_subset, Sex=="f") %>%
  group_by(Parasite.species) %>%
  summarise(mean_w=mean(Width, na.rm = TRUE)) ->data_fem_wid

## combine length and width to calculate 'body size' (L*W)?
b.size<-left_join(data_fem_len, data_fem_wid, by="Parasite.species")
b.size$ratio<-(b.size$mean_l*b.size$mean_w)

write.csv(b.size, "bodysizepara.csv")


#### Trim the tree to include only those parasite species for which there is body size data ####

##nearctic mpd, single host = 0 
setdiff(nearctic_parasite_tree$tip.label, b.size$Parasite.species)->no_body_size 
nearctic_pgls <- drop.tip(nearctic_parasite_tree, nearctic_parasite_tree$tip.label[which(nearctic_parasite_tree$tip.label%in%no_body_size)])

# make sure body size is in the same order as the parasite phylogeny
nearctic.b.size <- b.size[match(nearctic_pgls$tip.label, b.size$Parasite.species),]


##nearctic mpd, single host removed 
setdiff(no_specialists_nearctic_parasite_tree$tip.label, b.size$Parasite.species)->no_body_size1 
remove_nearctic_pgls <- drop.tip(no_specialists_nearctic_parasite_tree, no_specialists_nearctic_parasite_tree$tip.label[which(no_specialists_nearctic_parasite_tree$tip.label%in%no_body_size1)])

# make sure body size is in the same order as the parasite phylogeny
remove.nearctic.b.size <- b.size[match(remove_nearctic_pgls$tip.label, b.size$Parasite.species),]


##global mpd, single host = 0 
setdiff(gmpd_parasite_tree$tip.label, b.size$Parasite.species)->no_body_size2 
gmpd_pgls <- drop.tip(gmpd_parasite_tree, gmpd_parasite_tree$tip.label[which(gmpd_parasite_tree$tip.label%in%no_body_size2)])

# make sure body size is in the same order as the parasite phylogeny
gmpd.b.size <- b.size[match(gmpd_pgls$tip.label, b.size$Parasite.species),]

##global mpd, single host removed
setdiff(no_specialists_gmpd_parasite_tree$tip.label, b.size$Parasite.species)->no_body_size3 
remove_gmpd_pgls <- drop.tip(no_specialists_gmpd_parasite_tree, no_specialists_gmpd_parasite_tree$tip.label[which(no_specialists_gmpd_parasite_tree$tip.label%in%no_body_size3)])

# make sure body size is in the same order as the parasite phylogeny
remove.gmpd.b.size <- b.size[match(remove_gmpd_pgls$tip.label, b.size$Parasite.species),]



#### adding in host trait data (mass.g) from PHYLACINE ####
#Faurby, S., Davis, M., Pedersen, R. ., Schowanek, S. D., Antonelli, A., & Svenning, J.C. (In Press). PHYLACINE 1.2: The Phylogenetic Atlas of Mammal Macroecology. Ecology
#load mammal data
Trait_data <- read_csv("Trait_data.csv")

#correct for spaces in the binomial names
Trait_data$Binomial.1.2<-gsub("_", " ", Trait_data$Binomial.1.2)

#make column called "Host" in Trait_data
Trait_data$HostCorrectedName<-Trait_data$Binomial.1.2

#merge 
left_join(gmpd_data, Trait_data, by = "HostCorrectedName")->ss
host_trait_data<-data.frame("Parasite" = ss$ParasiteCorrectedName,
                            "Host" = ss$HostCorrectedName, 
                            "Mass.g" = ss$Mass.g)



host_trait_data %>% 
  group_by(Parasite) %>% 
  summarise(avgMass=mean(Mass.g,na.rm=T)) -> Host_mass


##subset host data for each group

#nearctic with single hosts = 0
setdiff(Host_mass$Parasite, nearctic_pgls$tip.label)-> getout
nearctic_traits<-Host_mass[-which(Host_mass$Parasite %in% getout),]
#put in tree tip label order
nearctic_traits <- nearctic_traits[match(nearctic_pgls$tip.label, nearctic_traits$Parasite),]


#nearctic with single hosts removed
setdiff(Host_mass$Parasite, remove_nearctic_pgls$tip.label)-> getout1
remove_nearctic_traits<-Host_mass[-which(Host_mass$Parasite %in% getout1),]
#put in tree tip label order
remove_nearctic_traits <- remove_nearctic_traits[match(remove_nearctic_pgls$tip.label, remove_nearctic_traits$Parasite),]


#gmpd with single hosts = 0
gmpd_traits<-Host_mass
#put in tree tip label order
gmpd_traits <- gmpd_traits[match(gmpd_pgls$tip.label, gmpd_traits$Parasite),]


#gmpd with single hosts removed
setdiff(Host_mass$Parasite, remove_gmpd_pgls$tip.label)-> getout2
remove_gmpd_traits<-Host_mass[-which(Host_mass$Parasite %in% getout2),]
#put in tree tip label order
remove_gmpd_traits <- remove_gmpd_traits[match(remove_gmpd_pgls$tip.label, remove_gmpd_traits$Parasite),]


#### clean parasite transmission data ####

#nearctic with single hosts = 0
nearctic_trans<-gmpd_parasite_data[which(gmpd_parasite_data$CorrectName %in% nearctic_pgls$tip.label),]
nearctic_trans<-nearctic_trans[match(nearctic_pgls$tip.label, nearctic_trans$CorrectName),]

#neartic with single species removed
remove_nearctic_trans<-gmpd_parasite_data[which(gmpd_parasite_data$CorrectName %in% remove_nearctic_pgls$tip.label),]
remove_nearctic_trans<-remove_nearctic_trans[match(remove_nearctic_pgls$tip.label, remove_nearctic_trans$CorrectName),]


#gmpd with single hosts = 0
gmpd_trans<-gmpd_parasite_data[which(gmpd_parasite_data$CorrectName %in% gmpd_pgls$tip.label),]
gmpd_trans<-gmpd_trans[match(gmpd_pgls$tip.label, gmpd_trans$CorrectName),]

#gmpd with single species removed
remove_gmpd_trans<-gmpd_parasite_data[which(gmpd_parasite_data$CorrectName %in% remove_gmpd_pgls$tip.label),]
remove_gmpd_trans<-remove_gmpd_trans[match(remove_gmpd_pgls$tip.label, remove_gmpd_trans$CorrectName),]

```

#PGLS of Nearctic 
```{r pgls_nearctic_sh0, include = FALSE}

###NEARCTIC DATASET####

##with single host species MPD = 0

#calculate a sum of host publications for each parasite 
nearctic_host_sums<-vector("numeric", length=nrow(nearctic_df))
for (p.index in 1:nrow (nearctic_df)) {
  host.index <- unlist(nearctic_df[p.index,])
  host.names <- names(host.index)[which(host.index > 0)]
  nearctic_host_sums[p.index] <- sum(nearctic_host_pubs[nearctic_host_pubs$term%in%host.names,"pubs"])
}
#add parasite names to each sum of host publications
names(nearctic_host_sums)<-nearctic_para_list

# prepare transmission data
nearctic_transmission<-gmpd_parasite_data[which(gmpd_parasite_data$CorrectName %in% nearctic_parasite_tree$tip.label),]
nearctic_transmission<-nearctic_transmission[match(nearctic_parasite_tree$tip.label, nearctic_transmission$CorrectName),]

#### All species ####

dat<-data.frame(taxa=nearctic_parasite_tree$tip.label,
                para.mpd=nearctic_para_mpd,              #mpd
                log.pubs=log(nearctic_para_pubs$pubs + nearctic_host_sums), #research bias log(total no. of hits pubmed)
                close=as.factor(nearctic_transmission$close),
                env=as.factor(nearctic_transmission$nonclose),
                intermediate=as.factor(nearctic_transmission$intermediate))

cdat<-comparative.data(data=dat, phy=nearctic_parasite_tree, names.col = "taxa")

summary(pgls(para.mpd ~ log.pubs + close + env + intermediate, cdat, lambda = .363))
anova(pgls(para.mpd ~ log.pubs + close + env + intermediate, cdat, lambda = .363))
plot(pgls(para.mpd ~ log.pubs + close + env + intermediate, cdat, lambda = .363))

#### Dataset that includes parasite traits (length), subsets to 33 species ####
#create pgls data from nearctic_para_mpd
pgls_nearctic_para_mpd<-nearctic_para_mpd[match(nearctic_pgls$tip.label, names(nearctic_para_mpd))]

#create pgls data for research effort
pgls_nearctic_para_pubs<-nearctic_para_pubs$pubs[match(nearctic_pgls$tip.label, nearctic_para_pubs$term)]

#create pgls data for sum of host publications per parasite
pgls_nearctic_host_pubs<-nearctic_host_sums[match(nearctic_pgls$tip.label, names(nearctic_host_sums))]


#create pgls dataset 
nearctic_dat<-data.frame(taxa=nearctic_pgls$tip.label,
                para.mpd=pgls_nearctic_para_mpd,              #mpd
                log.pubs=log(pgls_nearctic_para_pubs +pgls_nearctic_host_pubs),
                para.l=nearctic.b.size$mean_l,                #parasite length
                para.w=nearctic.b.size$mean_w,                #parasite width
                para.b=nearctic.b.size$ratio,                 #parasite l/w ratio
                close=as.factor(nearctic_trans$close),
                nonclose=as.factor(nearctic_trans$nonclose),
                intermediate=as.factor(nearctic_trans$intermediate),
                host_mass=nearctic_traits$avgMass)

## constructs the data.frame of the taxa names and data in the order of the tree tips
nearctic_cdat<-comparative.data(data=nearctic_dat, phy=nearctic_pgls, names.col = "taxa")
print(nearctic_cdat)

## model testing ##

#all predictors
nearctic_mod <- pgls(para.mpd ~ log.pubs + close + nonclose + intermediate + para.l + host_mass, nearctic_cdat, lambda = .363)
summary(nearctic_mod)
anova(nearctic_mod)

```

```{r pgls_nearctic_shR, include=FALSE}
###NEARCTIC DATASET####

##with single host species removed

#subset nearctic parasite and host research effort sums to exclude single host species
remove_nearctic_host_sums<-nearctic_host_sums[which(names(nearctic_host_sums) %in% no_specialists_nearctic_parasite_tree$tip.label)]
remove_nearctic_host_sums<-remove_nearctic_host_sums[match(no_specialists_nearctic_parasite_tree$tip.label, names(remove_nearctic_host_sums))]

remove_nearctic_para_pubs<-nearctic_para_pubs[which(nearctic_para_pubs$term %in% no_specialists_nearctic_parasite_tree$tip.label),]
remove_nearctic_para_pubs<-remove_nearctic_para_pubs[match(no_specialists_nearctic_parasite_tree$tip.label, remove_nearctic_para_pubs$term),]

# prepare transmission data
remove_nearctic_transmission<-gmpd_parasite_data[which(gmpd_parasite_data$CorrectName %in% no_specialists_nearctic_parasite_tree$tip.label),]
remove_nearctic_transmission<-remove_nearctic_transmission[match(no_specialists_nearctic_parasite_tree$tip.label, remove_nearctic_transmission$CorrectName),]

#### All species ####

dat<-data.frame(taxa=no_specialists_nearctic_parasite_tree$tip.label,
                para.mpd=nearctic_para_mpd_no_specialists,              #mpd
                log.pubs=log(remove_nearctic_para_pubs$pubs + remove_nearctic_host_sums),
                close=as.factor(remove_nearctic_transmission$close),
                env=as.factor(remove_nearctic_transmission$nonclose),
                intermediate=as.factor(remove_nearctic_transmission$intermediate))

cdat<-comparative.data(data=dat, phy=no_specialists_nearctic_parasite_tree, names.col = "taxa")

summary(pgls(para.mpd ~ log.pubs + close + env + intermediate, cdat, lambda = .904))
anova(pgls(para.mpd ~ log.pubs + close + env + intermediate, cdat, lambda = .904))
plot(pgls(para.mpd ~ log.pubs + close + env + intermediate, cdat, lambda = .904))

#### Dataset that includes parasite and host traits, species ####

#create pgls data from nearctic_para_mpd_no_specialists
pgls_remove_n_para_mpd<-nearctic_para_mpd_no_specialists[match(remove_nearctic_pgls$tip.label, names(nearctic_para_mpd_no_specialists))]

#create pgls data for research effort
pgls_remove_n_para_pubs<-nearctic_para_pubs$pubs[match(remove_nearctic_pgls$tip.label, nearctic_para_pubs$term)]

#create pgls data for sum of host publications per parasite
pgls_remove_n_host_pubs<-nearctic_host_sums[match(remove_nearctic_pgls$tip.label, names(nearctic_host_sums))]

remove_nearctic_dat<-data.frame(taxa=remove_nearctic_pgls$tip.label,
                para.mpd=pgls_remove_n_para_mpd,
                log.pubs=log(pgls_remove_n_para_pubs + pgls_remove_n_host_pubs),
                para.l=remove.nearctic.b.size$mean_l,
                para.w=remove.nearctic.b.size$mean_w,
                para.b=remove.nearctic.b.size$ratio,
                close=as.factor(remove_nearctic_trans$close),
                nonclose=as.factor(remove_nearctic_trans$nonclose),
                intermediate=as.factor(remove_nearctic_trans$intermediate),
                host_mass=remove_nearctic_traits$avgMass)

## constructs the data.frame of the taxa names and data in the order of the tree tips
remove_nearctic_cdat<-comparative.data(data=remove_nearctic_dat, phy=remove_nearctic_pgls, names.col = "taxa")
print(remove_nearctic_cdat)

## model testing ##

#all predictors 
remove_nearctic_mod <- pgls(para.mpd~ log.pubs + close + nonclose + intermediate +para.l + host_mass, remove_nearctic_cdat, lambda = .904)
summary(remove_nearctic_mod)
anova(remove_nearctic_mod)

```

#PGLS of GMPD
```{r pgls_global_sh0, include=FALSE}

##with single host species MPD = 0

#calculate a sum of host publications for each parasite 
gmpd_host_sums<-vector("numeric", length=nrow(gmpd_df))
for (p.index in 1:nrow (gmpd_df)) {
  host.index <- unlist(gmpd_df[p.index,])
  host.names <- names(host.index)[which(host.index > 0)]
  gmpd_host_sums[p.index] <- sum(gmpd_host_pubs[gmpd_host_pubs$term%in%host.names,"pubs"])
}
#add parasite names to each sum of host publications
names(gmpd_host_sums)<-gmpd_para_list

# prepare transmission data
gmpd_transmission<-gmpd_parasite_data[which(gmpd_parasite_data$CorrectName %in% gmpd_parasite_tree$tip.label),]
gmpd_transmission<-gmpd_transmission[match(gmpd_parasite_tree$tip.label, gmpd_transmission$CorrectName),]

#### All species ####
dat<-data.frame(taxa=gmpd_parasite_tree$tip.label,
                para.mpd=gmpd_para_mpd,              #mpd
                log.pubs=log(gmpd_para_pubs$pubs + gmpd_host_sums), #research bias log(total no. of hits pubmed)
                close=as.factor(gmpd_transmission$close),
                env=as.factor(gmpd_transmission$nonclose),
                intermediate=as.factor(gmpd_transmission$intermediate))

cdat<-comparative.data(data=dat, phy=gmpd_parasite_tree, names.col = "taxa")

summary(pgls(para.mpd ~ log.pubs + close + env + intermediate, cdat, lambda = .615))
anova(pgls(para.mpd ~ log.pubs + close + env + intermediate, cdat, lambda = .615))
plot(pgls(para.mpd ~ log.pubs + close + env + intermediate, cdat, lambda = .615))


#### Dataset that includes parasite and host traits , species ####

#create pgls data from gmpd_para_mpd
pgls_gmpd_para_mpd<-gmpd_para_mpd[match(gmpd_pgls$tip.label, names(gmpd_para_mpd))]

#create pgls data for research effort
pgls_gmpd_para_pubs<-corrected$pubs[match(gmpd_pgls$tip.label, corrected$term)]

#create pgls data for sum of host publications per parasite
pgls_gmpd_host_pubs<-gmpd_host_sums[match(gmpd_pgls$tip.label, names(gmpd_host_sums))]

gmpd_dat<-data.frame(taxa=gmpd_pgls$tip.label,
                para.mpd=pgls_gmpd_para_mpd,
                log.pubs=log(pgls_gmpd_para_pubs + pgls_gmpd_host_pubs),
                para.l=gmpd.b.size$mean_l,
                para.w=gmpd.b.size$mean_w,
                para.b=gmpd.b.size$ratio,
                close=as.factor(gmpd_trans$close),
                nonclose=as.factor(gmpd_trans$nonclose),
                intermediate=as.factor(gmpd_trans$intermediate),
                host_mass=gmpd_traits$avgMass)

## constructs the data.frame of the taxa names and data in the order of the tree tips
gmpd_cdat<-comparative.data(data=gmpd_dat, phy=gmpd_pgls, names.col = "taxa")
print(gmpd_cdat)

## model testing ##

#all predictors
gmpd_mod <- pgls(para.mpd~ log.pubs + close + nonclose + intermediate + para.l + host_mass, gmpd_cdat, lambda = "ML")
summary(gmpd_mod)
anova(gmpd_mod)
```


```{r pgls_global_shR, include = FALSE}
##with single host species removed

#subset nearctic parasite and host research effort sums to exclude single host species
remove_gmpd_host_sums<-gmpd_host_sums[which(names(gmpd_host_sums) %in% no_specialists_gmpd_parasite_tree$tip.label)]
remove_gmpd_host_sums<-remove_gmpd_host_sums[match(no_specialists_gmpd_parasite_tree$tip.label, names(remove_gmpd_host_sums))]

remove_gmpd_para_pubs<-gmpd_para_pubs[which(gmpd_para_pubs$term %in% no_specialists_gmpd_parasite_tree$tip.label),]
remove_gmpd_para_pubs<-remove_gmpd_para_pubs[match(no_specialists_gmpd_parasite_tree$tip.label, remove_gmpd_para_pubs$term),]

# prepare transmission data
remove_gmpd_transmission<-gmpd_parasite_data[which(gmpd_parasite_data$CorrectName %in% no_specialists_gmpd_parasite_tree$tip.label),]
remove_gmpd_transmission<-remove_gmpd_transmission[match(no_specialists_gmpd_parasite_tree$tip.label, remove_gmpd_transmission$CorrectName),]

#### All species (144) ####

dat<-data.frame(taxa=no_specialists_gmpd_parasite_tree$tip.label,
                para.mpd=gmpd_para_mpd_no_specialists,              #mpd
                log.pubs=log(remove_gmpd_para_pubs$pubs + remove_gmpd_host_sums),
                close=as.factor(remove_gmpd_transmission$close),
                env=as.factor(remove_gmpd_transmission$nonclose),
                intermediate=as.factor(remove_gmpd_transmission$intermediate))

cdat<-comparative.data(data=dat, phy=no_specialists_gmpd_parasite_tree, names.col = "taxa")


summary(pgls(para.mpd ~ log.pubs + close + env + intermediate, cdat, lambda = .896))
anova(pgls(para.mpd ~ log.pubs + close + env + intermediate, cdat, lambda = .896))
plot(pgls(para.mpd ~ log.pubs + close + env + intermediate, cdat, lambda = .896))

#### Dataset that includes parasite and host traits, 42 species ####

#create pgls data from gmpd_para_mpd_no_specialists
pgls_remove_g_para_mpd<-gmpd_para_mpd_no_specialists[match(remove_gmpd_pgls$tip.label, names(gmpd_para_mpd_no_specialists))]

#create pgls data for research effort
pgls_remove_g_para_pubs<-gmpd_para_pubs$pubs[match(remove_gmpd_pgls$tip.label, gmpd_para_pubs$term)]

#create pgls data for sum of host publications per parasite
pgls_remove_g_host_pubs<-gmpd_host_sums[match(remove_gmpd_pgls$tip.label, names(gmpd_host_sums))]

remove_gmpd_dat<-data.frame(taxa=remove_gmpd_pgls$tip.label,
                para.mpd=pgls_remove_g_para_mpd,
                log.pubs=log(pgls_remove_g_para_pubs + pgls_remove_g_host_pubs),
                para.l=remove.gmpd.b.size$mean_l,
                para.w=remove.gmpd.b.size$mean_w,
                para.b=remove.gmpd.b.size$ratio,
                close=as.factor(remove_gmpd_trans$close),
                nonclose=as.factor(remove_gmpd_trans$nonclose),
                intermediate=as.factor(remove_gmpd_trans$intermediate),
                host_mass=remove_gmpd_traits$avgMass)

## constructs the data.frame of the taxa names and data in the order of the tree tips
remove_gmpd_cdat<-comparative.data(data=remove_gmpd_dat, phy=remove_gmpd_pgls, names.col = "taxa")
print(remove_gmpd_cdat)

## model testing ##

#all predictors
remove_gmpd_mod <- pgls(para.mpd~ log.pubs + close + nonclose + intermediate + para.l + host_mass, remove_gmpd_cdat, lambda = "ML")
summary(remove_gmpd_mod)
anova(remove_gmpd_mod)

```


```{r mammal_tree_with_host_mpd, echo = TRUE}
#### NEARCTIC DATASET ####
#single parasite species have mpd = 0
contMap(nearctic_mammal_tree, nearctic_mam_mpd, fsize=0.3, lwd =1)

#### GLOBAL DATASET ####
#single parasite species have mpd = 0
contMap(gmpd_mammal_tree, gmpd_mam_mpd, fsize=0.3, lwd =1, type ="fan")

```




```{r zoonoses_figure, echo=FALSE}

######################
#### GMPD DATASET ####
######################

#### Calulate pairwise distance (PD) of each mammal to homo sapiens ####

#subset PHYLACINE mammal tree to include GMPD mammals
setdiff(large_mam_tree$tip.label, GMPDsmall$HostCorrectedName)->group2

#add back the humans
group3 <- group2[group2 != "Homo sapiens"]

#subset the tree
mammal_tree<-drop.tip(large_mam_tree, large_mam_tree$tip.label[which(large_mam_tree$tip.label%in%group3)])

#calculate the pairwise distances
mam_dis<-cophenetic.phylo(mammal_tree)

#pull out the PD for each mammal to humans
mam_dis2 = as.data.frame(mam_dis)
distances<-mam_dis2[,"Homo sapiens"]
names(distances)<-rownames(mam_dis2)
#view(distances)

#remove humans from distances
distance2<-distances[names(distances) != "Homo sapiens"]

#make a dataframe for the figure 
figure_data<-data.frame("name"= names(global.mam.mpd), "global.mpd" = global.mam.mpd, "distance"= distance2)

##label for 
#figure_data$color<-c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)

#species we want labeled in the figure
important.names<-c("Procyon lotor",
                   "Urocyon cinereoargenteus")

#make dataset for the to-be-labeled points
smaller_data<- figure_data[figure_data$name %in% important.names,]

#load package to label figure datapoints
#library(ggrepel)

summary_data <- figure_data %>% 
  mutate(xy = paste0(global.mpd, "_", distance)) %>% group_by(xy) %>% 
  summarize(count = n()) %>%
  separate(xy, into = c("global.mpd", "distance"), "_")

summary_data$global.mpd <- as.numeric(summary_data$global.mpd)
summary_data$distance <- as.numeric(summary_data$distance)


new_fig_data <- merge(summary_data, figure_data, by = c("global.mpd", "distance"), all.y = TRUE)
                                       

MAM_FIG<-ggplot()+
  geom_point(new_fig_data, mapping=aes(x=global.mpd, y= distance, size = count))+
  geom_text_repel(smaller_data, mapping=aes(x=global.mpd, y=distance, label = name),
                  size=2,
                  vjust = 0,
                  point.padding = .7)+
  labs(y= "PD to Humans", x = " ")+
  scale_y_continuous(limits = c(0,210))+
  theme_bw()+
  theme(legend.position = "none",
        panel.grid = element_blank())



##########################
#### NEARCTIC DATASET ####
##########################

#### Calulate pairwise distance (PD) of each mammal to homo sapiens ####

#subset PHYLACINE mammal tree to include GMPD mammals
setdiff(large_mam_tree$tip.label, colnames(nearctic_df))->group4

#add back the the humans
group5 <- group4[group4 != "Homo sapiens"]

#subset the tree
nearctic_mammal_tree<-drop.tip(large_mam_tree, large_mam_tree$tip.label[which(large_mam_tree$tip.label%in%group5)])

#calculate the pairwise distances
nearctic_mam_dis<-cophenetic.phylo(nearctic_mammal_tree)

#pull out the PD for each mammal to humans
nearctic_mam_dis2 = as.data.frame(nearctic_mam_dis)
nearctic_distances<-nearctic_mam_dis2[,"Homo sapiens"]
names(nearctic_distances)<-rownames(nearctic_mam_dis2)
#view(nearctic_distances)

#remove humans from distances
distance3<-nearctic_distances[names(nearctic_distances) != "Homo sapiens"]

#make a dataframe for the figure 
figure_data_2<-data.frame("name"= names(nearctic.mam.mpd), "nearctic.mpd" = nearctic.mam.mpd, "distance"= distance3)

#species we want labeled in the figure
nearctic.important.names<-c(#"Didelphis virginiana", 
                            "Procyon lotor",
                            #"Didelphis marsupialis", 
                            #"Ursus americanus",
                            "Urocyon cinereoargenteus")

#make dataset for the to-be-labeled points
nearctic_smaller_data<- figure_data_2[figure_data_2$name %in% nearctic.important.names,]

#load package to label figure datapoints
library(ggrepel)

nearctic_summary_data <- figure_data_2 %>% 
  mutate(xy = paste0(nearctic.mpd, "_", distance)) %>% group_by(xy) %>% 
  summarize(count = n()) %>%
  separate(xy, into = c("nearctic.mpd", "distance"), "_")

nearctic_summary_data$nearctic.mpd <- as.numeric(nearctic_summary_data$nearctic.mpd)
nearctic_summary_data$distance <- as.numeric(nearctic_summary_data$distance)


nearctic_fig_data <- merge(nearctic_summary_data, figure_data_2, by = c("nearctic.mpd", "distance"), all.y = TRUE)
                                       
                                       
NEARCTIC_MAM<-ggplot()+
  geom_point(nearctic_summary_data, mapping=aes(x=nearctic.mpd, y= distance, size = count))+
  geom_text_repel(nearctic_smaller_data, mapping=aes(x=nearctic.mpd, y=distance, label = name),
                  size=2,
                  vjust = 2,
                  point.padding = .05)+
  labs(y= " ", x = " ")+
  scale_y_continuous(limits = c(0,210))+
  theme_bw()+
  theme(legend.position = "none", 
        panel.grid = element_blank())



################################
#### ADD THE PLOTS TOGETHER ####
################################

Fig3<-MAM_FIG + NEARCTIC_MAM

ggsave("~/Desktop/figure_three.pdf", Fig3, width = 6, height = 5)
```


```{r descriptive_mammal_results, echo=FALSE}

##############
#####GMPD#####
##############

#How many host are only infected by one helminth?
figure_data #197 species
single<-subset(figure_data, figure_data$global.mpd == 0)
single #75 species

75/197

##############
## Nearctic ##
##############

#How many host are only infected by one helminth?
figure_data_2 #67 species
single_2<-subset(figure_data_2, figure_data_2$nearctic.mpd == 0)
single_2 #75 species

19/67

```


```{r check_for_smapling_bias, echo=TRUE}
#####################
##### GMPD ##########
#####################

##test data bias, correlation between para.mpd and no. of citations
a<-as.data.frame(table(GMPDsmall$ParasiteCorrectedName))
setdiff(a$Var1, names(global.para.mpd))->kickout
a[-which(a$Var1 %in% kickout),]->a

freq<-a[match(global_tree$tip.label, a$Var1),]

cor(a$Freq, global.para.mpd) #r=-0.031
ggplot(a, mapping = aes(a$Freq,global.para.mpd)) + geom_point() 
##Echinococcus multilocularis has 429 observations in the dataset

##without E. multilocularis --no obvious bias
ggplot(a, mapping = aes(a$Freq, global.para.mpd)) + 
  geom_point() +
  xlim(0,150)+
  geom_smooth(method='lm', col='grey38')+
  labs(x='No. of Parasite Observations', y='Parasite MPD')+
  theme_classic()


##test mammal bias
b<-as.data.frame(table(GMPDsmall$HostCorrectedName))
setdiff(b$Var1, names(global.mam.mpd))->kickout2
b[-which(b$Var1 %in% kickout2),]->b

freq2<-b[match(mammal_tree$tip.label, b$Var1),]

cor(b$Freq, global.mam.mpd) #r=.023
ggplot(b, mapping = aes(b$Freq, global.mam.mpd)) + geom_point() 
#Vulpes vulpes has 927 observations

##without Vulpes vulpes
ggplot(b, mapping = aes(b$Freq, global.mam.mpd)) + 
  geom_point() +
  xlim(0,220)+
  geom_smooth(method='lm', col='grey38')+
  labs(x='No. of Mammal Observations', y='Mammal MPD')+
  theme_classic()


##########################
####### Nearctic #########
##########################

##test data bias, correlation between para.mpd and no. of citations
setdiff(nearctic_abund_data$Parasite, names(nearctic.para.mpd))->kickout
nearctic_abund_data[-which(nearctic_abund_data$Parasite %in% kickout),]->c

freq<-c[match(nearctic_tree$tip.label, c$Parasite),]

cor(c$Freq, nearctic.para.mpd) #r=-0.063
ggplot(c, mapping = aes(c$Freq,nearctic.para.mpd)) + 
  geom_point() +
  xlim(0,16)+
  geom_smooth(method='lm', col='grey38')+
  labs(x='No. of Parasite Observations', y='Parasite MPD')+
  theme_classic() 


```
 

```{r specify_helminths_in_the_high_risk_mammals, echo=TRUE}
####What helminths infect the "high-risk" data point?####
global_df %>%
  as.data.frame ->help


#Saguinus mystax infected by two
help$'Saguinus mystax' == 1 #27 and 210 
help[27,]  #Dipetalonema graciliformis (mpd == 18.14)
help[210,] #Hymenolepis diminuta (mpd == 96.2)

#Macaca fascicularis infected by four
help$'Macaca fascicularis' == 1 #86, 136, 164, 200
help[86,]  #Oesophagostomum aculeatum
help[136,] #Strongyloides fuelleborni
help[164,] #Trichuris trichiura (mpd == 37.97)
help[200,] #Paragonimus westermani

#Macaca cyclopis infected by two
help$'Macaca cyclopis' == 1
help[50,]  #Enterobius macaci (mpd == 3.61)
help[200,] #Paragonimus westermani

#Alouatta seniculus infected by two
help$'Alouatta seniculus' == 1  #55, 164
help[55,]  #Trypanoxyuris minutus (mpd == 18.79)
help[164,] #Trichuris trichiura (mpd == 37.97)

#Papio hamadryas
help$'Papio hamadryas' == 1 #51, 211
help[51,] #Enterobius vermicularis
help[211,] #Hymenolepis nana (mpd == 0)



```

