---
title: "Helminth_MS_9_15_20"
author: "APB"
date: "9/15/2020"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(dev=c('png','tiff'),
                      fig.path='figures/')

library(ape)
library(tidyverse)
library(ouch)
library(phytools)
library(geiger)
library(caper)
library(picante)
library(pmc)
library(corHMM)
library(OUwie)
library(rentrez)
library(patchwork)
```

#Load data
```{r load_in_data, include=FALSE}
nearctic_mammal_tree <- readRDS("Nearctic_mammal_tree.RDS")
nearctic_parasite_tree <- readRDS("Nearctic_parasite_tree.RDS")
nearctic_data <- readRDS("Nearctic_data.RDS")

gmpd_mammal_tree <- readRDS("GMPD_mammal_tree.RDS")
gmpd_parasite_tree <- readRDS("GMPD_parasite_tree.RDS")
gmpd_data <- readRDS("GMPD_data.RDS")
gmpd_parasite_data <- read.csv("GMPD_parasite_traits.csv")
## correct one misspelled name (which affects interaction of this data with NCBI databases)
gmpd_parasite_tree$tip.label[which(gmpd_parasite_tree$tip.label=="Teladorasgia davtiani")] <- "Teladorsagia davtiani"
gmpd_data$ParasiteCorrectedName[which(gmpd_data$ParasiteCorrectedName=="Teladorasgia davtiani")] <- "Teladorsagia davtiani"
```

```{r load_nearctic_data, include = FALSE}
#parasite abundance/occurence data
nearctic_abund_data<-read.csv("Host_Range_Nearctic_Mammals.csv")

#change to characters instead of factors
nearctic_abund_data$Parasite<-as.character(nearctic_abund_data$Var1)
```

#Accounting for research effort using the rentrez package searching Pubmed
```{r rentrez_package, include=TRUE, eval=FALSE}
#### GMPD ####
#parasite search
gmpd_para_pubs <- data.frame(term = gmpd_parasite_tree$tip.label,
                        pubs = NA,
                        cites = NA)

for (i in 1:nrow(gmpd_para_pubs)){
  print(gmpd_para_pubs$term[i])
  ## Check GMPD to see if there are alternative names for this parasite in the GMPD
  c(gmpd_data$ParasiteReportedName[gmpd_data$ParasiteCorrectedName==gmpd_para_pubs$term[i]], ## all reported names for this parasite
    gmpd_para_pubs$term[i]) %>% unique -> names
  if (length(names)==1) ## if only one name
    entrez_search(db="pubmed", term=paste0("(\"",gmpd_para_pubs$term[i],"\"[All Fields])"))$count -> gmpd_para_pubs$pubs[i]

  else ## if multiple names
    sapply(names, function(n) entrez_search(db="pubmed", term=paste0("(\"",n,"\"[All Fields])"))$count) %>% sum -> gmpd_para_pubs$pubs[i]
  ## number of unique citations for this parasites in the GMPD
  gmpd_para_pubs$cites[i] <- length(unique(gmpd_data$Citation[which(gmpd_data$ParasiteCorrectedName==gmpd_para_pubs$term[i])]))
}
## No. of pubs cannot be less than the number of citations in the GMPD
gmpd_para_pubs$pubs <- apply(gmpd_para_pubs[,2:3], 1, function(n) max(n[1], n[2]))

#host search
gmpd_host_pubs<-data.frame(term= gmpd_mammal_tree$tip.label, 
                           pubs = NA, 
                           cites = NA)

for (i in 1:nrow(gmpd_host_pubs)){
  print(gmpd_host_pubs$term[i])
  ## Check GMPD to see if there are alternative names for this host in the GMPD
  c(gmpd_data$HostReportedName[gmpd_data$HostCorrectedName==gmpd_host_pubs$term[i]], ## all reported names for this host
    gmpd_host_pubs$term[i]) %>% unique -> names
  if (length(names)==1) ## if only one name
    entrez_search(db="pubmed", term=paste0("(\"",gmpd_host_pubs$term[i],"\"[All Fields]) AND ((\"parasites\"[MeSH Terms] OR \"parasites\"[All Fields] OR \"parasite\"[All Fields]) OR (\"helminths\"[MeSH Terms] OR \"helminths\"[All Fields] OR \"helminth\"[All Fields]))"))$count -> gmpd_host_pubs$pubs[i]
  else ## if multiple names
    sapply(names, function(n) entrez_search(db="pubmed", term=paste0("(\"",n,"\"[All Fields]) AND ((\"parasites\"[MeSH Terms] OR \"parasites\"[All Fields] OR \"parasite\"[All Fields]) OR (\"helminths\"[MeSH Terms] OR \"helminths\"[All Fields] OR \"helminth\"[All Fields]))"))$count) %>% sum -> gmpd_host_pubs$pubs[i]
  
  ## number of unique citations for this parasites in the GMPD
  gmpd_host_pubs$cites[i] <- length(unique(gmpd_data$Citation[which(gmpd_data$HostCorrectedName==gmpd_host_pubs$term[i])]))
}
## No. of pubs cannot be less than the number of citations in the GMPD
gmpd_host_pubs$pubs <- apply(gmpd_host_pubs[,2:3], 1, function(n) max(n[1], n[2]))

#### Nearctic ####
## subset the gmpd_para_pubs to the parasites found in the Nearctic dataset
nearctic_para_pubs <- gmpd_para_pubs[gmpd_parasite_tree$tip.label%in%nearctic_parasite_tree$tip.label,c(1,2)]

## 
nearctic_host_pubs <- data.frame(term=nearctic_mammal_tree$tip.label,
                                 pubs=NA)
for (i in 1:nrow(nearctic_host_pubs)) {
  print(nearctic_host_pubs$term[i])
  ## if this host is in the gmpd_host_pubs dataframe, just pull in its data
  if(nearctic_host_pubs$term[i]%in%gmpd_host_pubs$term)
    nearctic_host_pubs$pubs[i] <- gmpd_host_pubs$pubs[which(gmpd_host_pubs$term==nearctic_host_pubs$term[i])]
  else { ## search for it in pubmed
    try1<-entrez_search(db="pubmed", term=paste0("(\"",nearctic_host_pubs$term[i],"\"[All Fields]) AND ((\"parasites\"[MeSH Terms] OR \"parasites\"[All Fields] OR \"parasite\"[All Fields]) OR (\"helminths\"[MeSH Terms] OR \"helminths\"[All Fields] OR \"helminth\"[All Fields]))"))
    nearctic_host_pubs$pubs[i] <- try1$count
  }
}

saveRDS(gmpd_host_pubs, "GMPD_host_pubs.RDS")
saveRDS(gmpd_para_pubs, "GMPD_para_pubs.RDS")
saveRDS(nearctic_host_pubs, "Nearctic_host_pubs.RDS")
saveRDS(nearctic_para_pubs, "Nearctic_para_pubs.RDS")
```

```{r load_research_effort_data, include = FALSE}
gmpd_host_pubs <- readRDS("GMPD_host_pubs.RDS")
gmpd_para_pubs <- readRDS("GMPD_para_pubs.RDS")
nearctic_host_pubs <- readRDS("Nearctic_host_pubs.RDS")
nearctic_para_pubs <- readRDS("Nearctic_para_pubs.RDS")
```

#Calculate MPD for Nearctic data
```{r calculate_mpd_for_nearctic_data, include= TRUE}
#interspecific distance matrix of parasites
nearctic_dis_para<-cophenetic.phylo(nearctic_parasite_tree) 

#interspecific distance matrix of mammals 
nearctic_dis_mam<-cophenetic.phylo(nearctic_mammal_tree) 

## Create an association matrix with host across the columns and parasites across the rows
nearctic_mamlist<-as.vector(nearctic_mammal_tree$tip.label) #list of mammals in tip label order
nearctic_para_list<-as.vector(nearctic_parasite_tree$tip.label) #list of parasites

#make a dataframe with host names as columns and parasite names as rows
nearctic_df <- data.frame(matrix(ncol=length(nearctic_mamlist),nrow=length(nearctic_para_list)), row.names = nearctic_para_list)
colnames(nearctic_df)<-nearctic_mamlist

# complete dataframe with association data, 
# where 0 = not found in host and 1 = found in host
for (i in 1:nrow(nearctic_df))
  nearctic_df[i,] <- (colnames(nearctic_df) %in% unique(subset(nearctic_data, Parasite==rownames(nearctic_df)[i])$Host)) %>% as.numeric

#save matrix
write.csv(nearctic_df,file = "association_matrix_nearctic.csv", row.names = TRUE, col.names = TRUE)

## Create MPD scores for every parasite where single host parasites have a mpd = 0 (90taxa)
nearctic_para_mpd <- mpd(nearctic_df, nearctic_dis_mam)
nearctic_para_mpd[is.na(nearctic_para_mpd)] <- 0 ## one host species have an MPD of 0
names(nearctic_para_mpd)<-nearctic_para_list

## Create MPD scores for every host where hosts infected by only one parasite have a mpd = 0 (69 taxa)
nearctic_mam_mpd <- mpd(t(nearctic_df), nearctic_dis_para)
nearctic_mam_mpd[is.na(nearctic_mam_mpd)] <- 0 ## hosts infected by only one parasite have MPD of 0
names(nearctic_mam_mpd)<-nearctic_mamlist
```

#Calculate MPD for GMPD
```{r calculate_mpd_for_GMPD_data, include =TRUE}
##calculate the mpd of parasites and hosts!
gmpd_dis_para<-cophenetic.phylo(gmpd_parasite_tree) #interspecific distance matrix of parasites
gmpd_dis_mam<-cophenetic.phylo(gmpd_mammal_tree) #intespecific distance matrix of mammals from small tree

##make the pipeline to get the absence presence of each parasite (rows) that infect a given host (column)
gmpd_mamlist<-as.vector(gmpd_mammal_tree$tip.label) #list of mammals in tip label order
gmpd_para_list<-as.vector(gmpd_parasite_tree$tip.label)
gmpd_df <- data.frame(matrix(ncol=length(gmpd_mamlist),nrow=length(gmpd_para_list)), row.names = gmpd_para_list)
colnames(gmpd_df)<-gmpd_mamlist

for (i in 1:nrow(gmpd_df))
  gmpd_df[i,] <- (colnames(gmpd_df) %in% unique(subset(gmpd_data, ParasiteCorrectedName==rownames(gmpd_df)[i])$HostCorrectedName)) %>% as.numeric

write.csv(gmpd_df,file = "gmpd_df.csv", row.names = TRUE, col.names = TRUE)

## Create MPD scores for every parasite where single host parasites have a mpd = 0 (250 taxa)
gmpd_para_mpd <- mpd(gmpd_df, gmpd_dis_mam)
gmpd_para_mpd[is.na(gmpd_para_mpd)] <- 0 ## one host parasites have an mpd of 0
names(gmpd_para_mpd)<-gmpd_para_list

## Create MPD scores for every host where hosts infected by only one parasite have a mpd = 0 (199 taxa)
gmpd_mam_mpd <- mpd(t(gmpd_df), gmpd_dis_para)
gmpd_mam_mpd[is.na(gmpd_mam_mpd)] <- 0 ## hosts infected by only one parasite have MPD of 0
names(gmpd_mam_mpd)<-gmpd_mamlist
```


#Visualizing MPD and Number of Hosts on Phylogenies
```{r visualizing_range_on_phylogenies, include =TRUE}
#### MPD ####
#NEARCTIC DATASET
#view mpd with single host species = 0 on the tree
contMap(nearctic_parasite_tree, nearctic_para_mpd, fsize= .3, lwd=1, leg.text="x", type="fan") 

#GLOBAL DATASET
#view mpd with single host species = 0 on the tree
contMap(gmpd_parasite_tree, gmpd_para_mpd, fsize= .3,lwd=2, type="fan") 

#### Number of hosts ####
#NEARCTIC DATASET
## Count how many unique hosts each parasite has and put the data frame in the same order as tree tip labels
nearctic_para_nhosts <- nearctic_abund_data[match(nearctic_parasite_tree$tip.label, nearctic_abund_data$Parasite),"Freq"]
names(nearctic_para_nhosts) <- nearctic_abund_data[match(nearctic_parasite_tree$tip.label, nearctic_abund_data$Parasite),"Parasite"]

#check
contMap(nearctic_parasite_tree, nearctic_para_nhosts, fsize=.3, type = "fan")

#### GMPD DATASET ####
gmpd_para_nhosts <- sapply(names(gmpd_para_mpd), function(n) length(unique(gmpd_data$HostCorrectedName[gmpd_data$ParasiteCorrectedName==n])))
names(gmpd_para_nhosts) <- names(gmpd_para_mpd)

#check
contMap(gmpd_parasite_tree, gmpd_para_nhosts, fsize=.3, type = "fan")
```


#Testing for Phylogenetic Signal when accounting for sampling bias
```{r sampling_bias_correction, include=TRUE}
## Run four models:
## 1. gls using citations to predict range (either MPD or number of hosts);
## 2. gls using the tree to predict range;
## 3. gls using citations and the tree to predict range
## 4. gls using no predictors (a null model that is equivalent to white noise)
## From these four models, we do three comparisons:
## 1. Compare the null model to the tree-only model
## 2. Compare the tree+pubs model to the tree-only model
## 3. Compare the tree+pubs model to the pubs-only model
## The first comparison tell us whether there is any phylogenetic signal. The second comparison tells us whether there is any sampling bias. The third comparison tells us whether there is any phylogenetic signal after accounting for the sampling bias. 

## GMPD ##
gmpd_para_pubs$mpd <- unname(gmpd_para_mpd)
gmpd_para_pubs$nhosts <- unname(gmpd_para_nhosts)
## Compute the total number of publications summed across all hosts of each parasite
gmpd_para_pubs$hostPubSum <- sapply(gmpd_para_pubs$term, function(n)
  sum(gmpd_host_pubs$pubs[gmpd_host_pubs$term%in%(unique(gmpd_data$HostCorrectedName[gmpd_data$ParasiteCorrectedName==n]))]))

# significant positive correlation between parasite publication and host publication numbers
#with(gmpd_para_pubs, plot(pubs, hostPubSum))
#cor.test(gmpd_para_pubs$pubs, gmpd_para_pubs$hostPubSum)

## Analysis of range as mean pairwise distance
gls_null_mpd_gmpd <- gls(mpd~1, data=gmpd_para_pubs)
gls_para_pubs_mpd_gmpd <- gls(mpd~pubs, data=gmpd_para_pubs)
gls_host_pubs_mpd_gmpd <- gls(mpd~hostPubSum, data=gmpd_para_pubs)
gls_tree_mpd_gmpd <- gls(mpd~1, data=gmpd_para_pubs, correlation=corPagel(0.5, gmpd_parasite_tree))
gls_para_pubs_tree_mpd_gmpd <- gls(mpd~pubs, data=gmpd_para_pubs, correlation=corPagel(0.5, gmpd_parasite_tree))
gls_host_pubs_tree_mpd_gmpd <- gls(mpd~hostPubSum, data=gmpd_para_pubs, correlation=corPagel(0.5, gmpd_parasite_tree))
## Strong evidence there is phylogenetic signal, as the tree-only model drastically outperforms the null model
anova(gls_tree_mpd_gmpd, gls_null_mpd_gmpd)
## But also evidence for sampling bias
anova(gls_tree_mpd_gmpd, gls_para_pubs_tree_mpd_gmpd)
anova(gls_tree_mpd_gmpd, gls_host_pubs_tree_mpd_gmpd)
## Strong evidence phylogenetic signal persists after accounting for the sampling bias
anova(gls_para_pubs_mpd_gmpd, gls_para_pubs_tree_mpd_gmpd)
anova(gls_host_pubs_mpd_gmpd, gls_host_pubs_tree_mpd_gmpd)

## Analysis of range as number of hosts
gls_null_nhosts_gmpd <- gls(nhosts~1, data=gmpd_para_pubs)
gls_para_pubs_nhosts_gmpd <- gls(nhosts~pubs, data=gmpd_para_pubs)
gls_host_pubs_nhosts_gmpd <- gls(nhosts~hostPubSum, data=gmpd_para_pubs)
gls_tree_nhosts_gmpd <- gls(nhosts~1, data=gmpd_para_pubs, correlation=corPagel(0.5, gmpd_parasite_tree))
gls_para_pubs_tree_nhosts_gmpd <- gls(nhosts~pubs, data=gmpd_para_pubs, correlation=corPagel(0.5, gmpd_parasite_tree))
gls_host_pubs_tree_nhosts_gmpd <- gls(nhosts~hostPubSum, data=gmpd_para_pubs, correlation=corPagel(0.5, gmpd_parasite_tree))
## Evidence for phylogenetic signal, as the tree-only model outperforms the null model (p = 0.0136)
anova(gls_null_nhosts_gmpd, gls_tree_nhosts_gmpd)
## But also evidence for sampling bias
anova(gls_tree_nhosts_gmpd, gls_para_pubs_tree_nhosts_gmpd)
anova(gls_tree_nhosts_gmpd, gls_host_pubs_tree_nhosts_gmpd)
## Evidence that tree + pubs is much better than tree only (p = 0.0342, 0.0103; para pubs and host pubs respectively)
anova(gls_para_pubs_nhosts_gmpd, gls_para_pubs_tree_nhosts_gmpd)
anova(gls_host_pubs_nhosts_gmpd, gls_host_pubs_tree_nhosts_gmpd)

## Nearctic database ##
nearctic_para_pubs$mpd <- unname(nearctic_para_mpd)
nearctic_para_pubs$nhosts <- unname(nearctic_para_nhosts)
## Compute the total number of publications summed across all hosts of each parasite
nearctic_para_pubs$hostPubSum <- sapply(nearctic_para_pubs$term, function(n)
  sum(nearctic_host_pubs$pubs[nearctic_host_pubs$term%in%(unique(nearctic_data$Host[nearctic_data$Parasite==n]))]))

## Analysis of range as mean pairwise distance
gls_null_mpd_nearctic <- gls(mpd~1, data=nearctic_para_pubs)
gls_para_pubs_mpd_nearctic <- gls(mpd~pubs, data=nearctic_para_pubs)
gls_host_pubs_mpd_nearctic <- gls(mpd~hostPubSum, data=nearctic_para_pubs)
gls_tree_mpd_nearctic <- gls(mpd~1, data=nearctic_para_pubs, correlation=corPagel(0.5, nearctic_parasite_tree))
gls_para_pubs_tree_mpd_nearctic <- gls(mpd~pubs, data=nearctic_para_pubs, correlation=corPagel(0.5, nearctic_parasite_tree))
gls_host_pubs_tree_mpd_nearctic <- gls(mpd~hostPubSum, data=nearctic_para_pubs, correlation=corPagel(0.5, nearctic_parasite_tree))
## Strong evidence for phylogenetic signal in MPD, as the tree-only model drastically outperforms the null model
anova(gls_null_mpd_nearctic, gls_tree_mpd_nearctic)
## No evidence for sampling bias
anova(gls_tree_mpd_nearctic, gls_para_pubs_tree_mpd_nearctic)
anova(gls_tree_mpd_nearctic, gls_host_pubs_tree_mpd_nearctic)
## Strong evidence for phylogenetic signal in MPD, as the tree+pubs model drastically outperforms the pubs-only model
anova(gls_para_pubs_mpd_nearctic, gls_para_pubs_tree_mpd_nearctic)
anova(gls_host_pubs_mpd_nearctic, gls_host_pubs_tree_mpd_nearctic)

## Analysis of range as number of hosts
gls_null_nhosts_nearctic <- gls(nhosts~1, data=nearctic_para_pubs)
gls_para_pubs_nhosts_nearctic <- gls(nhosts~pubs, data=nearctic_para_pubs)
gls_host_pubs_nhosts_nearctic <- gls(nhosts~hostPubSum, data=nearctic_para_pubs)
gls_tree_nhosts_nearctic <- gls(nhosts~1, data=nearctic_para_pubs, correlation=corPagel(0.5, nearctic_parasite_tree))
gls_para_pubs_tree_nhosts_nearctic <- gls(nhosts~pubs, data=nearctic_para_pubs, correlation=corPagel(0.5, nearctic_parasite_tree))
gls_host_pubs_tree_nhosts_nearctic <- gls(nhosts~hostPubSum, data=nearctic_para_pubs, correlation=corPagel(0.5, nearctic_parasite_tree))
## No evidence for phylogenetic signal in number of hosts, as tree-only does not outperform the null model
anova(gls_tree_nhosts_nearctic, gls_null_nhosts_nearctic)
## No evidence for sampling bias when using parasite pubs, evidence of sampling bias using host pubs
anova(gls_tree_nhosts_nearctic, gls_para_pubs_tree_nhosts_nearctic)
anova(gls_tree_nhosts_nearctic, gls_host_pubs_tree_nhosts_nearctic)
## No evidence for phylogenetic signal here either, as tree+pubs does not outperform a pubs-only model
anova(gls_para_pubs_nhosts_nearctic, gls_para_pubs_tree_nhosts_nearctic)
anova(gls_host_pubs_nhosts_nearctic, gls_host_pubs_tree_nhosts_nearctic) #when using host pubs there is evidence for phylogenetic signal
```

#Setting selective regimes based on Classes
```{r OU_setup, include = FALSE, eval = FALSE}
g<-gmpd_data[match(nearctic_parasite_tree$tip.label, gmpd_data$ParasiteCorrectedName),]

#make Phyla dataframe (names, regimes, trait)
nearctic_phyla_data<-data.frame(species=nearctic_parasite_tree$tip.label)
nearctic_phyla_data$trait<-nearctic_para_pubs$mpd
library(taxize)
## use the Class as the regime
nearctic_phyla_data$regime <- 
  sapply(nearctic_phyla_data$species, 
         function(s) 
           as.character(subset(classification(sci_id=s, db="ncbi")[[1]],rank=="class")[1]))
nearctic_phyla_data$phyla<-g$ParPhylum

#match GMPD data to the global tree
k<-gmpd_data[match(gmpd_parasite_tree$tip.label, gmpd_data$ParasiteCorrectedName),]

#make Phyla dataframe (names, regimes, trait)
gmpd_phyla_data<-data.frame(species=gmpd_parasite_tree$tip.label)
gmpd_phyla_data$trait<-gmpd_para_mpd
gmpd_phyla_data$regime <- 
  sapply(gmpd_phyla_data$species, 
         function(s) 
           ifelse(any(is.na(classification(sci_id=s, db="ncbi")[[1]])),
                  NA,
                  as.character(subset(classification(sci_id=s, db="ncbi")[[1]],rank=="class")[1])))
## there was one NAs that needs to be coded by hand
gmpd_phyla_data$regime[178] <- "Trematoda"
gmpd_phyla_data$phyla<-k$ParPhylum

saveRDS(nearctic_phyla_data, "nearctic_phyla_data.RDS")
saveRDS(gmpd_phyla_data, "gmpd_phyla_data.RDS")
```

#Neartic ouch Models of the residuals of gls(mpd ~ host pubs) by Phylum
```{r }
nearctic_phyla_data <- readRDS("nearctic_phyla_data.RDS")
nearctic_phyla_data$trait<-gls_host_pubs_mpd_nearctic$residuals

## remake to be able to use ouch rather than OUwie
nearctic_parasite_ouchtree <- ape2ouch(nearctic_parasite_tree) ## convert to ouchtree object
## get the mpd data organized properly for ouch
nearctic_parasite_ouchdata <- rep(NA, length=nearctic_parasite_ouchtree@nnodes)
for (i in 1:length(nearctic_phyla_data$species))
  nearctic_parasite_ouchdata[which(nearctic_parasite_ouchtree@nodelabels==nearctic_phyla_data$species[i])] <- nearctic_phyla_data$trait[i]
nearctic_parasite_ouchdata <- as.data.frame(nearctic_parasite_ouchdata)

## Find the node that corresponds to the most recent common ancestor of all Platyhelminthes
## which nodes in the ouchtree correspond to the Plats
nearctic_parasite_ouchtree@nodelabels%in%nearctic_phyla_data$species[which(nearctic_phyla_data$phyla=="Platyhelminthes")] %>% which -> platys
## get their lineages and find the nodes that are in common across all lineages
nearctic_parasite_ouchtree@lineages[platys] -> platy_lineages
platy_lineages[[1]][sapply(platy_lineages[[1]], function(n) lapply(platy_lineages, function(l) n%in%l) %>% unlist %>% all) %>% which %>% min] ## 1
## Find the node that corresponds to the most recent common ancestor of all Acanthocephalans
## which nodes in the ouchtree correspond to the Acanths
nearctic_parasite_ouchtree@nodelabels%in%nearctic_phyla_data$species[which(nearctic_phyla_data$phyla=="Acanthocephala")] %>% which -> acanths
## get their lineages and find the nodes that are in common across all lineages
nearctic_parasite_ouchtree@lineages[acanths] -> acanth_lineages
acanth_lineages[[1]][sapply(acanth_lineages[[1]], function(n) lapply(acanth_lineages, function(l) n%in%l) %>% unlist %>% all) %>% which %>% min] ## 86
## Find the node that corresponds to the most recent common ancestor of all Nematodes
## which nodes in the ouchtree correspond to the Nematodes
nearctic_parasite_ouchtree@nodelabels%in%nearctic_phyla_data$species[which(nearctic_phyla_data$phyla=="Nematoda")] %>% which -> nematodes
## get their lineages and find the nodes that are in common across all lineages
nearctic_parasite_ouchtree@lineages[nematodes] -> nematode_lineages
nematode_lineages[[1]][sapply(nematode_lineages[[1]], function(n) lapply(nematode_lineages, function(l) n%in%l) %>% unlist %>% all) %>% which %>% min] #81

## paint the taxonomy-based regimes onto the tree
paint(nearctic_parasite_ouchtree, subtree=c("1"="Platys","86"="Acanths","81"="Nematodes"), branch=c("1"="Platys")) -> nearctic_oum_regimes
## paint a single global regime onto the tree
paint(nearctic_parasite_ouchtree, subtree=c("1"="global"), branch=c("1"="global")) -> nearctic_ou1_regimes
## Plot to make sure that you end up with a reasonable painting
plot(nearctic_parasite_ouchtree, regimes=nearctic_oum_regimes)

## Now do the fitting using ouch
## OUM: AICc = 986.79, alpha = 11.08, sigma.sq = 69731.73, Acanths =  72.53, Nematodes = -25.37, Platys = 23.17
nearctic_oum_ouch <- hansen(data=nearctic_parasite_ouchdata, tree=nearctic_parasite_ouchtree, regimes=nearctic_oum_regimes, sqrt.alpha=100, sigma=100)
## OU1: AICc = 995.74, alpha = 4.58, sigma.sq = 38891.98, global = 4.1727
nearctic_ou1_ouch <- hansen(data=nearctic_parasite_ouchdata, tree=nearctic_parasite_ouchtree, regimes=nearctic_ou1_regimes, sqrt.alpha=100, sigma=100)
## BM: AICc = 1009.58, sigma.sq = 18657.17
nearctic_bm_ouch <- brown(data=nearctic_parasite_ouchdata, tree=nearctic_parasite_ouchtree)

#save for supplement
saveRDS(nearctic_ou1_ouch, file ="nearctic_ou1_ouch")
saveRDS(nearctic_bm_ouch, file = "nearctic_bm_ouch")
saveRDS(nearctic_oum_ouch, file ="nearctic_oum_ouch")
```

#GMPD ouch Models of the residuals of gls(mpd ~ host pubs) by Phylum
```{r}
gmpd_phyla_data <- readRDS("gmpd_phyla_data.RDS")
gmpd_phyla_data$trait<-gls_host_pubs_mpd_gmpd$residuals

## remake to be able to use ouch rather than OUwie
gmpd_parasite_ouchtree <- ape2ouch(gmpd_parasite_tree) ## convert to ouchtree object
## get the mpd data organized properly for ouch
gmpd_parasite_ouchdata <- rep(NA, length=gmpd_parasite_ouchtree@nnodes)
for (i in 1:length(gmpd_phyla_data$species))
  gmpd_parasite_ouchdata[which(gmpd_parasite_ouchtree@nodelabels==gmpd_phyla_data$species[i])] <- gmpd_phyla_data$trait[i]
gmpd_parasite_ouchdata <- as.data.frame(gmpd_parasite_ouchdata)

## You can use the code above, replacing nearctic with global, to find the last common ancestor for Platyhelminthes (1), Acanthocephalans (244), and Nematodes (228). I drop those blocks of code here to reduce the amount of code.

## paint the taxonomy-based regimes onto the tree
paint(gmpd_parasite_ouchtree, subtree=c("1"="Platys","244"="Acanths","228"="Nematodes"), branch=c("1"="Platys")) -> gmpd_oum_regimes
## paint a single global regime onto the tree
paint(gmpd_parasite_ouchtree, subtree=c("1"="global"), branch=c("1"="global")) -> gmpd_ou1_regimes
## Plot to make sure that you end up with a reasonable painting
plot(gmpd_parasite_ouchtree, regimes=gmpd_oum_regimes)

## Now do the fitting using ouch
## OUM: AICc = 2415.69, alpha = 61.20, sigma.sq = 109197.6, Acanths =  1.195, Nematodes = -4.88, Platys = 9.22
gmpd_oum_ouch <- hansen(data=gmpd_parasite_ouchdata, tree=gmpd_parasite_ouchtree, regimes=gmpd_oum_regimes, sqrt.alpha=100, sigma=100)
## OU1: AICc = 2422.43, alpha = 80.63, sigma.sq = 150101.2, global = -0.03845
gmpd_ou1_ouch <- hansen(data=gmpd_parasite_ouchdata, tree=gmpd_parasite_ouchtree, regimes=gmpd_ou1_regimes, sqrt.alpha=100, sigma=100)
## BM: AICc = 2565.49, sigma.sq = 11552.28
gmpd_bm_ouch <- brown(data=gmpd_parasite_ouchdata, tree=gmpd_parasite_ouchtree)

#save for supplement 
saveRDS(gmpd_bm_ouch, file = "gmpd_bm_ouch")
saveRDS(gmpd_ou1_ouch, file = "gmpd_ou1_ouch")
saveRDS(gmpd_oum_ouch, file = "gmpd_oum_ouch")
```

#Bootstrapping Evolutionary models for both datasets
```{r bootstrap_ouch_results, eval=FALSE, echo=FALSE}
## Simulate 1000 datasets using either the OUM, OU1 or the BM model, and then re-fit either the true data-generating model or the other model
nearctic_oum_datasets <- simulate(nearctic_oum_ouch, nsim=1000, seed=12983)
nearctic_ou1_datasets <- simulate(nearctic_ou1_ouch, nsim=1000, seed=12983)
nearctic_bm_datasets <- simulate(nearctic_bm_ouch, nsim=1000, seed=12983)
## Fit the OUM model to the OUM data
lapply(nearctic_oum_datasets, 
       function(data) hansen(data=data, 
                             tree=nearctic_parasite_ouchtree,
                             regimes=nearctic_oum_regimes,
                             sqrt.alpha=100, sigma=100)
) -> fit_oum_model_to_oum_data_nearctic
data.frame(logLik=lapply(fit_oum_model_to_oum_data_nearctic, function(fit) fit@loglik) %>% unlist,
           sigma.sq=lapply(fit_oum_model_to_oum_data_nearctic, function(fit) fit@sigma^2) %>% unlist,
           alpha=lapply(fit_oum_model_to_oum_data_nearctic, function(fit) fit@sqrt.alpha^2) %>% unlist,
           Acanths=lapply(fit_oum_model_to_oum_data_nearctic, function(fit) fit@theta[[1]][1]) %>% unlist,
           Nematodes=lapply(fit_oum_model_to_oum_data_nearctic, function(fit) fit@theta[[1]][2]) %>% unlist,
           Platys=lapply(fit_oum_model_to_oum_data_nearctic, function(fit) fit@theta[[1]][3]) %>% unlist
           ) -> fit_oum_model_to_oum_data_nearctic
saveRDS(fit_oum_model_to_oum_data_nearctic, file="bootstrap_results/fit_oum_model_to_oum_data_nearctic.RDS")
## Fit the OU1 model to the OUM data
lapply(nearctic_oum_datasets, 
       function(data) hansen(data=data, 
                             tree=nearctic_parasite_ouchtree,
                             regimes=nearctic_ou1_regimes,
                             sqrt.alpha=100, sigma=100)
) -> fit_ou1_model_to_oum_data_nearctic
data.frame(logLik=lapply(fit_ou1_model_to_oum_data_nearctic, function(fit) fit@loglik) %>% unlist,
           sigma.sq=lapply(fit_ou1_model_to_oum_data_nearctic, function(fit) fit@sigma^2) %>% unlist,
           alpha=lapply(fit_ou1_model_to_oum_data_nearctic, function(fit) fit@sqrt.alpha^2) %>% unlist,
           global=lapply(fit_ou1_model_to_oum_data_nearctic, function(fit) fit@theta %>% unlist) %>% unlist
           ) -> fit_ou1_model_to_oum_data_nearctic
saveRDS(fit_ou1_model_to_oum_data_nearctic, file="bootstrap_results/fit_ou1_model_to_oum_data_nearctic.RDS")
## Fit the BM model to the OUM data
lapply(nearctic_oum_datasets, 
       function(data) brown(data=data, 
                            tree=nearctic_parasite_ouchtree)
) -> fit_bm_model_to_oum_data_nearctic
data.frame(logLik=lapply(fit_bm_model_to_oum_data_nearctic, function(fit) fit@loglik) %>% unlist,
           sigma.sq=lapply(fit_bm_model_to_oum_data_nearctic, function(fit) fit@sigma^2) %>% unlist) -> fit_bm_model_to_oum_data_nearctic
saveRDS(fit_bm_model_to_oum_data_nearctic, file="bootstrap_results/fit_bm_model_to_oum_data_nearctic.RDS")

## Fit the OUM model to the OU1 data
lapply(nearctic_ou1_datasets, 
       function(data) hansen(data=data, 
                             tree=nearctic_parasite_ouchtree,
                             regimes=nearctic_oum_regimes,
                             sqrt.alpha=100, sigma=100)
) -> fit_oum_model_to_ou1_data_nearctic
data.frame(logLik=lapply(fit_oum_model_to_ou1_data_nearctic, function(fit) fit@loglik) %>% unlist,
           sigma.sq=lapply(fit_oum_model_to_ou1_data_nearctic, function(fit) fit@sigma^2) %>% unlist,
           alpha=lapply(fit_oum_model_to_ou1_data_nearctic, function(fit) fit@sqrt.alpha^2) %>% unlist,
           Acanths=lapply(fit_oum_model_to_ou1_data_nearctic, function(fit) fit@theta[[1]][1]) %>% unlist,
           Nematodes=lapply(fit_oum_model_to_ou1_data_nearctic, function(fit) fit@theta[[1]][2]) %>% unlist,
           Platys=lapply(fit_oum_model_to_ou1_data_nearctic, function(fit) fit@theta[[1]][3]) %>% unlist
           ) -> fit_oum_model_to_ou1_data_nearctic
saveRDS(fit_oum_model_to_ou1_data_nearctic, file="bootstrap_results/fit_oum_model_to_ou1_data_nearctic.RDS")
## Fit the OU1 model to the OU1 data
lapply(nearctic_ou1_datasets, 
       function(data) hansen(data=data, 
                             tree=nearctic_parasite_ouchtree,
                             regimes=nearctic_ou1_regimes,
                             sqrt.alpha=100, sigma=100)
) -> fit_ou1_model_to_ou1_data_nearctic
data.frame(logLik=lapply(fit_ou1_model_to_ou1_data_nearctic, function(fit) fit@loglik) %>% unlist,
           sigma.sq=lapply(fit_ou1_model_to_ou1_data_nearctic, function(fit) fit@sigma^2) %>% unlist,
           alpha=lapply(fit_ou1_model_to_ou1_data_nearctic, function(fit) fit@sqrt.alpha^2) %>% unlist,
           global=lapply(fit_ou1_model_to_ou1_data_nearctic, function(fit) fit@theta %>% unlist) %>% unlist
           ) -> fit_ou1_model_to_ou1_data_nearctic
saveRDS(fit_ou1_model_to_ou1_data_nearctic, file="bootstrap_results/fit_ou1_model_to_ou1_data_nearctic.RDS")

## Fit the OUM model to the BM data
lapply(nearctic_bm_datasets, 
       function(data) hansen(data=data, 
                             tree=nearctic_parasite_ouchtree,
                             regimes=nearctic_oum_regimes,
                             sqrt.alpha=100, sigma=100)
) -> fit_oum_model_to_bm_data_nearctic
data.frame(logLik=lapply(fit_oum_model_to_bm_data_nearctic, function(fit) fit@loglik) %>% unlist,
           sigma.sq=lapply(fit_oum_model_to_bm_data_nearctic, function(fit) fit@sigma^2) %>% unlist,
           alpha=lapply(fit_oum_model_to_bm_data_nearctic, function(fit) fit@sqrt.alpha^2) %>% unlist,
           Acanths=lapply(fit_oum_model_to_bm_data_nearctic, function(fit) fit@theta[[1]][1]) %>% unlist,
           Nematodes=lapply(fit_oum_model_to_bm_data_nearctic, function(fit) fit@theta[[1]][2]) %>% unlist,
           Platys=lapply(fit_oum_model_to_bm_data_nearctic, function(fit) fit@theta[[1]][3]) %>% unlist
           ) -> fit_oum_model_to_bm_data_nearctic
saveRDS(fit_oum_model_to_bm_data_nearctic, file="bootstrap_results/fit_oum_model_to_bm_data_nearctic.RDS")

## Fit the BM model to the BM data
lapply(nearctic_bm_datasets, 
       function(data) brown(data=data, 
                            tree=nearctic_parasite_ouchtree)
) -> fit_bm_model_to_bm_data_nearctic
data.frame(logLik=lapply(fit_bm_model_to_bm_data_nearctic, function(fit) fit@loglik) %>% unlist,
           sigma.sq=lapply(fit_bm_model_to_bm_data_nearctic, function(fit) fit@sigma^2) %>% unlist) -> fit_bm_model_to_bm_data_nearctic
saveRDS(fit_bm_model_to_bm_data_nearctic, file="bootstrap_results/fit_bm_model_to_bm_data_nearctic.RDS")


## BOOTSTRAP ANALYSIS OF GMPD DATA
## Simulate 1000 datasets using either the OUM, OU1 or the BM model, and then re-fit either the true data-generating model or the other model
gmpd_oum_datasets <- simulate(gmpd_oum_ouch, nsim=1000, seed=12983)
gmpd_ou1_datasets <- simulate(gmpd_ou1_ouch, nsim=1000, seed=12983)
gmpd_bm_datasets <- simulate(gmpd_bm_ouch, nsim=1000, seed=12983)
lapply(gmpd_oum_datasets, 
       function(data) hansen(data=data, 
                             tree=gmpd_parasite_ouchtree,
                             regimes=gmpd_oum_regimes,
                             sqrt.alpha=100, sigma=100)
) -> fit_oum_model_to_oum_data_gmpd
data.frame(logLik=lapply(fit_oum_model_to_oum_data_gmpd, function(fit) fit@loglik) %>% unlist,
           sigma.sq=lapply(fit_oum_model_to_oum_data_gmpd, function(fit) fit@sigma^2) %>% unlist,
           alpha=lapply(fit_oum_model_to_oum_data_gmpd, function(fit) fit@sqrt.alpha^2) %>% unlist,
           Acanths=lapply(fit_oum_model_to_oum_data_gmpd, function(fit) fit@theta[[1]][1]) %>% unlist,
           Nematodes=lapply(fit_oum_model_to_oum_data_gmpd, function(fit) fit@theta[[1]][2]) %>% unlist,
           Platys=lapply(fit_oum_model_to_oum_data_gmpd, function(fit) fit@theta[[1]][3]) %>% unlist
           ) -> fit_oum_model_to_oum_data_gmpd
saveRDS(fit_oum_model_to_oum_data_gmpd, file="bootstrap_results/fit_oum_model_to_oum_data_gmpd.RDS")

## Fit the OU1 model to the OUM data
lapply(gmpd_oum_datasets, 
       function(data) hansen(data=data, 
                             tree=gmpd_parasite_ouchtree,
                             regimes=gmpd_ou1_regimes,
                             sqrt.alpha=100, sigma=100)
) -> fit_ou1_model_to_oum_data_gmpd
data.frame(logLik=lapply(fit_ou1_model_to_oum_data_gmpd, function(fit) fit@loglik) %>% unlist,
           sigma.sq=lapply(fit_ou1_model_to_oum_data_gmpd, function(fit) fit@sigma^2) %>% unlist,
           alpha=lapply(fit_ou1_model_to_oum_data_gmpd, function(fit) fit@sqrt.alpha^2) %>% unlist,
           global=lapply(fit_ou1_model_to_oum_data_gmpd, function(fit) fit@theta %>% unlist) %>% unlist
           ) -> fit_ou1_model_to_oum_data_gmpd
saveRDS(fit_ou1_model_to_oum_data_gmpd, file="bootstrap_results/fit_ou1_model_to_oum_data_gmpd.RDS")

## Fit the BM model to the OUM data
lapply(gmpd_oum_datasets, 
       function(data) brown(data=data, 
                            tree=gmpd_parasite_ouchtree)
) -> fit_bm_model_to_oum_data_gmpd
data.frame(logLik=lapply(fit_bm_model_to_oum_data_gmpd, function(fit) fit@loglik) %>% unlist,
           sigma.sq=lapply(fit_bm_model_to_oum_data_gmpd, function(fit) fit@sigma^2) %>% unlist) -> fit_bm_model_to_oum_data_gmpd
saveRDS(fit_bm_model_to_oum_data_gmpd, file="bootstrap_results/fit_bm_model_to_oum_data_gmpd.RDS")

## Fit the OUM model to the OU1 data
lapply(gmpd_ou1_datasets, 
       function(data) hansen(data=data, 
                             tree=gmpd_parasite_ouchtree,
                             regimes=gmpd_oum_regimes,
                             sqrt.alpha=100, sigma=100)
) -> fit_oum_model_to_ou1_data_gmpd
data.frame(logLik=lapply(fit_oum_model_to_ou1_data_gmpd, function(fit) fit@loglik) %>% unlist,
           sigma.sq=lapply(fit_oum_model_to_ou1_data_gmpd, function(fit) fit@sigma^2) %>% unlist,
           alpha=lapply(fit_oum_model_to_ou1_data_gmpd, function(fit) fit@sqrt.alpha^2) %>% unlist,
           Acanths=lapply(fit_oum_model_to_ou1_data_gmpd, function(fit) fit@theta[[1]][1]) %>% unlist,
           Nematodes=lapply(fit_oum_model_to_ou1_data_gmpd, function(fit) fit@theta[[1]][2]) %>% unlist,
           Platys=lapply(fit_oum_model_to_ou1_data_gmpd, function(fit) fit@theta[[1]][3]) %>% unlist
           ) -> fit_oum_model_to_ou1_data_gmpd
saveRDS(fit_oum_model_to_ou1_data_gmpd, file="bootstrap_results/fit_oum_model_to_ou1_data_gmpd.RDS")

## Fit the OU1 model to the OU1 data
lapply(gmpd_ou1_datasets, 
       function(data) hansen(data=data, 
                             tree=gmpd_parasite_ouchtree,
                             regimes=gmpd_ou1_regimes,
                             sqrt.alpha=100, sigma=100)
) -> fit_ou1_model_to_ou1_data_gmpd
data.frame(logLik=lapply(fit_ou1_model_to_ou1_data_gmpd, function(fit) fit@loglik) %>% unlist,
           sigma.sq=lapply(fit_ou1_model_to_ou1_data_gmpd, function(fit) fit@sigma^2) %>% unlist,
           alpha=lapply(fit_ou1_model_to_ou1_data_gmpd, function(fit) fit@sqrt.alpha^2) %>% unlist,
           global=lapply(fit_ou1_model_to_ou1_data_gmpd, function(fit) fit@theta %>% unlist) %>% unlist
           ) -> fit_ou1_model_to_ou1_data_gmpd
saveRDS(fit_ou1_model_to_ou1_data_gmpd, file="bootstrap_results/fit_ou1_model_to_ou1_data_gmpd.RDS")

## Fit the OUM model to the BM data
lapply(gmpd_bm_datasets, 
       function(data) hansen(data=data, 
                             tree=gmpd_parasite_ouchtree,
                             regimes=gmpd_oum_regimes,
                             sqrt.alpha=100, sigma=100)
) -> fit_oum_model_to_bm_data_gmpd
data.frame(logLik=lapply(fit_oum_model_to_bm_data_gmpd, function(fit) fit@loglik) %>% unlist,
           sigma.sq=lapply(fit_oum_model_to_bm_data_gmpd, function(fit) fit@sigma^2) %>% unlist,
           alpha=lapply(fit_oum_model_to_bm_data_gmpd, function(fit) fit@sqrt.alpha^2) %>% unlist,
           Acanths=lapply(fit_oum_model_to_bm_data_gmpd, function(fit) fit@theta[[1]][1]) %>% unlist,
           Nematodes=lapply(fit_oum_model_to_bm_data_gmpd, function(fit) fit@theta[[1]][2]) %>% unlist,
           Platys=lapply(fit_oum_model_to_bm_data_gmpd, function(fit) fit@theta[[1]][3]) %>% unlist
           ) -> fit_oum_model_to_bm_data_gmpd
saveRDS(fit_oum_model_to_bm_data_gmpd, file="bootstrap_results/fit_oum_model_to_bm_data_gmpd.RDS")

## Fit the BM model to the BM data
lapply(gmpd_bm_datasets, 
       function(data) brown(data=data, 
                            tree=gmpd_parasite_ouchtree)
) -> fit_bm_model_to_bm_data_gmpd
data.frame(logLik=lapply(fit_bm_model_to_bm_data_gmpd, function(fit) fit@loglik) %>% unlist,
           sigma.sq=lapply(fit_bm_model_to_bm_data_gmpd, function(fit) fit@sigma^2) %>% unlist) -> fit_bm_model_to_bm_data_gmpd
saveRDS(fit_bm_model_to_bm_data_gmpd, file="bootstrap_results/fit_bm_model_to_bm_data_gmpd.RDS")
```

```{r bootstrap_analysis}
## Load all of the bootstrap data
fit_oum_model_to_oum_data_nearctic <- readRDS(file="bootstrap_results/fit_oum_model_to_oum_data_nearctic.RDS")
fit_oum_model_to_ou1_data_nearctic <- readRDS(file="bootstrap_results/fit_oum_model_to_ou1_data_nearctic.RDS")
fit_oum_model_to_bm_data_nearctic <- readRDS(file="bootstrap_results/fit_oum_model_to_bm_data_nearctic.RDS")
fit_ou1_model_to_oum_data_nearctic <- readRDS(file="bootstrap_results/fit_ou1_model_to_oum_data_nearctic.RDS")
fit_ou1_model_to_ou1_data_nearctic <- readRDS(file="bootstrap_results/fit_ou1_model_to_ou1_data_nearctic.RDS")
fit_bm_model_to_oum_data_nearctic <- readRDS(file="bootstrap_results/fit_bm_model_to_oum_data_nearctic.RDS")
fit_bm_model_to_bm_data_nearctic <- readRDS(file="bootstrap_results/fit_bm_model_to_bm_data_nearctic.RDS")


fit_oum_model_to_oum_data_gmpd <- readRDS(file="bootstrap_results/fit_oum_model_to_oum_data_gmpd.RDS")
fit_oum_model_to_ou1_data_gmpd <- readRDS(file="bootstrap_results/fit_oum_model_to_ou1_data_gmpd.RDS")
fit_oum_model_to_bm_data_gmpd <- readRDS(file="bootstrap_results/fit_oum_model_to_bm_data_gmpd.RDS")
fit_ou1_model_to_oum_data_gmpd <- readRDS(file="bootstrap_results/fit_ou1_model_to_oum_data_gmpd.RDS")
fit_ou1_model_to_ou1_data_gmpd <- readRDS(file="bootstrap_results/fit_ou1_model_to_ou1_data_gmpd.RDS")
fit_bm_model_to_oum_data_gmpd <- readRDS(file="bootstrap_results/fit_bm_model_to_oum_data_gmpd.RDS")
fit_bm_model_to_bm_data_gmpd <- readRDS(file="bootstrap_results/fit_bm_model_to_bm_data_gmpd.RDS")


## If we treat BM as the null model, then we can compute the likelihood differences observed when BM is true to the observed likelihood difference in the real data to determine a p-value
## 1. Compute the likelihood difference between the BM model fit to the BM data and the OU model fit to the BM data for all simulated datasets
## 2. Compute the likelihood difference between the BM model fit to the real data and the OU model fit to the real data
## 3. The number of likelihood differences computed in step #1 that are larger than the observed likelihood difference divided by the total number of simulated datasets gives an estimate of the p-value of the test (since the p-value is the probability of observing a dataset as extreme as the real one, assuming that the null model [BM] is true)
(((fit_bm_model_to_bm_data_gmpd$logLik-fit_oum_model_to_bm_data_gmpd$logLik) < (gmpd_bm_ouch@loglik - gmpd_oum_ouch@loglik)) %>% sum)/nrow(fit_bm_model_to_bm_data_gmpd) -> p_value_bm_vs_oum_gmpd #0 

(((fit_bm_model_to_bm_data_nearctic$logLik-fit_oum_model_to_bm_data_nearctic$logLik) < (nearctic_bm_ouch@loglik - nearctic_oum_ouch@loglik)) %>% sum)/nrow(fit_bm_model_to_bm_data_nearctic) -> p_value_bm_vs_oum_nearctic #0

## If we treat OU1 as the null model, then we can compute the likelihood differences observed when OU1 is true to the observed likelihood difference in the real data to determine a p-value
## 1. Compute the likelihood difference between the OU1 model fit to the OU1 data and the OUM model fit to the OU1 data for all simulated datasets
## 2. Compute the likelihood difference between the OU1 model fit to the real data and the OUM model fit to the real data
## 3. The number of likelihood differences computed in step #1 that are larger than the observed likelihood difference divided by the total number of simulated datasets gives an estimate of the p-value of the test (since the p-value is the probability of observing a dataset as extreme as the real one, assuming that the null model [BM] is true)
(((fit_ou1_model_to_ou1_data_gmpd$logLik-fit_oum_model_to_ou1_data_gmpd$logLik) < (gmpd_ou1_ouch@loglik - gmpd_oum_ouch@loglik)) %>% sum)/nrow(fit_ou1_model_to_ou1_data_gmpd) -> p_value_ou1_vs_oum_gmpd #0.011 

(((fit_ou1_model_to_ou1_data_nearctic$logLik-fit_oum_model_to_ou1_data_nearctic$logLik) < (nearctic_ou1_ouch@loglik - nearctic_oum_ouch@loglik)) %>% sum)/nrow(fit_ou1_model_to_ou1_data_nearctic) -> p_value_ou1_vs_oum_nearctic #0.005 

## Computing the power of a test that rejects the BM model with a false positive rate of 5%
## 1. Using the likelihood differences above for the BM and OU models fit to BM data, find the likelihood difference in the 5th percentile
## 2. Compute the likelihood difference between the BM model fit to the OU data and the OU model fit to the OU data for all simulated datasets
## 3. The number of likelihood differences computed in step #2 that are larger than the 5th percentile likelihood difference divided by the total number of simulated datasets gives an estimate of the power of the test
(((-2*(fit_bm_model_to_oum_data_gmpd$logLik - fit_oum_model_to_oum_data_gmpd$logLik)) > sort(-2*(fit_bm_model_to_bm_data_gmpd$logLik-fit_oum_model_to_bm_data_gmpd$logLik))[950]) %>% sum)/1000 -> power_to_reject_bm_gmpd #1

(((-2*(fit_bm_model_to_oum_data_nearctic$logLik - fit_oum_model_to_oum_data_nearctic$logLik)) > sort(-2*(fit_bm_model_to_bm_data_nearctic$logLik-fit_oum_model_to_bm_data_nearctic$logLik))[950]) %>% sum)/1000 -> power_to_reject_bm_nearctic #1

## Computing the power of a test that rejects the OU1 model with a false positive rate of 5%
## 1. Using the likelihood differences above for the OU1 and OUM models fit to OU1 data, find the likelihood difference in the 5th percentile
## 2. Compute the likelihood difference between the OU1 model fit to the OUM data and the OUM model fit to the OUM data for all simulated datasets
## 3. The number of likelihood differences computed in step #2 that are larger than the 5th percentile likelihood difference divided by the total number of simulated datasets gives an estimate of the power of the test
(((-2*(fit_ou1_model_to_oum_data_gmpd$logLik - fit_oum_model_to_oum_data_gmpd$logLik)) > sort(-2*(fit_ou1_model_to_ou1_data_gmpd$logLik-fit_oum_model_to_ou1_data_gmpd$logLik))[950]) %>% sum)/1000 -> power_to_reject_ou1_gmpd # 0.823

(((-2*(fit_ou1_model_to_oum_data_nearctic$logLik - fit_oum_model_to_oum_data_nearctic$logLik)) > sort(-2*(fit_ou1_model_to_ou1_data_nearctic$logLik-fit_oum_model_to_ou1_data_nearctic$logLik))[950]) %>% sum)/1000 -> power_to_reject_ou1_nearctic # 0.955
```

#Plotting the likelihood ratio distributions for BM versus OU(3). 
```{r plot_bm_vs_oum, fig.height=4, fig.width=5, units='in', res=300}

## Plot the distributions of likelihood differences between BM and OUM for the different datasets
par(mar=c(3,3,2,1), oma=rep(0,4), mfrow=c(2,2))
## GMPD
delta <- -2*(gmpd_bm_ouch@loglik - gmpd_oum_ouch@loglik)
delta.dist <- -2*(fit_bm_model_to_bm_data_gmpd$logLik - fit_oum_model_to_bm_data_gmpd$logLik)
delta.dist.2 <- -2*(fit_bm_model_to_oum_data_gmpd$logLik - fit_oum_model_to_oum_data_gmpd$logLik)
d1 <- density(delta.dist)
d2 <- density(delta.dist.2)
plot.new()
plot.window(xlim=range(c(d1$x,d2$x)), ylim=range(c(d1$y,d2$y)))
axis(1);axis(2);box('plot')
mtext(side=1, line=2, expression(delta))
mtext(side=2, line=2, 'Density')
mtext(side=3, line=0.25, "GMPD")
lines(d1$x, d1$y, col=gray(0.7))
with(d1, polygon(x=c(min(x), x[x<max(x)], rev(x[x<max(x)]), min(x)), y=c(0, 0*x[x<max(x)], rev(y[x<max(x)]), 0), col=gray(0.7, alpha=0.5)))
lines(d2$x, d2$y, col=gray(0.2))
with(d2, polygon(x=c(min(x), x[x<max(x)], rev(x[x<max(x)]), min(x)), y=c(0, 0*x[x<max(x)], rev(y[x<max(x)]), 0), col=gray(0.2, alpha=0.5)))
abline(v=delta, lwd=2, lty=2)
legend(x='topright', c('BM','OU3'), fill=c(gray(0.7),gray(0.2)), bty='n', cex=0.75)

delta <- -2*(nearctic_bm_ouch@loglik - nearctic_oum_ouch@loglik)
delta.dist <- -2*(fit_bm_model_to_bm_data_nearctic$logLik - fit_oum_model_to_bm_data_nearctic$logLik)
delta.dist.2 <- -2*(fit_bm_model_to_oum_data_nearctic$logLik - fit_oum_model_to_oum_data_nearctic$logLik)
d1 <- density(delta.dist)
d2 <- density(delta.dist.2)
plot.new()
plot.window(xlim=range(c(d1$x,d2$x)), ylim=range(c(d1$y,d2$y)))
axis(1);axis(2);box('plot')
mtext(side=1, line=2, expression(delta))
mtext(side=2, line=2, 'Density')
mtext(side=3, line=0.25, "Nearctic")
lines(d1$x, d1$y, col=gray(0.7))
with(d1, polygon(x=c(min(x), x[x<max(x)], rev(x[x<max(x)]), min(x)), y=c(0, 0*x[x<max(x)], rev(y[x<max(x)]), 0), col=gray(0.7, alpha=0.5)))
lines(d2$x, d2$y, col=gray(0.2))
with(d2, polygon(x=c(min(x), x[x<max(x)], rev(x[x<max(x)]), min(x)), y=c(0, 0*x[x<max(x)], rev(y[x<max(x)]), 0), col=gray(0.2, alpha=0.5)))
abline(v=delta, lwd=2, lty=2)
```


#Plotting the likelihood ratio distributions for OU(1) versus OU(3). 
```{r plot_ou1_vs_oum, fig.height=4, fig.width=5, units='in', res=300}

## Plot the distributions of likelihood differences between ou1 and OUM for the four different datasets
#par(mar=c(3,3,2,1), oma=rep(0,4), mfrow=c(1,2))
## GMPD
delta <- -2*(gmpd_ou1_ouch@loglik - gmpd_oum_ouch@loglik)
delta.dist <- -2*(fit_ou1_model_to_ou1_data_gmpd$logLik - fit_oum_model_to_ou1_data_gmpd$logLik)
delta.dist.2 <- -2*(fit_ou1_model_to_oum_data_gmpd$logLik - fit_oum_model_to_oum_data_gmpd$logLik)
d1 <- density(delta.dist)
d2 <- density(delta.dist.2)
plot.new()
plot.window(xlim=range(c(d1$x,d2$x)), ylim=range(c(d1$y,d2$y)))
axis(1);axis(2);box('plot')
mtext(side=1, line=2, expression(delta))
mtext(side=2, line=2, 'Density')
mtext(side=3, line=0.25, "GMPD")
lines(d1$x, d1$y, col=gray(0.7))
with(d1, polygon(x=c(min(x), x[x<max(x)], rev(x[x<max(x)]), min(x)), y=c(0, 0*x[x<max(x)], rev(y[x<max(x)]), 0), col=gray(0.7, alpha=0.5)))
lines(d2$x, d2$y, col=gray(0.2))
with(d2, polygon(x=c(min(x), x[x<max(x)], rev(x[x<max(x)]), min(x)), y=c(0, 0*x[x<max(x)], rev(y[x<max(x)]), 0), col=gray(0.2, alpha=0.5)))
abline(v=delta, lwd=2, lty=2)
legend(x='topright', c('OU1','OU3'), fill=c(gray(0.7),gray(0.2)), bty='n', cex=0.75)

delta <- -2*(nearctic_ou1_ouch@loglik - nearctic_oum_ouch@loglik)
delta.dist <- -2*(fit_ou1_model_to_ou1_data_nearctic$logLik - fit_oum_model_to_ou1_data_nearctic$logLik)
delta.dist.2 <- -2*(fit_ou1_model_to_oum_data_nearctic$logLik - fit_oum_model_to_oum_data_nearctic$logLik)
d1 <- density(delta.dist)
d2 <- density(delta.dist.2)
plot.new()
plot.window(xlim=range(c(d1$x,d2$x)), ylim=range(c(d1$y,d2$y)))
axis(1);axis(2);box('plot')
mtext(side=1, line=2, expression(delta))
mtext(side=2, line=2, 'Density')
mtext(side=3, line=0.25, "Nearctic")
lines(d1$x, d1$y, col=gray(0.7))
with(d1, polygon(x=c(min(x), x[x<max(x)], rev(x[x<max(x)]), min(x)), y=c(0, 0*x[x<max(x)], rev(y[x<max(x)]), 0), col=gray(0.7, alpha=0.5)))
lines(d2$x, d2$y, col=gray(0.2))
with(d2, polygon(x=c(min(x), x[x<max(x)], rev(x[x<max(x)]), min(x)), y=c(0, 0*x[x<max(x)], rev(y[x<max(x)]), 0), col=gray(0.2, alpha=0.5)))
abline(v=delta, lwd=2, lty=2)

par(mfrow=c(1,1))
```

#Summary Table for Evolution Models
```{r OU_summary_tables, echo=TRUE}
###NEARCTIC DATASET####
tibble(model=c("BM","OU1","OU3"),
       aicc=c(summary(nearctic_bm_ouch)$aic.c, 
              summary(nearctic_ou1_ouch)$aic.c,
              summary(nearctic_oum_ouch)$aic.c)
       ) %>% 
  mutate(deltaaicc=aicc-min(aicc), 
         pow=exp(-.5*deltaaicc),
         sumpow=sum(pow),
         waicc=pow/sumpow) %>%
  dplyr::select(c(1,2,3,6)) %>%
  arrange(desc(waicc)) -> nearctic_aic_OU
nearctic_aic_OU

###GMPD DATASET####
tibble(model=c("BM","OU1","OU3"),
       aicc=c(summary(gmpd_bm_ouch)$aic.c, 
              summary(gmpd_ou1_ouch)$aic.c,
              summary(gmpd_oum_ouch)$aic.c)
       ) %>% 
  mutate(deltaaicc=aicc-min(aicc), 
         pow=exp(-.5*deltaaicc),
         sumpow=sum(pow),
         waicc=pow/sumpow) %>%
  dplyr::select(c(1,2,3,6)) %>%
  arrange(desc(waicc)) -> gmpd_aic_OU
gmpd_aic_OU

## Here are the confidence intervals for the parameters of the best-fitting model, based on the parametric bootstrap
c("Dataset", "alpha", "sigma.sq", "Acanthocephalans", "Nematodes", "Platyhelminthes",
  "Nearctic",
  paste0(signif(nearctic_oum_ouch@sqrt.alpha^2,3), " (",
         signif(sort(fit_oum_model_to_oum_data_nearctic$alpha)[25],3), ", ",
         signif(sort(fit_oum_model_to_oum_data_nearctic$alpha)[975],3), ")"), 
  paste0(signif(nearctic_oum_ouch@sigma^2,3), " (",
         signif(sort(fit_oum_model_to_oum_data_nearctic$sigma.sq)[25],3), ", ",
         signif(sort(fit_oum_model_to_oum_data_nearctic$sigma.sq)[975],3), ")"), 
  paste0(signif(nearctic_oum_ouch@theta$nearctic_parasite_ouchdata[1],3) %>% unname, " (",
         signif(sort(fit_oum_model_to_oum_data_nearctic$Acanths)[25],3), ", ",
         signif(sort(fit_oum_model_to_oum_data_nearctic$Acanths)[975],3), ")"),
  paste0(signif(nearctic_oum_ouch@theta$nearctic_parasite_ouchdata[2],3) %>% unname, " (",
         signif(sort(fit_oum_model_to_oum_data_nearctic$Nematodes)[25],3), ", ",
         signif(sort(fit_oum_model_to_oum_data_nearctic$Nematodes)[975],3), ")"),
  paste0(signif(nearctic_oum_ouch@theta$nearctic_parasite_ouchdata[3],3) %>% unname, " (",
         signif(sort(fit_oum_model_to_oum_data_nearctic$Platys)[25],3), ", ",
         signif(sort(fit_oum_model_to_oum_data_nearctic$Platys)[975],3), ")"),
  "GMPD",
  paste0(signif(gmpd_oum_ouch@sqrt.alpha^2,3), " (",
         signif(sort(fit_oum_model_to_oum_data_gmpd$alpha)[25],3), ", ",
         signif(sort(fit_oum_model_to_oum_data_gmpd$alpha)[975],3), ")"), 
  paste0(signif(gmpd_oum_ouch@sigma^2,3), " (",
         signif(sort(fit_oum_model_to_oum_data_gmpd$sigma.sq)[25],3), ", ",
         signif(sort(fit_oum_model_to_oum_data_gmpd$sigma.sq)[975],3), ")"), 
  paste0(signif(gmpd_oum_ouch@theta$gmpd_parasite_ouchdata[1],3) %>% unname, " (",
         signif(sort(fit_oum_model_to_oum_data_gmpd$Acanths)[25],3), ", ",
         signif(sort(fit_oum_model_to_oum_data_gmpd$Acanths)[975],3), ")"),
  paste0(signif(gmpd_oum_ouch@theta$gmpd_parasite_ouchdata[2],3) %>% unname, " (",
         signif(sort(fit_oum_model_to_oum_data_gmpd$Nematodes)[25],3), ", ",
         signif(sort(fit_oum_model_to_oum_data_gmpd$Nematodes)[975],3), ")"),
  paste0(signif(gmpd_oum_ouch@theta$gmpd_parasite_ouchdata[3],3) %>% unname, " (",
         signif(sort(fit_oum_model_to_oum_data_gmpd$Platys)[25],3), ", ",
         signif(sort(fit_oum_model_to_oum_data_gmpd$Platys)[975],3), ")")
) %>% matrix(., ncol=6, byrow=TRUE) -> parameter_estimates
parameter_estimates
```

#Adding Trait data
```{r adding_and_cleaning_host_and_parasite_trait_data, echo = TRUE}
#### Load parasite body size data from Benesh, Lafferty, and Kuris 2017 ####
## Length and width measurments are in mm 
benesh_data_para<- read_csv("Benesh_et_al_2017/ecy1680-sup-0001-datas1/CLC_database_lifehistory.csv")
benesh_data_para$Host.species <-gsub(" ", "_", benesh_data_para$Host.species)

## remove parasites from Benesh et al. dataset that don't exist in the phylogeny
setdiff(benesh_data_para$Parasite.species, gmpd_data$ParasiteCorrectedName)->nothanks
benesh_data_para[-which(benesh_data_para$Parasite.species %in% nothanks) ,] -> b_para_subset

## average the body size for rows that are the same species
subset(b_para_subset, Sex=="f") %>%
  group_by(Parasite.species) %>%
  summarise(mean_l=mean(Length, na.rm = TRUE)) ->data_fem_len

subset(b_para_subset, Sex=="f") %>%
  group_by(Parasite.species) %>%
  summarise(mean_w=mean(Width, na.rm = TRUE)) ->data_fem_wid

## combine length and width to calculate 'body size' (L*W)?
b.size<-left_join(data_fem_len, data_fem_wid, by="Parasite.species")
b.size$ratio<-(b.size$mean_l*b.size$mean_w)

write.csv(b.size, "bodysizepara.csv")

#### Trim the tree to include only those parasite species for which there is body size data ####

##nearctic mpd
setdiff(nearctic_parasite_tree$tip.label, b.size$Parasite.species)->no_body_size 
nearctic_pgls <- drop.tip(nearctic_parasite_tree, nearctic_parasite_tree$tip.label[which(nearctic_parasite_tree$tip.label%in%no_body_size)]) #33 taxa

# make sure body size is in the same order as the parasite phylogeny
nearctic_b_size <- b.size[match(nearctic_pgls$tip.label, b.size$Parasite.species),]

##gmpd mpd
setdiff(gmpd_parasite_tree$tip.label, b.size$Parasite.species)->no_body_size2 
gmpd_pgls <- drop.tip(gmpd_parasite_tree, gmpd_parasite_tree$tip.label[which(gmpd_parasite_tree$tip.label%in%no_body_size2)])

# make sure body size is in the same order as the parasite phylogeny
gmpd_b_size <- b.size[match(gmpd_pgls$tip.label, b.size$Parasite.species),]

#### adding in host trait data (mass.g) from PHYLACINE ####
#Faurby, S., Davis, M., Pedersen, R. ., Schowanek, S. D., Antonelli, A., & Svenning, J.C. (In Press). PHYLACINE 1.2: The Phylogenetic Atlas of Mammal Macroecology. Ecology
#load mammal data
Trait_data <- read_csv("Trait_data.csv")

#correct for spaces in the binomial names
Trait_data$Binomial.1.2<-gsub("_", " ", Trait_data$Binomial.1.2)

#make column called "Host" in Trait_data
Trait_data$HostCorrectedName<-Trait_data$Binomial.1.2

#merge 
left_join(gmpd_data, Trait_data, by = "HostCorrectedName")->ss
host_trait_data<-data.frame("Parasite" = ss$ParasiteCorrectedName,
                            "Host" = ss$HostCorrectedName, 
                            "Mass.g" = ss$Mass.g)

host_trait_data %>% 
  group_by(Parasite) %>% 
  summarise(avgMass=mean(Mass.g,na.rm=T)) -> Host_mass

##subset host data for each group

#nearctic 
setdiff(Host_mass$Parasite, nearctic_pgls$tip.label)-> getout
nearctic_traits<-Host_mass[-which(Host_mass$Parasite %in% getout),]
#put in tree tip label order
nearctic_traits <- nearctic_traits[match(nearctic_pgls$tip.label, nearctic_traits$Parasite),]

#gmpd 
gmpd_traits<-Host_mass
#put in tree tip label order
gmpd_traits <- gmpd_traits[match(gmpd_pgls$tip.label, gmpd_traits$Parasite),]

#### clean parasite transmission data ####

#nearctic 
nearctic_trans<-gmpd_parasite_data[which(gmpd_parasite_data$CorrectName %in% nearctic_pgls$tip.label),]
nearctic_trans<-nearctic_trans[match(nearctic_pgls$tip.label, nearctic_trans$CorrectName),]

#gmpd
gmpd_trans<-gmpd_parasite_data[which(gmpd_parasite_data$CorrectName %in% gmpd_pgls$tip.label),]
gmpd_trans<-gmpd_trans[match(gmpd_pgls$tip.label, gmpd_trans$CorrectName),]
```

#PGLS of Nearctic 
```{r pgls_nearctic, include = FALSE}
###NEARCTIC DATASET####

# prepare transmission data
nearctic_transmission<-gmpd_parasite_data[which(gmpd_parasite_data$CorrectName %in% nearctic_parasite_tree$tip.label),]
nearctic_transmission<-nearctic_transmission[match(nearctic_parasite_tree$tip.label, nearctic_transmission$CorrectName),]

#make dataframe
dat<-data.frame(taxa=nearctic_parasite_tree$tip.label,
                para.mpd= nearctic_para_pubs$mpd,
                res = gls_host_pubs_mpd_nearctic$residuals, #residuals of mpd
                para_pubs=log(nearctic_para_pubs$pubs),
                host_pubs=log(nearctic_para_pubs$hostPubSum),
                close=as.factor(nearctic_transmission$close),
                env=as.factor(nearctic_transmission$nonclose),
                intermediate=as.factor(nearctic_transmission$intermediate))

nearctic_parasite_tree$node.label<-NULL
cdat<-comparative.data(data=dat, phy=nearctic_parasite_tree, names.col = "taxa")

summary(pgls(res ~  close + env + intermediate, cdat, lambda = "ML")) #Intermediate ***
anova(pgls(res ~  close + env + intermediate, cdat, lambda = "ML"))

#### Dataset that includes parasite traits (length), subsets to 33 species ####

#create pgls data from nearctic_para_mpd
nearctic_dat<-dat[match(nearctic_pgls$tip.label, dat$taxa),]

#create pgls dataset 
nearctic_dat$para.l=nearctic_b_size$mean_l#parasite length
nearctic_dat$para.w=nearctic_b_size$mean_w                #parasite width
nearctic_dat$para.b=nearctic_b_size$ratio                 #parasite l/w ratio
nearctic_dat$host_mass=nearctic_traits$avgMass

## constructs the data.frame of the taxa names and data in the order of the tree tips
nearctic_pgls$node.label<-NULL
nearctic_cdat<-comparative.data(data=nearctic_dat, phy=nearctic_pgls, names.col = "taxa")

## model testing ##

#all predictors
nearctic_mod <- pgls(res ~ close + env + intermediate + para.b + host_mass, nearctic_cdat, lambda = "ML")
summary(nearctic_mod)
anova(nearctic_mod) #environmental barely
```

#PGLS of GMPD
```{r pgls_gmpd, include=FALSE}
# prepare transmission data
gmpd_transmission<-gmpd_parasite_data[which(gmpd_parasite_data$CorrectName %in% gmpd_parasite_tree$tip.label),]
gmpd_transmission<-gmpd_transmission[match(gmpd_parasite_tree$tip.label, gmpd_transmission$CorrectName),]

#make dataframe
gmpd_dat<-data.frame(taxa=gmpd_parasite_tree$tip.label,
                para.mpd= gmpd_para_pubs$mpd,
                res = gls_host_pubs_mpd_gmpd$residuals,              
                para.pubs=log(gmpd_para_pubs$pubs), 
                host.pubs=log(gmpd_para_pubs$hostPubSum),
                close=as.factor(gmpd_transmission$close),
                env=as.factor(gmpd_transmission$nonclose),
                intermediate=as.factor(gmpd_transmission$intermediate))

gmpd_cdat<-comparative.data(data=gmpd_dat, phy=gmpd_parasite_tree, names.col = "taxa")

summary(pgls(res ~  close + env + intermediate, gmpd_cdat, lambda = "ML")) #Environmental *** and Intermediate**
anova(pgls(res ~ close + env + intermediate, gmpd_cdat, lambda = "ML"))  

#### Dataset that includes parasite and host traits , species ####

#create pgls data from gmpd_para_mpd
gmpd_trait_dat<-gmpd_dat[match(gmpd_pgls$tip.label, gmpd_dat$taxa),]

gmpd_trait_dat$para.l=gmpd_b_size$mean_l
gmpd_trait_dat$para.w=gmpd_b_size$mean_w
gmpd_trait_dat$para.b=gmpd_b_size$ratio
gmpd_trait_dat$host_mass=gmpd_traits$avgMass

## constructs the data.frame of the taxa names and data in the order of the tree tips
gmpd_trait_cdat<-comparative.data(data=gmpd_trait_dat, phy=gmpd_pgls, names.col = "taxa")

## model testing ##
#all predictors
summary(pgls(res ~ close + env + intermediate + para.b + host_mass, gmpd_trait_cdat, lambda = "ML"))
anova(pgls(res ~ close + env + intermediate + para.b + host_mass, gmpd_trait_cdat, lambda = "ML"))
```