---
title: "Supplementary File"
author: "APB"
date: "1/8/2021"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ape)
library(plyr)
library(tidyverse)
library(ouch)
library(dplyr)
library(phytools)
library(geiger)
library(caper)
library(picante)
library(pmc)
library(corHMM)
library(OUwie)
library(ggrepel)
library(patchwork)
```



**Supplmental Figure 1.** 249 taxa helminth molecular phylogeny

```{r load_in_APBs_helminth_tree, echo=FALSE}
##load data
gmpd_data<-readRDS("GMPD_data.RDS")
nearctic_data<-readRDS("Nearctic_data.RDS")
## load trees
gmpd_parasite_tree <- readRDS("GMPD_parasite_tree.RDS")
nearctic_parasite_tree <- readRDS("Nearctic_parasite_tree.RDS")
nearctic_mammal_tree <- readRDS("Nearctic_mammal_tree.RDS")
gmpd_mammal_tree <- readRDS("GMPD_mammal_tree.RDS")

plotTree(gmpd_parasite_tree, fsize =0.3, type = "fan")
```







\newpage
**Supplemental Figure 2.** The likelihood ratio distributions for BM versus OU(3). 
```{r plot_bm_vs_oum, fig.height=3, fig.width=6, units='in', res=300, echo = FALSE}
#load data
gmpd_bm_ouch <- readRDS("gmpd_bm_ouch")
gmpd_ou1_ouch <- readRDS("gmpd_ou1_ouch")
gmpd_oum_ouch <-readRDS("gmpd_oum_ouch")
nearctic_ou1_ouch <- readRDS("nearctic_ou1_ouch")
nearctic_bm_ouch <- readRDS("nearctic_bm_ouch")
nearctic_oum_ouch <-readRDS("nearctic_oum_ouch")

#bootstraps
fit_oum_model_to_oum_data_nearctic <- readRDS(file="bootstrap_results/fit_oum_model_to_oum_data_nearctic.RDS")
fit_oum_model_to_ou1_data_nearctic <- readRDS(file="bootstrap_results/fit_oum_model_to_ou1_data_nearctic.RDS")
fit_oum_model_to_bm_data_nearctic <- readRDS(file="bootstrap_results/fit_oum_model_to_bm_data_nearctic.RDS")
fit_ou1_model_to_oum_data_nearctic <- readRDS(file="bootstrap_results/fit_ou1_model_to_oum_data_nearctic.RDS")
fit_ou1_model_to_ou1_data_nearctic <- readRDS(file="bootstrap_results/fit_ou1_model_to_ou1_data_nearctic.RDS")
fit_bm_model_to_oum_data_nearctic <- readRDS(file="bootstrap_results/fit_bm_model_to_oum_data_nearctic.RDS")
fit_bm_model_to_bm_data_nearctic <- readRDS(file="bootstrap_results/fit_bm_model_to_bm_data_nearctic.RDS")


fit_oum_model_to_oum_data_gmpd <- readRDS(file="bootstrap_results/fit_oum_model_to_oum_data_gmpd.RDS")
fit_oum_model_to_ou1_data_gmpd <- readRDS(file="bootstrap_results/fit_oum_model_to_ou1_data_gmpd.RDS")
fit_oum_model_to_bm_data_gmpd <- readRDS(file="bootstrap_results/fit_oum_model_to_bm_data_gmpd.RDS")
fit_ou1_model_to_oum_data_gmpd <- readRDS(file="bootstrap_results/fit_ou1_model_to_oum_data_gmpd.RDS")
fit_ou1_model_to_ou1_data_gmpd <- readRDS(file="bootstrap_results/fit_ou1_model_to_ou1_data_gmpd.RDS")
fit_bm_model_to_oum_data_gmpd <- readRDS(file="bootstrap_results/fit_bm_model_to_oum_data_gmpd.RDS")
fit_bm_model_to_bm_data_gmpd <- readRDS(file="bootstrap_results/fit_bm_model_to_bm_data_gmpd.RDS")

## Plot the distributions of likelihood differences between BM and OUM for the different datasets
par(mar=c(3,3,2,1), oma=rep(0,4), mfrow=c(1,2))
## GMPD
delta <- -2*(gmpd_bm_ouch@loglik - gmpd_oum_ouch@loglik)
delta.dist <- -2*(fit_bm_model_to_bm_data_gmpd$logLik - fit_oum_model_to_bm_data_gmpd$logLik)
delta.dist.2 <- -2*(fit_bm_model_to_oum_data_gmpd$logLik - fit_oum_model_to_oum_data_gmpd$logLik)
d1 <- density(delta.dist)
d2 <- density(delta.dist.2)
plot.new()
plot.window(xlim=range(c(d1$x,d2$x)), ylim=range(c(d1$y,d2$y)))
axis(1);axis(2);box('plot')
mtext(side=1, line=2, expression(delta))
mtext(side=2, line=2, 'Density')
mtext(side=3, line=0.25, "GMPD")
lines(d1$x, d1$y, col=gray(0.7))
with(d1, polygon(x=c(min(x), x[x<max(x)], rev(x[x<max(x)]), min(x)), y=c(0, 0*x[x<max(x)], rev(y[x<max(x)]), 0), col=gray(0.7, alpha=0.5)))
lines(d2$x, d2$y, col=gray(0.2))
with(d2, polygon(x=c(min(x), x[x<max(x)], rev(x[x<max(x)]), min(x)), y=c(0, 0*x[x<max(x)], rev(y[x<max(x)]), 0), col=gray(0.2, alpha=0.5)))
abline(v=delta, lwd=2, lty=2)
legend(x='topright', c('BM','OU3'), fill=c(gray(0.7),gray(0.2)), bty='n', cex=0.75)

delta <- -2*(nearctic_bm_ouch@loglik - nearctic_oum_ouch@loglik)
delta.dist <- -2*(fit_bm_model_to_bm_data_nearctic$logLik - fit_oum_model_to_bm_data_nearctic$logLik)
delta.dist.2 <- -2*(fit_bm_model_to_oum_data_nearctic$logLik - fit_oum_model_to_oum_data_nearctic$logLik)
d1 <- density(delta.dist)
d2 <- density(delta.dist.2)
plot.new()
plot.window(xlim=range(c(d1$x,d2$x)), ylim=range(c(d1$y,d2$y)))
axis(1);axis(2);box('plot')
mtext(side=1, line=2, expression(delta))
mtext(side=2, line=2, 'Density')
mtext(side=3, line=0.25, "Nearctic")
lines(d1$x, d1$y, col=gray(0.7))
with(d1, polygon(x=c(min(x), x[x<max(x)], rev(x[x<max(x)]), min(x)), y=c(0, 0*x[x<max(x)], rev(y[x<max(x)]), 0), col=gray(0.7, alpha=0.5)))
lines(d2$x, d2$y, col=gray(0.2))
with(d2, polygon(x=c(min(x), x[x<max(x)], rev(x[x<max(x)]), min(x)), y=c(0, 0*x[x<max(x)], rev(y[x<max(x)]), 0), col=gray(0.2, alpha=0.5)))
abline(v=delta, lwd=2, lty=2)
```


\newpage
**Supplemental Figure 3.** The likelihood ratio distributions for OU(1) versus OU(3). 
```{r plot_ou1_vs_oum, fig.height=3, fig.width=6, units='in', res=300, echo = FALSE}

## Plot the distributions of likelihood differences between ou1 and OUM for the four different datasets
par(mar=c(3,3,2,1), oma=rep(0,4), mfrow=c(1,2))
## GMPD
delta <- -2*(gmpd_ou1_ouch@loglik - gmpd_oum_ouch@loglik)
delta.dist <- -2*(fit_ou1_model_to_ou1_data_gmpd$logLik - fit_oum_model_to_ou1_data_gmpd$logLik)
delta.dist.2 <- -2*(fit_ou1_model_to_oum_data_gmpd$logLik - fit_oum_model_to_oum_data_gmpd$logLik)
d1 <- density(delta.dist)
d2 <- density(delta.dist.2)
plot.new()
plot.window(xlim=range(c(d1$x,d2$x)), ylim=range(c(d1$y,d2$y)))
axis(1);axis(2);box('plot')
mtext(side=1, line=2, expression(delta))
mtext(side=2, line=2, 'Density')
mtext(side=3, line=0.25, "GMPD")
lines(d1$x, d1$y, col=gray(0.7))
with(d1, polygon(x=c(min(x), x[x<max(x)], rev(x[x<max(x)]), min(x)), y=c(0, 0*x[x<max(x)], rev(y[x<max(x)]), 0), col=gray(0.7, alpha=0.5)))
lines(d2$x, d2$y, col=gray(0.2))
with(d2, polygon(x=c(min(x), x[x<max(x)], rev(x[x<max(x)]), min(x)), y=c(0, 0*x[x<max(x)], rev(y[x<max(x)]), 0), col=gray(0.2, alpha=0.5)))
abline(v=delta, lwd=2, lty=2)
legend(x='topright', c('OU1','OU3'), fill=c(gray(0.7),gray(0.2)), bty='n', cex=0.75)

delta <- -2*(nearctic_ou1_ouch@loglik - nearctic_oum_ouch@loglik)
delta.dist <- -2*(fit_ou1_model_to_ou1_data_nearctic$logLik - fit_oum_model_to_ou1_data_nearctic$logLik)
delta.dist.2 <- -2*(fit_ou1_model_to_oum_data_nearctic$logLik - fit_oum_model_to_oum_data_nearctic$logLik)
d1 <- density(delta.dist)
d2 <- density(delta.dist.2)
plot.new()
plot.window(xlim=range(c(d1$x,d2$x)), ylim=range(c(d1$y,d2$y)))
axis(1);axis(2);box('plot')
mtext(side=1, line=2, expression(delta))
mtext(side=2, line=2, 'Density')
mtext(side=3, line=0.25, "Nearctic")
lines(d1$x, d1$y, col=gray(0.7))
with(d1, polygon(x=c(min(x), x[x<max(x)], rev(x[x<max(x)]), min(x)), y=c(0, 0*x[x<max(x)], rev(y[x<max(x)]), 0), col=gray(0.7, alpha=0.5)))
lines(d2$x, d2$y, col=gray(0.2))
with(d2, polygon(x=c(min(x), x[x<max(x)], rev(x[x<max(x)]), min(x)), y=c(0, 0*x[x<max(x)], rev(y[x<max(x)]), 0), col=gray(0.2, alpha=0.5)))
abline(v=delta, lwd=2, lty=2)
```


















\newpage
**Supplemental Table 1.** Summary table for evolutionary models of MPD in the Nearctic dataset
```{r echo = FALSE}
tibble(model=c("BM","OU1","OU3"),
       aicc=c(summary(nearctic_bm_ouch)$aic.c, 
              summary(nearctic_ou1_ouch)$aic.c,
              summary(nearctic_oum_ouch)$aic.c)
       ) %>% 
  mutate(deltaaicc=aicc-min(aicc), 
         pow=exp(-.5*deltaaicc),
         sumpow=sum(pow),
         waicc=pow/sumpow) %>%
  dplyr::select(c(1,2,3,6)) %>%
  arrange(desc(waicc)) -> nearctic_aic_OU
nearctic_aic_OU
```


**Supplemental Table 2.** Summary table for evolutionary models of MPD in the GMPD 
```{r echo = FALSE}
##with single host species MPD = 0
tibble(model=c("BM","OU1","OU3"),
       aicc=c(summary(gmpd_bm_ouch)$aic.c, 
              summary(gmpd_ou1_ouch)$aic.c,
              summary(gmpd_oum_ouch)$aic.c)
       ) %>% 
  mutate(deltaaicc=aicc-min(aicc), 
         pow=exp(-.5*deltaaicc),
         sumpow=sum(pow),
         waicc=pow/sumpow) %>%
  dplyr::select(c(1,2,3,6)) %>%
  arrange(desc(waicc)) -> gmpd_aic_OU
gmpd_aic_OU
```



```{r zoonoses_figure, include=FALSE}
#run 
#interspecific distance matrix of parasites
nearctic_dis_para<-cophenetic.phylo(nearctic_parasite_tree) 

#interspecific distance matrix of mammals 
nearctic_dis_mam<-cophenetic.phylo(nearctic_mammal_tree) 

## Create an association matrix with host across the columns and parasites across the rows
nearctic_mamlist<-as.vector(nearctic_mammal_tree$tip.label) #list of mammals in tip label order
nearctic_para_list<-as.vector(nearctic_parasite_tree$tip.label) #list of parasites

#make a dataframe with host names as columns and parasite names as rows
nearctic_df <- data.frame(matrix(ncol=length(nearctic_mamlist),nrow=length(nearctic_para_list)), row.names = nearctic_para_list)
colnames(nearctic_df)<-nearctic_mamlist

# complete dataframe with association data, 
# where 0 = not found in host and 1 = found in host
for (i in 1:nrow(nearctic_df))
  nearctic_df[i,] <- (colnames(nearctic_df) %in% unique(subset(nearctic_data, Parasite==rownames(nearctic_df)[i])$Host)) %>% as.numeric

#save matrix
write.csv(nearctic_df,file = "association_matrix_nearctic.csv", row.names = TRUE, col.names = TRUE)

## Create MPD scores for every parasite where single host parasites have a mpd = 0 (90taxa)
nearctic_para_mpd <- mpd(nearctic_df, nearctic_dis_mam)
nearctic_para_mpd[is.na(nearctic_para_mpd)] <- 0 ## one host species have an MPD of 0
names(nearctic_para_mpd)<-nearctic_para_list

## Create MPD scores for every host where hosts infected by only one parasite have a mpd = 0 (69 taxa)
nearctic_mam_mpd <- mpd(t(nearctic_df), nearctic_dis_para)
nearctic_mam_mpd[is.na(nearctic_mam_mpd)] <- 0 ## hosts infected by only one parasite have MPD of 0
names(nearctic_mam_mpd)<-nearctic_mamlist


##calculate the mpd of parasites and hosts!
gmpd_dis_para<-cophenetic.phylo(gmpd_parasite_tree) #interspecific distance matrix of parasites
gmpd_dis_mam<-cophenetic.phylo(gmpd_mammal_tree) #intespecific distance matrix of mammals from small tree

##make the pipeline to get the absence presence of each parasite (rows) that infect a given host (column)
gmpd_mamlist<-as.vector(gmpd_mammal_tree$tip.label) #list of mammals in tip label order
gmpd_para_list<-as.vector(gmpd_parasite_tree$tip.label)
gmpd_df <- data.frame(matrix(ncol=length(gmpd_mamlist),nrow=length(gmpd_para_list)), row.names = gmpd_para_list)
colnames(gmpd_df)<-gmpd_mamlist

for (i in 1:nrow(gmpd_df))
  gmpd_df[i,] <- (colnames(gmpd_df) %in% unique(subset(gmpd_data, ParasiteCorrectedName==rownames(gmpd_df)[i])$HostCorrectedName)) %>% as.numeric

write.csv(gmpd_df,file = "gmpd_df.csv", row.names = TRUE, col.names = TRUE)

## Create MPD scores for every parasite where single host parasites have a mpd = 0 (250 taxa)
gmpd_para_mpd <- mpd(gmpd_df, gmpd_dis_mam)
gmpd_para_mpd[is.na(gmpd_para_mpd)] <- 0 ## one host parasites have an mpd of 0
names(gmpd_para_mpd)<-gmpd_para_list

## Create MPD scores for every host where hosts infected by only one parasite have a mpd = 0 (199 taxa)
gmpd_mam_mpd <- mpd(t(gmpd_df), gmpd_dis_para)
gmpd_mam_mpd[is.na(gmpd_mam_mpd)] <- 0 ## hosts infected by only one parasite have MPD of 0
names(gmpd_mam_mpd)<-gmpd_mamlist
```

```{r mammal_tree_with_host_mpd, include = FALSE}
#### NEARCTIC DATASET ####
#single parasite species have mpd = 0
contMap(nearctic_mammal_tree, nearctic_mam_mpd, fsize=0.3, lwd =1)

#### GLOBAL DATASET ####
#single parasite species have mpd = 0
contMap(gmpd_mammal_tree, gmpd_mam_mpd, fsize=0.3, lwd =1, type ="fan")
```

**Supplemental Figure 4.** Mean pairwise phylogenetic distance (MPD) of helminths infecting each mammal compared to their phylogenetic distance to humans in the GMPD and Nearctic dataset. *Didelphis virginiana* and *Didelphis marsupialis* are most distantly related to humans (PD = 380), thus were excluded from the figure.
```{r, include = FALSE}
#### GMPD ####
# Calculate pairwise distance (PD) of each mammal to homo sapiens

#subset PHYLACINE mammal tree to include GMPD mammals
n<-gmpd_data[which(gmpd_data$HostCorrectedName %in% gmpd_mammal_tree$tip.label),]
mammal_names<-unique(n$HostCorrectedName)
mammal_names<-c(mammal_names, "Homo sapiens")

#add full mammal tree to include humans
full_mammal_tree<-read.nexus("mammal_phylo_consensus.nex")
full_mammal_tree$tip.label<-gsub("_", " ", full_mammal_tree$tip.label)

#subset the tree
mammal_tree<-drop.tip(full_mammal_tree, full_mammal_tree$tip.label[which(!(full_mammal_tree$tip.label %in% mammal_names))])

#calculate the pairwise distances
mam_dis<-cophenetic.phylo(mammal_tree)

#pull out the PD for each mammal to humans
mam_dis2 = as.data.frame(mam_dis)
distances<-mam_dis2[,"Homo sapiens"]
names(distances)<-rownames(mam_dis2)
#view(distances)

#remove humans from distances
distance2<-distances[names(distances) != "Homo sapiens"]

#make a dataframe for the figure 
figure_data<-data.frame("name"= names(gmpd_mam_mpd), "global.mpd" = gmpd_mam_mpd, "distance"= distance2)

#species we want labeled in the figure
important.names<-c("Procyon lotor",
                   "Urocyon cinereoargenteus")

#make dataset for the to-be-labeled points
smaller_data<- figure_data[figure_data$name %in% important.names,]

#load package to label figure datapoints

summary_data <- figure_data %>% 
  mutate(xy = paste0(global.mpd, "_", distance)) %>% group_by(xy) %>% 
  dplyr::summarize(count = n()) %>%
  separate(xy, into = c("global.mpd", "distance"), "_")

summary_data$global.mpd <- as.numeric(summary_data$global.mpd)
summary_data$distance <- as.numeric(summary_data$distance)


new_fig_data <- merge(summary_data, figure_data, by = c("global.mpd", "distance"), all.y = TRUE)
                                       

MAM_FIG<-ggplot()+
  geom_point(new_fig_data, mapping=aes(x=global.mpd, y= distance, size = count))+
  geom_text_repel(smaller_data, mapping=aes(x=global.mpd, y=distance, label = name),
                  size=2,
                  vjust = 0,
                  point.padding = .7)+
  labs(title= "GMPD", y= "PD to Humans", x = "MPD")+
  scale_y_continuous(limits = c(0,210))+
  theme_bw()+
  theme(legend.position = "none",
        panel.grid = element_blank(),
        plot.title = element_text(hjust = 0.5))


#### NEARCTIC DATASET ####
#Calulate pairwise distance (PD) of each mammal to homo sapiens

#subset PHYLACINE mammal tree to include GMPD mammals
setdiff(full_mammal_tree$tip.label, colnames(nearctic_df))->group4

#add back the the humans
group5 <- group4[group4 != "Homo sapiens"]

#subset the tree
nearctic_mammal_tree<-drop.tip(full_mammal_tree, full_mammal_tree$tip.label[which(full_mammal_tree$tip.label%in%group5)])

#calculate the pairwise distances
nearctic_mam_dis<-cophenetic.phylo(nearctic_mammal_tree)

#pull out the PD for each mammal to humans
nearctic_mam_dis2 = as.data.frame(nearctic_mam_dis)
nearctic_distances<-nearctic_mam_dis2[,"Homo sapiens"]
names(nearctic_distances)<-rownames(nearctic_mam_dis2)
#view(nearctic_distances)

#remove humans from distances
distance3<-nearctic_distances[names(nearctic_distances) != "Homo sapiens"]

#make a dataframe for the figure 
figure_data_2<-data.frame("name"= names(nearctic_mam_mpd), "nearctic.mpd" = nearctic_mam_mpd, "distance"= distance3)

#species we want labeled in the figure
nearctic.important.names<-c(#"Didelphis virginiana", 
                            "Procyon lotor",
                            #"Didelphis marsupialis", 
                            #"Ursus americanus",
                            "Urocyon cinereoargenteus")

#make dataset for the to-be-labeled points
nearctic_smaller_data<- figure_data_2[figure_data_2$name %in% nearctic.important.names,]

nearctic_summary_data <- figure_data_2 %>% 
  mutate(xy = paste0(nearctic.mpd, "_", distance)) %>% group_by(xy) %>% 
  dplyr::summarize(count = n()) %>%
  separate(xy, into = c("nearctic.mpd", "distance"), "_")

nearctic_summary_data$nearctic.mpd <- as.numeric(nearctic_summary_data$nearctic.mpd)
nearctic_summary_data$distance <- as.numeric(nearctic_summary_data$distance)

nearctic_fig_data <- merge(nearctic_summary_data, figure_data_2, by = c("nearctic.mpd", "distance"), all.y = TRUE)
                                       
NEARCTIC_MAM<-ggplot()+
  geom_point(nearctic_summary_data, mapping=aes(x=nearctic.mpd, y= distance, size = count))+
  geom_text_repel(nearctic_smaller_data, mapping=aes(x=nearctic.mpd, y=distance, label = name),
                  size=2,
                  vjust = .4,
                  point.padding = .05)+
  labs(title = "Nearctic", y= "PD to Humans", x = "MPD")+
  scale_y_continuous(limits = c(0,210))+
  theme_bw()+
  theme(legend.position = "none", 
        panel.grid = element_blank(),
        plot.title = element_text(hjust = 0.5))


################################
#### ADD THE PLOTS TOGETHER ####
################################
```

```{r, echo = FALSE, warning=FALSE}
MAM_FIG + NEARCTIC_MAM 
```


```{r descriptive_mammal_results, include = FALSE}
#####GMPD#####

#How many host are only infected by one helminth?
figure_data #197 species
single<-subset(figure_data, figure_data$global.mpd == 0)
single #75 species

75/197

## Nearctic ##

#How many host are only infected by one helminth?
figure_data_2 #67 species
single_2<-subset(figure_data_2, figure_data_2$nearctic.mpd == 0)
single_2 #75 species

19/67
```


```{r specify_helminths_in_the_high_risk_mammals, include = FALSE}
####What helminths infect the "high-risk" data point?####
gmpd_df %>%
  as.data.frame ->help

#Saguinus mystax infected by two
help$'Saguinus mystax' == 1 #27 and 210 
help[27,]  #Dipetalonema graciliformis (mpd == 18.14)
help[210,] #Hymenolepis diminuta (mpd == 96.2)

#Macaca fascicularis infected by four
help$'Macaca fascicularis' == 1 #86, 136, 164, 200
help[86,]  #Oesophagostomum aculeatum
help[136,] #Strongyloides fuelleborni
help[164,] #Trichuris trichiura (mpd == 37.97)
help[200,] #Paragonimus westermani

#Macaca cyclopis infected by two
help$'Macaca cyclopis' == 1
help[50,]  #Enterobius macaci (mpd == 3.61)
help[200,] #Paragonimus westermani

#Alouatta seniculus infected by two
help$'Alouatta seniculus' == 1  #55, 164
help[55,]  #Trypanoxyuris minutus (mpd == 18.79)
help[164,] #Trichuris trichiura (mpd == 37.97)

#Papio hamadryas
help$'Papio hamadryas' == 1 #51, 211
help[51,] #Enterobius vermicularis
help[211,] #Hymenolepis nana (mpd == 0)
```
